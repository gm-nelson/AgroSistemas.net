<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asesoría Técnica - Agrosistemas</title>
    <link rel="icon" type="image/webp" href="favicon.webp">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Leaflet CSS (OpenStreetMap) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    <!-- Leaflet Draw CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>
    <style>
        /* Reset y estilos base */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }
        
        body {
            color: #333;
            line-height: 1.6;
            background-color: #FFFFFF;
        }
        
        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        a {
            text-decoration: none;
            color: inherit;
        }
        
        ul {
            list-style: none;
        }
        
        .btn {
            display: inline-block;
            background-color: #00a553;
            color: white;
            padding: 14px 32px;
            border-radius: 50px;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            letter-spacing: 0.5px;
        }
        
        .btn:hover {
            background-color: #008a45;
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 165, 83, 0.3);
        }
        
        .btn-secondary {
            background-color: #1772af;
        }
        
        .btn-secondary:hover {
            background-color: #145c92;
            box-shadow: 0 8px 20px rgba(23, 114, 175, 0.3);
        }
        
        .section-title {
            text-align: center;
            margin-bottom: 50px;
            color: #111;
            font-size: 2.4rem;
            font-weight: 700;
        }
        
        /* Header */
        header {
            background-color: #FFFFFF;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 1000;
            transition: all 0.3s ease;
        }
        
        header.scrolled {
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.08);
        }
        
        .main-header {
            padding: 20px 0;
        }
        
        .main-header .container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            height: 100px;
            display: flex;
            align-items: center;
        }
        
        .logo img {
            height: 100px;
            width: auto;
        }
        
        .mobile-menu-btn {
            display: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #111;
            background: none;
            border: none;
            padding: 5px;
        }
        
        /* Hero Section - Específico para Asesoría Técnica */
        .page-hero {
            background: linear-gradient(135deg, rgba(0, 165, 83, 0.9) 0%, rgba(23, 114, 175, 0.9) 100%);
            color: white;
            padding: 160px 0 80px;
            text-align: center;
            margin-top: 80px;
        }
        
        .page-hero h1 {
            font-size: 3.5rem;
            margin-bottom: 20px;
            font-weight: 700;
            line-height: 1.1;
        }
        
        .page-hero p {
            font-size: 1.3rem;
            max-width: 800px;
            margin: 0 auto 40px;
            opacity: 0.9;
        }
        
        /* Servicios Detallados */
        .servicios-detalle {
            padding: 100px 0;
            background-color: #FFFFFF;
        }
        
        .servicios-grid-detalle {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 40px;
        }
        
        .servicio-detalle-card {
            background-color: #FFFFFF;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 5px 25px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
            border: 1px solid #f0f0f0;
            height: 100%;
        }
        
        .servicio-detalle-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.1);
            border-color: #00a553;
        }
        
        .servicio-detalle-icon {
            background-color: #f8f9fa;
            height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: #00a553;
        }
        
        .servicio-detalle-content {
            padding: 30px;
        }
        
        .servicio-detalle-content h3 {
            margin-bottom: 15px;
            color: #111;
            font-size: 1.6rem;
        }
        
        .servicio-detalle-content p {
            color: #666;
            line-height: 1.7;
            margin-bottom: 20px;
        }
        
        .servicio-beneficios {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .servicio-beneficios h4 {
            color: #1772af;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }
        
        .servicio-beneficios ul {
            list-style: disc;
            padding-left: 20px;
            color: #666;
        }
        
        .servicio-beneficios li {
            margin-bottom: 8px;
        }
        
        /* Diseñador de Riego CAD */
        .disenador-riego {
            padding: 100px 0;
            background-color: #f8f9fa;
        }
        
        .disenador-intro {
            text-align: center;
            max-width: 800px;
            margin: 0 auto 40px;
            color: #666;
            font-size: 1.1rem;
        }
        
        .disenador-grid {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 30px;
            height: 700px;
        }
        
        @media (max-width: 992px) {
            .disenador-grid {
                grid-template-columns: 1fr;
                height: auto;
            }
        }
        
        /* Panel del Mapa */
        .mapa-panel {
            background-color: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        .mapa-header {
            padding: 20px;
            background-color: #1772af;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .mapa-header h3 {
            font-size: 1.3rem;
            margin: 0;
        }
        
        .mapa-container {
            flex: 1;
            position: relative;
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        .mapa-controls {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1000;
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.1);
            width: 300px;
        }
        
        .search-container {
            margin-bottom: 15px;
        }
        
        #location-search {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        .mapa-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .mapa-btn {
            background-color: #00a553;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            flex: 1;
            min-width: 120px;
        }
        
        .mapa-btn:hover {
            background-color: #008a45;
        }
        
        .mapa-btn.secondary {
            background-color: #1772af;
        }
        
        .mapa-btn.secondary:hover {
            background-color: #145c92;
        }
        
        .area-display {
            background-color: rgba(0,0,0,0.7);
            color: white;
            padding: 10px 15px;
            border-radius: 4px;
            margin-top: 10px;
            font-size: 0.9rem;
        }
        
        /* Panel de Diseño CAD */
        .cad-panel {
            background-color: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        .cad-header {
            padding: 20px;
            background-color: #00a553;
            color: white;
        }
        
        .cad-header h3 {
            font-size: 1.3rem;
            margin: 0 0 10px 0;
        }
        
        .cad-header p {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .cad-tabs {
            display: flex;
            background-color: #f0f0f0;
            border-bottom: 1px solid #ddd;
        }
        
        .cad-tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
        }
        
        .cad-tab.active {
            background-color: white;
            color: #00a553;
            border-bottom: 3px solid #00a553;
        }
        
        .cad-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        .cad-tab-content {
            display: none;
        }
        
        .cad-tab-content.active {
            display: block;
        }
        
        .cad-controls {
            margin-bottom: 20px;
        }
        
        .control-group {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .control-group h4 {
            margin-bottom: 10px;
            color: #333;
            font-size: 1.1rem;
        }
        
        .control-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .control-label {
            width: 120px;
            font-size: 0.9rem;
            color: #666;
        }
        
        select, input[type="number"] {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        .color-indicator {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 10px;
        }
        
        /* Colores para tipos de tubería */
        .color-principal {
            background-color: #ff6b6b;
        }
        
        .color-secundaria {
            background-color: #4ecdc4;
        }
        
        .color-regante {
            background-color: #45b7d1;
        }
        
        .elementos-lista {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        
        .elemento-btn {
            background-color: #f0f0f0;
            border: 1px solid #ddd;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s;
        }
        
        .elemento-btn:hover {
            background-color: #e0e0e0;
        }
        
        .elemento-btn.active {
            background-color: #00a553;
            color: white;
            border-color: #00a553;
        }
        
        .cad-resumen {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .cad-resumen h4 {
            margin-bottom: 10px;
            color: #1772af;
        }
        
        .resumen-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }
        
        .secciones-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .seccion-item {
            background-color: #f0f0f0;
            padding: 10px;
            border-radius: 4px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .seccion-item:hover {
            background-color: #e0e0e0;
        }
        
        .seccion-item.active {
            background-color: #00a553;
            color: white;
        }
        
        .seccion-config {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }
        
        /* Panel de Emisores */
        .emisor-panel {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .emisor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .emisor-header h4 {
            color: #333;
            margin: 0;
        }
        
        .emisor-info {
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
            border: 1px solid #eee;
        }
        
        /* Contacto */
        .contacto {
            padding: 100px 0;
            background-color: #FFFFFF;
        }
        
        .contacto-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 50px;
        }
        
        .contact-info-card {
            background-color: #FFFFFF;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.05);
            border: 1px solid #f0f0f0;
        }
        
        .contact-info-card h3 {
            margin-bottom: 30px;
            color: #111;
            font-size: 1.8rem;
        }
        
        .contact-item {
            display: flex;
            align-items: center;
            margin-bottom: 25px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .contact-item:hover {
            background-color: #e8f4fd;
            transform: translateX(5px);
        }
        
        .contact-icon {
            background-color: #1772af;
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            flex-shrink: 0;
            font-size: 1.2rem;
        }
        
        .contact-text h4 {
            margin-bottom: 5px;
            color: #111;
            font-size: 1.1rem;
        }
        
        .contact-text a {
            color: #1772af;
            transition: color 0.3s;
            font-weight: 500;
        }
        
        .contact-text a:hover {
            color: #00a553;
        }
        
        .contact-text p {
            color: #666;
            font-size: 0.95rem;
        }
        
        .map-container {
            height: 400px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .map-container iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        
        /* Footer */
        footer {
            background-color: #FFFFFF;
            color: #333;
            padding: 60px 0 30px;
            text-align: center;
            border-top: 1px solid #f0f0f0;
        }
        
        .footer-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 30px;
        }
        
        .footer-logo {
            margin-bottom: 10px;
        }
        
        .footer-logo img {
            height: 100px;
            width: auto;
        }
        
        .footer-text {
            color: #666;
            max-width: 600px;
            margin: 0 auto;
            line-height: 1.7;
        }
        
        .copyright {
            padding-top: 30px;
            border-top: 1px solid #f0f0f0;
            font-size: 0.9rem;
            color: #888;
            width: 100%;
            margin-top: 20px;
        }
        
        /* Responsive */
        @media (max-width: 992px) {
            .page-hero h1 {
                font-size: 2.8rem;
            }
            
            .section-title {
                font-size: 2.2rem;
            }
        }
        
        @media (max-width: 768px) {
            .mobile-menu-btn {
                display: block;
            }
            
            nav {
                position: fixed;
                top: 0;
                right: -100%;
                width: 280px;
                height: 100vh;
                background-color: #FFFFFF;
                box-shadow: -5px 0 25px rgba(0,0,0,0.1);
                transition: right 0.3s;
                z-index: 1001;
                padding: 90px 30px 30px;
            }
            
            nav.active {
                right: 0;
            }
            
            nav ul {
                flex-direction: column;
                gap: 20px;
            }
            
            nav ul li a {
                font-weight: 600;
                color: #111;
                font-size: 1.1rem;
                display: block;
                padding: 10px 0;
            }
            
            .page-hero {
                padding: 140px 0 60px;
                margin-top: 80px;
            }
            
            .page-hero h1 {
                font-size: 2.4rem;
            }
            
            .page-hero p {
                font-size: 1.1rem;
            }
            
            .section-title {
                font-size: 2rem;
                margin-bottom: 40px;
            }
            
            .servicios-detalle, .disenador-riego, .contacto {
                padding: 70px 0;
            }
            
            .contact-item {
                flex-direction: column;
                text-align: center;
            }
            
            .contact-icon {
                margin-right: 0;
                margin-bottom: 15px;
            }
        }
        
        @media (max-width: 480px) {
            .page-hero h1 {
                font-size: 2rem;
            }
            
            .page-hero p {
                font-size: 1rem;
            }
            
            .servicios-grid-detalle {
                grid-template-columns: 1fr;
            }
        }
        
        /* Estilos de navegación */
        nav ul {
            display: flex;
            gap: 35px;
        }
        
        nav ul li a {
            font-weight: 600;
            color: #111;
            padding: 8px 0;
            position: relative;
            font-size: 1rem;
            transition: color 0.3s;
        }
        
        nav ul li a:hover {
            color: #00a553;
        }
        
        nav ul li a:after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 0;
            height: 2px;
            background-color: #00a553;
            transition: width 0.3s;
        }
        
        nav ul li a:hover:after {
            width: 100%;
        }
        
        .current-page {
            color: #00a553 !important;
        }
        
        .current-page:after {
            width: 100% !important;
        }
        
        /* Scroll suave */
        html {
            scroll-behavior: smooth;
        }
        
        /* Animaciones */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .fade-in {
            opacity: 0;
            animation: fadeInUp 0.6s ease forwards;
        }
        
        .fade-in.delay-1 {
            animation-delay: 0.2s;
        }
        
        .fade-in.delay-2 {
            animation-delay: 0.4s;
        }

        /* Estilos adicionales para el sistema CAD mejorado */
        .tuberia-label {
            pointer-events: none !important;
        }

        .elemento-grafico {
            cursor: move !important;
        }

        .diseños-lista {
            max-height: 300px;
            overflow-y: auto;
        }

        .diseño-item:hover {
            background-color: #e8f4fd !important;
            border-color: #00a553 !important;
        }

        .galeria-acciones {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        .galeria-acciones .btn {
            padding: 10px 15px;
            font-size: 0.9rem;
        }

        /* Botón para importar que se vea como botón */
        .btn-secondary input[type="file"] {
            display: none;
        }

        .instrucciones-tuberia {
            background-color: #e8f4fd;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-size: 0.85rem;
            color: #1772af;
            border-left: 3px solid #1772af;
        }

        .tuberia-btn {
            background-color: #f0f0f0;
            border: 1px solid #ddd;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            transition: all 0.3s;
            width: 100%;
            justify-content: center;
            margin-top: 10px;
        }

        .tuberia-btn:hover {
            background-color: #e0e0e0;
        }

        .tuberia-btn.activo {
            background-color: #00a553;
            color: white;
            border-color: #00a553;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header id="mainHeader">
        <div class="main-header">
            <div class="container">
                <div class="logo">
                    <img src="logo.png" alt="Agrosistemas Logo">
                </div>
                <button class="mobile-menu-btn" id="mobileMenuBtn">
                    <i class="fas fa-bars"></i>
                </button>
                <nav id="mainNav">
                    <ul>
                        <li><a href="index.html">Inicio</a></li>
                        <li><a href="asesoriaTecnica.html" class="current-page">Asesoría Técnica</a></li>
                        <li><a href="sistemaDeRiego.html">Sistemas de Riego</a></li>
                        <li><a href="energiaSolar.html">Energía Solar</a></li>
                        <li><a href="equipamientoAgricola.html">Equipamiento</a></li>
                        <li><a href="#contacto">Contacto</a></li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>

    <!-- Hero Section -->
    <section class="page-hero">
        <div class="container">
            <h1 class="fade-in">Asesoría Técnica Agrícola</h1>
            <p class="fade-in delay-1">Soluciones técnicas especializadas para optimizar cada etapa de tu producción agrícola. Implementamos tecnología de punta para maximizar rendimientos y rentabilidad.</p>
            <a href="#contacto" class="btn fade-in delay-2">Solicitar Asesoría</a>
        </div>
    </section>

    <!-- Servicios Detallados -->
    <section class="servicios-detalle" id="servicios">
        <div class="container">
            <h2 class="section-title">Nuestros Servicios de Asesoría</h2>
            <div class="servicios-grid-detalle">
                <div class="servicio-detalle-card fade-in">
                    <div class="servicio-detalle-icon">
                        <i class="fas fa-map-marked-alt"></i>
                    </div>
                    <div class="servicio-detalle-content">
                        <h3>Planificación de Cultivos</h3>
                        <p>Análisis de suelos, selección de cultivos adecuados, planificación de rotaciones y diseño de layouts de siembra para maximizar el uso del espacio y recursos.</p>
                        <div class="servicio-beneficios">
                            <h4>Beneficios:</h4>
                            <ul>
                                <li>Aumento del rendimiento por hectárea</li>
                                <li>Optimización del uso del agua</li>
                                <li>Reducción de costos operativos</li>
                                <li>Mejor manejo de nutrientes</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <div class="servicio-detalle-card fade-in delay-1">
                    <div class="servicio-detalle-icon">
                        <i class="fas fa-tint"></i>
                    </div>
                    <div class="servicio-detalle-content">
                        <h3>Diseño de Sistemas de Riego</h3>
                        <p>Diseño personalizado de sistemas de riego por goteo, aspersión o microaspersión, incluyendo cálculos hidráulicos y selección de componentes óptimos.</p>
                        <div class="servicio-beneficios">
                            <h4>Beneficios:</h4>
                            <ul>
                                <li>Ahorro de agua hasta 60%</li>
                                <li>Uniformidad de riego garantizada</li>
                                <li>Reducción de mano de obra</li>
                                <li>Fertirriego automatizado</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <div class="servicio-detalle-card fade-in delay-2">
                    <div class="servicio-detalle-icon">
                        <i class="fas fa-sun"></i>
                    </div>
                    <div class="servicio-detalle-content">
                        <h3>Energía Solar para Agricultura</h3>
                        <p>Implementación de sistemas fotovoltaicos para bombeo de agua, electrificación de instalaciones y reducción de costos energéticos.</p>
                        <div class="servicio-beneficios">
                            <h4>Beneficios:</h4>
                            <ul>
                                <li>Reducción de costos energéticos</li>
                                <li>Independencia energética</li>
                                <li>Bombeo solar eficiente</li>
                                <li>Subvenciones y financiamiento</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Diseñador de Riego CAD -->
    <section class="disenador-riego" id="disenador-riego">
        <div class="container">
            <h2 class="section-title">Diseñador de Sistemas de Riego</h2>
            <p class="disenador-intro fade-in">Diseña tu sistema de riego de manera interactiva. Ubica tu predio en el mapa, delimita las secciones y configura tuberías, emisores y elementos del sistema.</p>
            
            <div class="disenador-grid">
                <!-- Panel del Mapa -->
                <div class="mapa-panel fade-in">
                    <div class="mapa-header">
                        <h3>Ubicación del Predio</h3>
                        <div class="area-display" id="areaDisplay">Área: 0 m²</div>
                    </div>
                    <div class="mapa-container">
                        <div id="map"></div>
                        <div class="mapa-controls" id="mapaControls">
                            <div class="search-container">
                                <input type="text" id="location-search" placeholder="Buscar ubicación...">
                                <button id="searchBtn" class="mapa-btn" style="margin-top: 5px; padding: 5px 10px; font-size: 0.8rem;">
                                    <i class="fas fa-search"></i> Buscar
                                </button>
                            </div>
                            <div class="mapa-buttons">
                                <button class="mapa-btn" id="drawPolygonBtn">
                                    <i class="fas fa-draw-polygon"></i> Delimitar Terreno
                                </button>
                                <button class="mapa-btn secondary" id="measureBtn">
                                    <i class="fas fa-ruler"></i> Medir
                                </button>
                                <button class="mapa-btn secondary" id="clearBtn">
                                    <i class="fas fa-trash"></i> Limpiar
                                </button>
                                <button class="mapa-btn secondary" id="hideControlsBtn" style="display: none;">
                                    <i class="fas fa-eye-slash"></i> Ocultar Controles
                                </button>
                                <button class="mapa-btn secondary" id="showControlsBtn" style="display: none;">
                                    <i class="fas fa-eye"></i> Mostrar Controles
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Panel de Diseño CAD -->
                <div class="cad-panel fade-in delay-1">
                    <div class="cad-header">
                        <h3>Diseño del Sistema de Riego</h3>
                        <p>Configura tuberías, emisores y secciones del sistema</p>
                    </div>
                    
                    <div class="cad-tabs">
                        <div class="cad-tab active" data-tab="tuberias">Tuberías</div>
                        <div class="cad-tab" data-tab="elementos">Elementos</div>
                        <div class="cad-tab" data-tab="secciones">Secciones</div>
                        <div class="cad-tab" data-tab="emisores">Emisores</div>
                        <div class="cad-tab" data-tab="galeria">Galería</div>
                    </div>
                    
                    <div class="cad-content">
                        <!-- Pestaña de Tuberías -->
                        <div class="cad-tab-content active" id="tuberias-tab">
                            <div class="control-group">
                                <h4>Tubería Principal</h4>
                                <div class="control-row">
                                    <div class="control-label">Color:</div>
                                    <div class="color-indicator color-principal"></div>
                                    <div>Rojo (Grosor: 6px)</div>
                                </div>
                                <div class="control-row">
                                    <div class="control-label">Diámetro:</div>
                                    <select id="diametroPrincipal">
                                        <option value="2">2"</option>
                                        <option value="3">3"</option>
                                        <option value="4">4"</option>
                                        <option value="6">6"</option>
                                        <option value="8">8"</option>
                                        <option value="10">10"</option>
                                        <option value="12">12"</option>
                                        <option value="14">14"</option>
                                        <option value="16">16"</option>
                                        <option value="18">18"</option>
                                        <option value="20">20"</option>
                                    </select>
                                </div>
                                <div class="control-row">
                                    <div class="control-label">Tipo:</div>
                                    <select id="tipoPrincipal">
                                        <option value="pvc">PVC</option>
                                        <option value="manguera">Manguera</option>
                                    </select>
                                </div>
                                <button class="tuberia-btn" onclick="iniciarDibujoTuberia('principal')" id="btnTuberiaPrincipal">
                                    <i class="fas fa-pencil-alt"></i> Dibujar Tubería Principal
                                </button>
                                <div class="instrucciones-tuberia" id="instruccionesPrincipal" style="display: none;">
                                    Haz clic en el mapa para iniciar la tubería. Click para agregar puntos. Doble click para finalizar.
                                </div>
                            </div>
                            
                            <div class="control-group">
                                <h4>Tubería Secundaria</h4>
                                <div class="control-row">
                                    <div class="control-label">Color:</div>
                                    <div class="color-indicator color-secundaria"></div>
                                    <div>Turquesa (Grosor: 4px)</div>
                                </div>
                                <div class="control-row">
                                    <div class="control-label">Diámetro:</div>
                                    <select id="diametroSecundaria">
                                        <option value="1">1"</option>
                                        <option value="1.5">1.5"</option>
                                        <option value="2">2"</option>
                                        <option value="3">3"</option>
                                        <option value="4">4"</option>
                                    </select>
                                </div>
                                <div class="control-row">
                                    <div class="control-label">Tipo:</div>
                                    <select id="tipoSecundaria">
                                        <option value="pvc">PVC</option>
                                        <option value="manguera">Manguera</option>
                                    </select>
                                </div>
                                <button class="tuberia-btn" onclick="iniciarDibujoTuberia('secundaria')" id="btnTuberiaSecundaria">
                                    <i class="fas fa-pencil-alt"></i> Dibujar Tubería Secundaria
                                </button>
                                <div class="instrucciones-tuberia" id="instruccionesSecundaria" style="display: none;">
                                    Haz clic en el mapa para iniciar la tubería. Click para agregar puntos. Doble click para finalizar.
                                </div>
                            </div>
                            
                            <div class="control-group">
                                <h4>Tubería Regante</h4>
                                <div class="control-row">
                                    <div class="control-label">Color:</div>
                                    <div class="color-indicator color-regante"></div>
                                    <div>Azul (Grosor: 2px)</div>
                                </div>
                                <div class="control-row">
                                    <div class="control-label">Diámetro:</div>
                                    <select id="diametroRegante">
                                        <option value="0.5">1/2"</option>
                                        <option value="0.75">3/4"</option>
                                        <option value="1">1"</option>
                                    </select>
                                </div>
                                <div class="control-row">
                                    <div class="control-label">Tipo:</div>
                                    <select id="tipoRegante">
                                        <option value="pvc">PVC</option>
                                        <option value="manguera">Manguera</option>
                                    </select>
                                </div>
                                <button class="tuberia-btn" onclick="iniciarDibujoTuberia('regante')" id="btnTuberiaRegante">
                                    <i class="fas fa-pencil-alt"></i> Dibujar Tubería Regante
                                </button>
                                <div class="instrucciones-tuberia" id="instruccionesRegante" style="display: none;">
                                    Haz clic en el mapa para iniciar la tubería. Click para agregar puntos. Doble click para finalizar.
                                </div>
                            </div>
                            
                            <div class="cad-resumen">
                                <h4>Resumen de Tuberías</h4>
                                <div class="resumen-item">
                                    <span>Principal:</span>
                                    <span id="metrosPrincipal">0 m</span>
                                </div>
                                <div class="resumen-item">
                                    <span>Secundaria:</span>
                                    <span id="metrosSecundaria">0 m</span>
                                </div>
                                <div class="resumen-item">
                                    <span>Regante:</span>
                                    <span id="metrosRegante">0 m</span>
                                </div>
                                <div class="resumen-item" style="font-weight: bold; border-top: 1px solid #ddd; padding-top: 8px;">
                                    <span>Total:</span>
                                    <span id="metrosTotal">0 m</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Pestaña de Elementos -->
                        <div class="cad-tab-content" id="elementos-tab">
                            <div class="control-group">
                                <h4>Agregar Elementos al Diseño</h4>
                                <div class="elementos-lista">
                                    <div class="elemento-btn active" data-elemento="cabezal" onclick="iniciarModoElemento('cabezal')">
                                        <i class="fas fa-water-pump"></i> Cabezal
                                    </div>
                                    <div class="elemento-btn" data-elemento="purgaterminal" onclick="iniciarModoElemento('purgaterminal')">
                                        <i class="fas fa-faucet"></i> Purgas/Terminales
                                    </div>
                                    <div class="elemento-btn" data-elemento="tomagua" onclick="iniciarModoElemento('tomagua')">
                                        <i class="fas fa-tint"></i> Toma de Agua
                                    </div>
                                    <div class="elemento-btn" data-elemento="valvula" onclick="iniciarModoElemento('valvula')">
                                        <i class="fas fa-toggle-on"></i> Válvula
                                    </div>
                                    <div class="elemento-btn" data-elemento="filtro" onclick="iniciarModoElemento('filtro')">
                                        <i class="fas fa-filter"></i> Filtro
                                    </div>
                                </div>
                                <div class="instrucciones-tuberia" id="instruccionesElementos" style="display: none;">
                                    Haz clic en el mapa para colocar el elemento seleccionado.
                                </div>
                            </div>
                            
                            <div class="control-group">
                                <h4>Configuración del Elemento</h4>
                                <div id="elementoConfig">
                                    <p>Selecciona un elemento para configurarlo</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Pestaña de Secciones -->
                        <div class="cad-tab-content" id="secciones-tab">
                            <div class="control-group">
                                <h4>Secciones del Sistema (A1-Z10)</h4>
                                <div class="secciones-grid" id="seccionesGrid">
                                    <p style="grid-column: 1 / -1; text-align: center; color: #666;">Primero delimita el terreno en el mapa</p>
                                </div>
                            </div>
                            
                            <div class="seccion-config" id="seccionConfig">
                                <h4>Configuración de Sección</h4>
                                <p>Selecciona una sección para configurarla</p>
                            </div>
                        </div>
                        
                        <!-- Pestaña de Emisores -->
                        <div class="cad-tab-content" id="emisores-tab">
                            <div class="control-group">
                                <h4>Tipo de Emisor</h4>
                                <div class="control-row">
                                    <div class="control-label">Tipo:</div>
                                    <select id="tipoEmisor">
                                        <option value="goteo">Goteo</option>
                                        <option value="aspersion">Aspersión</option>
                                        <option value="microaspersion">Microaspersión</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="emisor-panel">
                                <div class="emisor-header">
                                    <h4>Características del Emisor</h4>
                                    <div id="caudalTotal">Caudal Total: 0 L/h</div>
                                </div>
                                
                                <div class="control-row">
                                    <div class="control-label">Caudal:</div>
                                    <input type="number" id="caudalEmisor" min="1" max="100" value="4" step="0.5"> L/h
                                </div>
                                
                                <div class="control-row">
                                    <div class="control-label">Separación:</div>
                                    <input type="number" id="separacionEmisor" min="0.1" max="5" value="0.5" step="0.1"> m
                                </div>
                                
                                <div class="control-row">
                                    <div class="control-label">Separación surco:</div>
                                    <input type="number" id="separacionSurco" min="0.5" max="3" value="1.5" step="0.1"> m
                                </div>
                                
                                <div class="emisor-info">
                                    <div class="resumen-item">
                                        <span>Emisores por m²:</span>
                                        <span id="emisoresPorM2">0</span>
                                    </div>
                                    <div class="resumen-item">
                                        <span>Caudal por m²:</span>
                                        <span id="caudalPorM2">0 L/h</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Pestaña de Galería -->
                        <div class="cad-tab-content" id="galeria-tab">
                            <div class="control-group">
                                <h4>Diseños Guardados</h4>
                                <div class="galeria-acciones">
                                    <button class="btn" onclick="guardarDiseño()" style="margin-right: 10px;">
                                        <i class="fas fa-save"></i> Guardar Actual
                                    </button>
                                    <button class="btn btn-secondary" onclick="exportarDiseño()">
                                        <i class="fas fa-download"></i> Exportar
                                    </button>
                                    <label class="btn btn-secondary" style="display: inline-block; cursor: pointer;">
                                        <i class="fas fa-upload"></i> Importar
                                        <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importarDiseño(event)">
                                    </label>
                                </div>
                                
                                <div class="galeria-diseños" id="galeriaDiseños" style="margin-top: 20px; max-height: 300px; overflow-y: auto;">
                                    <!-- Diseños se cargarán aquí -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Contacto -->
    <section class="contacto" id="contacto">
        <div class="container">
            <h2 class="section-title">Contacto</h2>
            <div class="contacto-grid">
                <div class="contact-info-card fade-in">
                    <h3>Información de Contacto</h3>
                    
                    <div class="contact-item">
                        <div class="contact-icon">
                            <i class="fas fa-map-marker-alt"></i>
                        </div>
                        <div class="contact-text">
                            <h4>Dirección</h4>
                            <p>Los Mochis, Sinaloa, México</p>
                        </div>
                    </div>
                    
                    <div class="contact-item">
                        <div class="contact-icon">
                            <i class="fas fa-phone"></i>
                        </div>
                        <div class="contact-text">
                            <h4>Teléfono</h4>
                            <a href="tel:+526681234567">+52 668 123 4567</a>
                        </div>
                    </div>
                    
                    <div class="contact-item">
                        <div class="contact-icon">
                            <i class="fas fa-envelope"></i>
                        </div>
                        <div class="contact-text">
                            <h4>Email</h4>
                            <a href="mailto:info@agrosistemas.com">info@agrosistemas.com</a>
                        </div>
                    </div>
                    
                    <div class="contact-item">
                        <div class="contact-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="contact-text">
                            <h4>Horario de Atención</h4>
                            <p>Lunes a Viernes: 8:00 - 18:00<br>Sábados: 9:00 - 13:00</p>
                        </div>
                    </div>
                </div>
                
                <div class="fade-in delay-1">
                    <h3 style="margin-bottom: 20px; color: #111;">Ubicación</h3>
                    <div class="map-container">
                        <iframe src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d115260.94825251572!2d-109.02480815!3d25.813333!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x86c7a5f40b6e008d%3A0x9a3f37c0e13f2cf6!2sLos%20Mochis%2C%20Sin.!5e0!3m2!1ses-419!2smx!4v1689690161688!5m2!1ses-419!2smx" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-logo">
                    <img src="logo.png" alt="Agrosistemas Logo">
                </div>
                <p class="footer-text">Especialistas en soluciones agrícolas integrales. Optimizamos tu producción con tecnología de punta y asesoría técnica especializada.</p>
                <div class="copyright">
                    &copy; 2024 Agrosistemas. Todos los derechos reservados.
                </div>
            </div>
        </div>
    </footer>

    <!-- Scripts -->
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    <!-- Leaflet Draw JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    
<script>
    // Variables globales
    let map;
    let drawnItems;
    let drawControl;
    let currentDrawMode = null;
    let areaTotal = 0;
    let selectedElement = 'cabezal';
    let secciones = {};
    let seccionActual = null;
    let tuberias = [];
    let elementosGraficos = [];
    let modoDibujoTuberia = null;
    let tuberiaActual = null;
    let puntoInicioTuberia = null;
    let diseñosGuardados = [];
    let modoAgregarElemento = null;
    
    // Nuevas variables para el sistema de 2 puntos
    let modoConexion = false;
    let tuberiaConexionTipo = null;
    let puntoOrigenConexion = null;
    let puntosTuberias = []; // Puntos de conexión de todas las tuberías
    
    // Inicializar el mapa
    function initMap() {
        // Coordenadas de Los Mochis, Sinaloa
        const losMochis = [25.8133, -108.9719];
        
        // Crear mapa
        map = L.map('map').setView(losMochis, 15);
        
        // Añadir capa de OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(map);
        
        // Capa para dibujar elementos
        drawnItems = new L.FeatureGroup();
        map.addLayer(drawnItems);
        
        // Configurar herramientas de dibujo
        drawControl = new L.Control.Draw({
            position: 'topright',
            draw: {
                polygon: {
                    allowIntersection: false,
                    shapeOptions: {
                        color: '#008a45',
                        fillColor: '#00a553',
                        fillOpacity: 0.3,
                        weight: 2
                    },
                    showArea: true,
                    metric: true
                },
                polyline: {
                    shapeOptions: {
                        color: '#ff0000',
                        weight: 2
                    },
                    showLength: true,
                    metric: true
                },
                rectangle: false,
                circle: false,
                marker: false,
                circlemarker: false
            },
            edit: {
                featureGroup: drawnItems,
                remove: true
            }
        });
        
        map.addControl(drawControl);
        
        // Eventos de dibujo
        map.on(L.Draw.Event.CREATED, function(event) {
            const layer = event.layer;
            drawnItems.addLayer(layer);
            
            if (event.layerType === 'polygon') {
                calcularAreaPoligono(layer);
            } else if (event.layerType === 'polyline') {
                calcularLongitudPolilinea(layer);
            }
            
            // Desactivar modo de dibujo después de crear
            if (currentDrawMode) {
                currentDrawMode.disable();
                currentDrawMode = null;
            }
        });
        
        // Evento de edición
        map.on(L.Draw.Event.EDITED, function(event) {
            const layers = event.layers;
            layers.eachLayer(function(layer) {
                if (layer instanceof L.Polygon) {
                    calcularAreaPoligono(layer);
                } else if (layer instanceof L.Polyline) {
                    calcularLongitudPolilinea(layer);
                }
            });
        });
        
        // Evento de eliminación
        map.on(L.Draw.Event.DELETED, function(event) {
            const layers = event.layers;
            layers.eachLayer(function(layer) {
                if (layer instanceof L.Polygon) {
                    areaTotal = 0;
                    document.getElementById('areaDisplay').textContent = 'Área: 0 m²';
                    actualizarCalculos();
                    inicializarSecciones();
                    mostrarControlesMapa();
                }
            });
        });
        
        // Inicializar secciones
        inicializarSecciones();
        
        // Calcular emisores iniciales
        calcularEmisores();
        
        // Configurar eventos de tuberías
        configurarEventosTuberias();
        
        // Evento para agregar elementos
        map.on('click', function(e) {
            if (modoAgregarElemento) {
                agregarElementoGrafico(e.latlng, modoAgregarElemento);
                modoAgregarElemento = null;
                document.getElementById('instruccionesElementos').style.display = 'none';
                mostrarMensaje('Elemento agregado. Selecciona otro para agregar más.');
            }
        });
    }
    
    // Calcular área del polígono
    function calcularAreaPoligono(polygon) {
        // Calcular área usando Leaflet
        areaTotal = L.GeometryUtil.geodesicArea(polygon.getLatLngs()[0]);
        
        // Actualizar display
        document.getElementById('areaDisplay').textContent = 
            `Área: ${areaTotal.toFixed(2)} m² (${(areaTotal / 10000).toFixed(2)} ha)`;
        
        // Ocultar controles del mapa
        ocultarControlesMapa();
        
        // Actualizar cálculos basados en área
        actualizarCalculos();
        
        // Generar secciones automáticamente
        generarSecciones();
    }
    
    // Ocultar controles del mapa
    function ocultarControlesMapa() {
        const controls = document.getElementById('mapaControls');
        controls.style.display = 'none';
        
        // Mostrar botón para mostrar controles
        document.getElementById('showControlsBtn').style.display = 'block';
    }
    
    // Mostrar controles del mapa
    function mostrarControlesMapa() {
        const controls = document.getElementById('mapaControls');
        controls.style.display = 'block';
        
        // Ocultar botón de mostrar controles
        document.getElementById('showControlsBtn').style.display = 'none';
        document.getElementById('hideControlsBtn').style.display = 'none';
    }
    
    // Calcular longitud de polilínea
    function calcularLongitudPolilinea(polyline) {
        const latlngs = polyline.getLatLngs();
        let length = 0;
        
        for (let i = 0; i < latlngs.length - 1; i++) {
            length += latlngs[i].distanceTo(latlngs[i + 1]);
        }
        
        // Mostrar longitud
        const areaDisplay = document.getElementById('areaDisplay');
        const currentArea = areaDisplay.textContent.includes('Longitud') ? 
            areaDisplay.textContent.split(' | ')[0] : areaDisplay.textContent;
        areaDisplay.textContent = `${currentArea} | Longitud: ${length.toFixed(2)} m`;
    }
    
    // Generar secciones automáticamente
    function generarSecciones() {
        const seccionesGrid = document.getElementById('seccionesGrid');
        seccionesGrid.innerHTML = '';
        
        // Crear 16 secciones (A1-D4)
        const letras = ['A', 'B', 'C', 'D'];
        const numeros = ['1', '2', '3', '4'];
        
        let contador = 0;
        for (let i = 0; i < letras.length && contador < 16; i++) {
            for (let j = 0; j < numeros.length && contador < 16; j++) {
                const codigo = letras[i] + numeros[j];
                
                // Crear sección
                secciones[codigo] = {
                    nombre: codigo,
                    area: areaTotal / 16, // Dividir área total en 16 partes
                    caudal: 0,
                    configurado: false
                };
                
                // Crear elemento en la cuadrícula
                const seccionElement = document.createElement('div');
                seccionElement.className = 'seccion-item';
                seccionElement.textContent = codigo;
                seccionElement.dataset.seccion = codigo;
                
                seccionElement.addEventListener('click', function() {
                    seleccionarSeccion(codigo);
                });
                
                seccionesGrid.appendChild(seccionElement);
                contador++;
            }
        }
        
        // Seleccionar primera sección por defecto
        if (Object.keys(secciones).length > 0) {
            seleccionarSeccion(Object.keys(secciones)[0]);
        }
    }
    
    // Inicializar secciones vacías
    function inicializarSecciones() {
        const seccionesGrid = document.getElementById('seccionesGrid');
        seccionesGrid.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: #666;">Primero delimita el terreno en el mapa</p>';
    }
    
    // Seleccionar una sección
    function seleccionarSeccion(codigo) {
        // Quitar clase active de todas las secciones
        document.querySelectorAll('.seccion-item').forEach(item => {
            item.classList.remove('active');
        });
        
        // Agregar clase active a la sección seleccionada
        const seccionElement = document.querySelector(`.seccion-item[data-seccion="${codigo}"]`);
        if (seccionElement) {
            seccionElement.classList.add('active');
        }
        
        seccionActual = codigo;
        actualizarConfiguracionSeccion();
    }
    
    // Actualizar configuración de sección
    function actualizarConfiguracionSeccion() {
        const configDiv = document.getElementById('seccionConfig');
        
        if (!seccionActual || !secciones[seccionActual]) {
            configDiv.innerHTML = '<h4>Configuración de Sección</h4><p>Selecciona una sección para configurarla</p>';
            return;
        }
        
        const seccion = secciones[seccionActual];
        
        configDiv.innerHTML = `
            <h4>Configuración de Sección ${seccionActual}</h4>
            <div class="control-row">
                <div class="control-label">Área:</div>
                <div>${seccion.area.toFixed(2)} m²</div>
            </div>
            <div class="control-row">
                <div class="control-label">Caudal calculado:</div>
                <div id="caudalSeccionDisplay">${seccion.caudal.toFixed(2)} L/h</div>
            </div>
            <div class="control-row">
                <div class="control-label">Separación surco:</div>
                <input type="number" id="separacionSurcoSeccion" min="0.5" max="3" value="${seccion.separacionSurco || 1.5}" step="0.1" onchange="actualizarCaudalSeccion()"> m
            </div>
            <div class="control-row">
                <div class="control-label">Separación emisor:</div>
                <input type="number" id="separacionEmisorSeccion" min="0.1" max="5" value="${seccion.separacionEmisor || 0.5}" step="0.1" onchange="actualizarCaudalSeccion()"> m
            </div>
            <div class="control-row">
                <div class="control-label">Caudal emisor:</div>
                <input type="number" id="caudalEmisorSeccion" min="1" max="100" value="${seccion.caudalEmisor || 4}" step="0.5" onchange="actualizarCaudalSeccion()"> L/h
            </div>
        `;
        
        // Calcular caudal inicial
        actualizarCaudalSeccion();
    }
    
    // Actualizar caudal de sección
    function actualizarCaudalSeccion() {
        if (!seccionActual) return;
        
        const separacionSurco = parseFloat(document.getElementById('separacionSurcoSeccion').value) || 1.5;
        const separacionEmisor = parseFloat(document.getElementById('separacionEmisorSeccion').value) || 0.5;
        const caudalEmisor = parseFloat(document.getElementById('caudalEmisorSeccion').value) || 4;
        
        // Calcular emisores por metro lineal
        const emisoresPorMetro = 1 / separacionEmisor;
        
        // Calcular líneas de riego por metro
        const lineasPorMetro = 1 / separacionSurco;
        
        // Calcular caudal por m²
        const caudalPorM2 = emisoresPorMetro * lineasPorMetro * caudalEmisor;
        
        // Calcular caudal total para la sección
        const caudalTotal = caudalPorM2 * secciones[seccionActual].area;
        
        // Actualizar objeto sección
        secciones[seccionActual].caudal = caudalTotal;
        secciones[seccionActual].separacionSurco = separacionSurco;
        secciones[seccionActual].separacionEmisor = separacionEmisor;
        secciones[seccionActual].caudalEmisor = caudalEmisor;
        secciones[seccionActual].configurado = true;
        
        // Actualizar display
        document.getElementById('caudalSeccionDisplay').textContent = caudalTotal.toFixed(2) + ' L/h';
        
        // Actualizar caudal total
        actualizarCaudalTotal();
    }
    
    // Calcular emisores y caudal
    function calcularEmisores() {
        const caudalEmisor = parseFloat(document.getElementById('caudalEmisor').value) || 4;
        const separacionEmisor = parseFloat(document.getElementById('separacionEmisor').value) || 0.5;
        const separacionSurco = parseFloat(document.getElementById('separacionSurco').value) || 1.5;
        
        // Calcular emisores por m²
        const emisoresPorM2 = (1 / separacionEmisor) * (1 / separacionSurco);
        
        // Calcular caudal por m²
        const caudalPorM2 = emisoresPorM2 * caudalEmisor;
        
        // Actualizar displays
        document.getElementById('emisoresPorM2').textContent = emisoresPorM2.toFixed(2);
        document.getElementById('caudalPorM2').textContent = caudalPorM2.toFixed(2) + ' L/h';
        
        // Actualizar caudal total si hay área definida
        if (areaTotal > 0) {
            const caudalTotal = caudalPorM2 * areaTotal;
            document.getElementById('caudalTotal').textContent = `Caudal Total: ${caudalTotal.toFixed(2)} L/h`;
        }
    }
    
    // Actualizar caudal total sumando todas las secciones
    function actualizarCaudalTotal() {
        let caudalTotal = 0;
        
        for (const codigo in secciones) {
            if (secciones[codigo].configurado) {
                caudalTotal += secciones[codigo].caudal;
            }
        }
        
        document.getElementById('caudalTotal').textContent = `Caudal Total: ${caudalTotal.toFixed(2)} L/h`;
    }
    
    // Actualizar cálculos basados en área
    function actualizarCalculos() {
        // Actualizar metros lineales (estimación basada en área)
        const metrosPrincipal = Math.sqrt(areaTotal) * 2;
        const metrosSecundaria = Math.sqrt(areaTotal) * 4;
        const metrosRegante = Math.sqrt(areaTotal) * 8;
        const metrosTotal = metrosPrincipal + metrosSecundaria + metrosRegante;
        
        document.getElementById('metrosPrincipal').textContent = metrosPrincipal.toFixed(2) + ' m';
        document.getElementById('metrosSecundaria').textContent = metrosSecundaria.toFixed(2) + ' m';
        document.getElementById('metrosRegante').textContent = metrosRegante.toFixed(2) + ' m';
        document.getElementById('metrosTotal').textContent = metrosTotal.toFixed(2) + ' m';
        
        // Recalcular emisores
        calcularEmisores();
    }
    
    // Buscar ubicación en el mapa
    function buscarUbicacion() {
        const query = document.getElementById('location-search').value;
        if (!query.trim()) return;
        
        // Usar Nominatim (servicio de geocodificación de OpenStreetMap)
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                if (data && data.length > 0) {
                    const result = data[0];
                    const lat = parseFloat(result.lat);
                    const lon = parseFloat(result.lon);
                    
                    map.setView([lat, lon], 15);
                    
                    // Añadir marcador
                    L.marker([lat, lon])
                        .addTo(map)
                        .bindPopup(`<b>${result.display_name}</b>`)
                        .openPopup();
                } else {
                    alert('Ubicación no encontrada');
                }
            })
            .catch(error => {
                console.error('Error en la búsqueda:', error);
                alert('Error al buscar la ubicación');
            });
    }
    
    // Sistema de tuberías como líneas rectas de 2 puntos
    function getColorTuberia(tipo) {
        const colores = {
            'principal': '#ff6b6b',
            'secundaria': '#4ecdc4',
            'regante': '#45b7d1'
        };
        return colores[tipo] || '#000000';
    }
    
    function getGrosorTuberia(tipo) {
        const grosores = {
            'principal': 6,
            'secundaria': 4,
            'regante': 2
        };
        return grosores[tipo] || 2;
    }
    
    // Función para iniciar modo tubería (2 puntos)
    function iniciarModoTuberia(tipoTuberia) {
        // Desactivar otros modos
        if (currentDrawMode) {
            currentDrawMode.disable();
            currentDrawMode = null;
        }
        
        modoConexion = false;
        tuberiaConexionTipo = null;
        puntoOrigenConexion = null;
        
        // Quitar clases de modo conexión
        document.querySelectorAll('.tuberia-btn').forEach(btn => {
            btn.classList.remove('modo-conexion-activo');
        });
        
        // Quitar clase activa de todos los botones
        document.querySelectorAll('.tuberia-btn').forEach(btn => {
            btn.classList.remove('activo');
        });
        
        // Agregar clase activa al botón clickeado
        const botonId = tipoTuberia === 'principal' ? 'btnTuberiaPrincipal' : 
                       tipoTuberia === 'secundaria' ? 'btnTuberiaSecundaria' : 'btnTuberiaRegante';
        document.getElementById(botonId).classList.add('activo');
        
        // Mostrar instrucciones
        const tipos = {
            'principal': 'Principal',
            'secundaria': 'Secundaria',
            'regante': 'Regante'
        };
        
        const instruccionesId = tipoTuberia === 'principal' ? 'instruccionesPrincipal' : 
                               tipoTuberia === 'secundaria' ? 'instruccionesSecundaria' : 'instruccionesRegante';
        document.getElementById(instruccionesId).style.display = 'block';
        
        // Configurar para dibujar tubería de 2 puntos
        tuberiaActual = {
            tipo: tipoTuberia,
            puntoInicio: null,
            puntoFin: null,
            color: getColorTuberia(tipoTuberia),
            grosor: getGrosorTuberia(tipoTuberia),
            diametro: document.getElementById(`diametro${tipos[tipoTuberia]}`).value,
            tipoMaterial: document.getElementById(`tipo${tipos[tipoTuberia]}`).value,
            id: Date.now(),
            conexiones: [] // Para almacenar conexiones con otras tuberías
        };
        
        mostrarMensaje(`Modo dibujo tubería ${tipoTuberia}. Haz clic en el mapa para establecer el punto de inicio.`);
        
        // Configurar evento único para el primer clic
        map.off('click'); // Remover eventos previos
        map.on('click', function(e) {
            if (tuberiaActual && !tuberiaActual.puntoInicio) {
                // Primer clic: establecer punto de inicio
                tuberiaActual.puntoInicio = e.latlng;
                
                // Crear marcador de inicio
                const marcadorInicio = crearMarcadorTuberia(e.latlng, 'inicio', tipoTuberia);
                marcadorInicio.addTo(map);
                
                // Guardar referencia
                tuberiaActual.marcadorInicio = marcadorInicio;
                
                // Añadir a puntos de tuberías
                puntosTuberias.push({
                    tipo: tipoTuberia,
                    latlng: e.latlng,
                    tuberiaId: tuberiaActual.id,
                    esInicio: true
                });
                
                mostrarMensaje(`Punto de inicio establecido. Ahora haz clic para establecer el punto final.
                Puedes hacer clic en un punto existente de otra tubería para conectar.`);
                
                // Preparar para el segundo clic
                map.off('click');
                map.on('click', function(e2) {
                    establecerPuntoFinal(e2.latlng, tipoTuberia);
                });
            }
        });
    }
    
    // Función para establecer punto final
    function establecerPuntoFinal(latlng, tipoTuberia) {
        if (!tuberiaActual || !tuberiaActual.puntoInicio) return;
        
        // Verificar si se hizo clic en un punto existente
        let puntoExistente = null;
        let esConexion = false;
        
        puntosTuberias.forEach(punto => {
            const distancia = latlng.distanceTo(punto.latlng);
            if (distancia < 5) { // Si está cerca (5 metros)
                puntoExistente = punto;
                esConexion = true;
            }
        });
        
        tuberiaActual.puntoFin = puntoExistente ? puntoExistente.latlng : latlng;
        
        // Crear marcador de fin (si no es conexión con punto existente)
        if (!puntoExistente) {
            const marcadorFin = crearMarcadorTuberia(latlng, 'fin', tipoTuberia);
            marcadorFin.addTo(map);
            tuberiaActual.marcadorFin = marcadorFin;
            
            // Añadir a puntos de tuberías
            puntosTuberias.push({
                tipo: tipoTuberia,
                latlng: latlng,
                tuberiaId: tuberiaActual.id,
                esInicio: false
            });
        } else {
            // Registrar conexión
            tuberiaActual.conexiones.push({
                tuberiaId: puntoExistente.tuberiaId,
                punto: puntoExistente.esInicio ? 'inicio' : 'fin',
                latlng: puntoExistente.latlng
            });
            
            // También actualizar la otra tubería
            const otraTuberia = tuberias.find(t => t.id === puntoExistente.tuberiaId);
            if (otraTuberia) {
                otraTuberia.conexiones.push({
                    tuberiaId: tuberiaActual.id,
                    punto: 'pendiente', // Se determinará después
                    latlng: tuberiaActual.puntoFin
                });
            }
        }
        
        // Dibujar la línea
        const linea = dibujarLineaTuberia(tuberiaActual.puntoInicio, tuberiaActual.puntoFin, tipoTuberia);
        tuberiaActual.linea = linea;
        
        // Calcular longitud
        const longitud = tuberiaActual.puntoInicio.distanceTo(tuberiaActual.puntoFin);
        tuberiaActual.longitud = longitud;
        
        // Añadir etiqueta de longitud
        const centro = L.latLng(
            (tuberiaActual.puntoInicio.lat + tuberiaActual.puntoFin.lat) / 2,
            (tuberiaActual.puntoInicio.lng + tuberiaActual.puntoFin.lng) / 2
        );
        
        const etiqueta = L.marker(centro, {
            icon: L.divIcon({
                className: 'tuberia-label',
                html: `<div style="background: white; padding: 2px 5px; border: 1px solid #ccc; border-radius: 3px; font-size: 10px; font-weight: bold;">
                       ${longitud.toFixed(1)}m</div>`,
                iconSize: [60, 20],
                iconAnchor: [30, 10]
            })
        }).addTo(map);
        
        tuberiaActual.etiquetaLongitud = etiqueta;
        
        // Guardar tubería
        tuberias.push({...tuberiaActual});
        
        // Actualizar resumen
        actualizarResumenTuberias();
        
        // Resetear para nueva tubería
        tuberiaActual = null;
        
        // Remover eventos
        map.off('click');
        
        // Ocultar instrucciones
        const instruccionesId = tipoTuberia === 'principal' ? 'instruccionesPrincipal' : 
                               tipoTuberia === 'secundaria' ? 'instruccionesSecundaria' : 'instruccionesRegante';
        document.getElementById(instruccionesId).style.display = 'none';
        
        // Quitar clase activa del botón
        const botonId = tipoTuberia === 'principal' ? 'btnTuberiaPrincipal' : 
                       tipoTuberia === 'secundaria' ? 'btnTuberiaSecundaria' : 'btnTuberiaRegante';
        document.getElementById(botonId).classList.remove('activo');
        
        mostrarMensaje(`Tubería ${tipoTuberia} creada. Longitud: ${longitud.toFixed(1)} metros`);
        
        if (esConexion) {
            mostrarMensaje('¡Conexión establecida con tubería existente!');
        }
    }
    
    // Función para crear marcadores de tubería
    function crearMarcadorTuberia(latlng, tipo, tipoTuberia) {
        const colores = {
            'principal': '#ff6b6b',
            'secundaria': '#4ecdc4',
            'regante': '#45b7d1'
        };
        
        const tamanos = {
            'principal': 15,
            'secundaria': 12,
            'regante': 10
        };
        
        const color = colores[tipoTuberia];
        const tamano = tamanos[tipoTuberia];
        
        const marcador = L.marker(latlng, {
            icon: L.divIcon({
                className: 'tuberia-punto',
                html: `<div style="background: ${color}; width: ${tamano}px; height: ${tamano}px; 
                       border-radius: 50%; border: 2px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.5); 
                       cursor: pointer;"></div>`,
                iconSize: [tamano, tamano],
                iconAnchor: [tamano/2, tamano/2]
            })
        });
        
        // Hacer el marcador arrastrable
        marcador.draggable = true;
        marcador.on('dragend', function(e) {
            const nuevoLatLng = e.target.getLatLng();
            
            // Actualizar punto en puntosTuberias
            const puntoIndex = puntosTuberias.findIndex(p => 
                Math.abs(p.latlng.lat - latlng.lat) < 0.00001 && 
                Math.abs(p.latlng.lng - latlng.lng) < 0.00001
            );
            
            if (puntoIndex !== -1) {
                puntosTuberias[puntoIndex].latlng = nuevoLatLng;
            }
            
            // Actualizar tuberías que usan este punto
            actualizarTuberiasConPunto(latlng, nuevoLatLng);
        });
        
        return marcador;
    }
    
    // Función para dibujar línea entre dos puntos
    function dibujarLineaTuberia(puntoInicio, puntoFin, tipoTuberia) {
        const color = getColorTuberia(tipoTuberia);
        const grosor = getGrosorTuberia(tipoTuberia);
        
        const linea = L.polyline([puntoInicio, puntoFin], {
            color: color,
            weight: grosor,
            opacity: 0.8,
            lineCap: 'round',
            lineJoin: 'round'
        }).addTo(map);
        
        // Hacer la línea editable
        linea.editing.enable();
        
        return linea;
    }
    
    // Función para actualizar tuberías cuando se mueve un punto
    function actualizarTuberiasConPunto(viejoLatLng, nuevoLatLng) {
        tuberias.forEach(tuberia => {
            // Actualizar punto de inicio si coincide
            if (tuberia.puntoInicio && 
                Math.abs(tuberia.puntoInicio.lat - viejoLatLng.lat) < 0.00001 && 
                Math.abs(tuberia.puntoInicio.lng - viejoLatLng.lng) < 0.00001) {
                tuberia.puntoInicio = nuevoLatLng;
                
                // Actualizar línea
                if (tuberia.linea && tuberia.puntoFin) {
                    const nuevosPuntos = [nuevoLatLng, tuberia.puntoFin];
                    tuberia.linea.setLatLngs(nuevosPuntos);
                }
                
                // Actualizar etiqueta de longitud
                if (tuberia.etiquetaLongitud && tuberia.puntoFin) {
                    const centro = L.latLng(
                        (nuevoLatLng.lat + tuberia.puntoFin.lat) / 2,
                        (nuevoLatLng.lng + tuberia.puntoFin.lng) / 2
                    );
                    tuberia.etiquetaLongitud.setLatLng(centro);
                    
                    // Actualizar texto de longitud
                    const nuevaLongitud = nuevoLatLng.distanceTo(tuberia.puntoFin);
                    tuberia.longitud = nuevaLongitud;
                    tuberia.etiquetaLongitud.setIcon(L.divIcon({
                        className: 'tuberia-label',
                        html: `<div style="background: white; padding: 2px 5px; border: 1px solid #ccc; border-radius: 3px; font-size: 10px; font-weight: bold;">
                               ${nuevaLongitud.toFixed(1)}m</div>`,
                        iconSize: [60, 20],
                        iconAnchor: [30, 10]
                    }));
                }
            }
            
            // Actualizar punto de fin si coincide
            if (tuberia.puntoFin && 
                Math.abs(tuberia.puntoFin.lat - viejoLatLng.lat) < 0.00001 && 
                Math.abs(tuberia.puntoFin.lng - viejoLatLng.lng) < 0.00001) {
                tuberia.puntoFin = nuevoLatLng;
                
                // Actualizar línea
                if (tuberia.linea && tuberia.puntoInicio) {
                    const nuevosPuntos = [tuberia.puntoInicio, nuevoLatLng];
                    tuberia.linea.setLatLngs(nuevosPuntos);
                }
                
                // Actualizar etiqueta de longitud
                if (tuberia.etiquetaLongitud && tuberia.puntoInicio) {
                    const centro = L.latLng(
                        (tuberia.puntoInicio.lat + nuevoLatLng.lat) / 2,
                        (tuberia.puntoInicio.lng + nuevoLatLng.lng) / 2
                    );
                    tuberia.etiquetaLongitud.setLatLng(centro);
                    
                    // Actualizar texto de longitud
                    const nuevaLongitud = tuberia.puntoInicio.distanceTo(nuevoLatLng);
                    tuberia.longitud = nuevaLongitud;
                    tuberia.etiquetaLongitud.setIcon(L.divIcon({
                        className: 'tuberia-label',
                        html: `<div style="background: white; padding: 2px 5px; border: 1px solid #ccc; border-radius: 3px; font-size: 10px; font-weight: bold;">
                               ${nuevaLongitud.toFixed(1)}m</div>`,
                        iconSize: [60, 20],
                        iconAnchor: [30, 10]
                    }));
                }
            }
        });
        
        // Actualizar resumen
        actualizarResumenTuberias();
    }
    
    // Función para iniciar modo conexión entre tuberías
    function iniciarModoConexion(tipoTuberia) {
        // Desactivar otros modos
        if (currentDrawMode) {
            currentDrawMode.disable();
            currentDrawMode = null;
        }
        
        if (tuberiaActual) {
            tuberiaActual = null;
        }
        
        // Quitar clase activa de todos los botones
        document.querySelectorAll('.tuberia-btn').forEach(btn => {
            btn.classList.remove('activo');
        });
        
        // Agregar clase modo conexión
        const botonId = tipoTuberia === 'principal' ? 'btnConectarPrincipal' : 
                       tipoTuberia === 'secundaria' ? 'btnConectarSecundaria' : 'btnConectarRegante';
        document.getElementById(botonId).classList.add('modo-conexion-activo');
        
        modoConexion = true;
        tuberiaConexionTipo = tipoTuberia;
        puntoOrigenConexion = null;
        
        mostrarMensaje(`Modo conexión ${tipoTuberia}. Haz clic en un punto de tubería para iniciar la conexión.`);
        
        // Configurar evento para seleccionar puntos
        map.off('click');
        map.on('click', function(e) {
            manejarClicConexion(e.latlng, tipoTuberia);
        });
    }
    
    // Función para manejar clics en modo conexión
    function manejarClicConexion(latlng, tipoTuberia) {
        // Buscar punto cercano
        let puntoCercano = null;
        let distanciaMinima = Infinity;
        
        puntosTuberias.forEach(punto => {
            const distancia = latlng.distanceTo(punto.latlng);
            if (distancia < 10) { // 10 metros de tolerancia
                if (distancia < distanciaMinima) {
                    distanciaMinima = distancia;
                    puntoCercano = punto;
                }
            }
        });
        
        if (!puntoCercano) {
            mostrarMensaje('No hay un punto de tubería cerca. Haz clic cerca de un punto existente.');
            return;
        }
        
        if (!puntoOrigenConexion) {
            // Primer clic: establecer punto origen
            puntoOrigenConexion = {
                punto: puntoCercano,
                latlng: puntoCercano.latlng
            };
            
            // Resaltar punto
            resaltarPunto(puntoCercano.latlng);
            
            mostrarMensaje('Punto origen seleccionado. Ahora haz clic en otro punto para conectar.');
        } else {
            // Segundo clic: establecer conexión
            if (puntoCercano.latlng.lat === puntoOrigenConexion.latlng.lat && 
                puntoCercano.latlng.lng === puntoOrigenConexion.latlng.lng) {
                mostrarMensaje('No puedes conectar un punto consigo mismo. Selecciona otro punto.');
                return;
            }
            
            // Crear nueva tubería que conecta los dos puntos
            const nuevaTuberia = {
                tipo: tipoTuberia,
                puntoInicio: puntoOrigenConexion.latlng,
                puntoFin: puntoCercano.latlng,
                color: getColorTuberia(tipoTuberia),
                grosor: getGrosorTuberia(tipoTuberia),
                diametro: document.getElementById(`diametro${tipoTuberia.charAt(0).toUpperCase() + tipoTuberia.slice(1)}`).value,
                tipoMaterial: document.getElementById(`tipo${tipoTuberia.charAt(0).toUpperCase() + tipoTuberia.slice(1)}`).value,
                id: Date.now(),
                conexiones: [
                    {
                        tuberiaId: puntoOrigenConexion.punto.tuberiaId,
                        punto: puntoOrigenConexion.punto.esInicio ? 'inicio' : 'fin',
                        latlng: puntoOrigenConexion.latlng
                    },
                    {
                        tuberiaId: puntoCercano.tuberiaId,
                        punto: puntoCercano.esInicio ? 'inicio' : 'fin',
                        latlng: puntoCercano.latlng
                    }
                ],
                esConexion: true
            };
            
            // Dibujar la tubería de conexión
            const linea = dibujarLineaTuberia(nuevaTuberia.puntoInicio, nuevaTuberia.puntoFin, tipoTuberia);
            nuevaTuberia.linea = linea;
            
            // Calcular longitud
            nuevaTuberia.longitud = nuevaTuberia.puntoInicio.distanceTo(nuevaTuberia.puntoFin);
            
            // Añadir etiqueta de longitud
            const centro = L.latLng(
                (nuevaTuberia.puntoInicio.lat + nuevaTuberia.puntoFin.lat) / 2,
                (nuevaTuberia.puntoInicio.lng + nuevaTuberia.puntoFin.lng) / 2
            );
            
            const etiqueta = L.marker(centro, {
                icon: L.divIcon({
                    className: 'tuberia-label',
                    html: `<div style="background: white; padding: 2px 5px; border: 1px solid #ccc; border-radius: 3px; font-size: 10px; font-weight: bold;">
                           ${nuevaTuberia.longitud.toFixed(1)}m</div>`,
                    iconSize: [60, 20],
                    iconAnchor: [30, 10]
                })
            }).addTo(map);
            
            nuevaTuberia.etiquetaLongitud = etiqueta;
            
            // Guardar tubería
            tuberias.push(nuevaTuberia);
            
            // Actualizar las tuberías conectadas
            const tuberiaOrigen = tuberias.find(t => t.id === puntoOrigenConexion.punto.tuberiaId);
            const tuberiaDestino = tuberias.find(t => t.id === puntoCercano.tuberiaId);
            
            if (tuberiaOrigen) {
                if (!tuberiaOrigen.conexiones) tuberiaOrigen.conexiones = [];
                tuberiaOrigen.conexiones.push({
                    tuberiaId: nuevaTuberia.id,
                    punto: 'conexion',
                    latlng: puntoOrigenConexion.latlng
                });
            }
            
            if (tuberiaDestino) {
                if (!tuberiaDestino.conexiones) tuberiaDestino.conexiones = [];
                tuberiaDestino.conexiones.push({
                    tuberiaId: nuevaTuberia.id,
                    punto: 'conexion',
                    latlng: puntoCercano.latlng
                });
            }
            
            // Actualizar resumen
            actualizarResumenTuberias();
            
            // Resetear modo conexión
            modoConexion = false;
            tuberiaConexionTipo = null;
            puntoOrigenConexion = null;
            
            // Quitar clase modo conexión
            const botonId = tipoTuberia === 'principal' ? 'btnConectarPrincipal' : 
                           tipoTuberia === 'secundaria' ? 'btnConectarSecundaria' : 'btnConectarRegante';
            document.getElementById(botonId).classList.remove('modo-conexion-activo');
            
            // Remover eventos
            map.off('click');
            
            // Quitar resaltado
            quitarResaltadoPuntos();
            
            mostrarMensaje(`Conexión establecida entre tuberías. Longitud: ${nuevaTuberia.longitud.toFixed(1)} metros`);
        }
    }
    
    // Función para resaltar punto
    function resaltarPunto(latlng) {
        // Buscar marcador en el mapa y añadir clase de animación
        map.eachLayer(layer => {
            if (layer instanceof L.Marker) {
                const markerLatLng = layer.getLatLng();
                if (markerLatLng && 
                    Math.abs(markerLatLng.lat - latlng.lat) < 0.00001 && 
                    Math.abs(markerLatLng.lng - latlng.lng) < 0.00001) {
                    const icon = layer.getElement();
                    if (icon) {
                        icon.classList.add('punto-activo');
                    }
                }
            }
        });
    }
    
    // Función para quitar resaltado de puntos
    function quitarResaltadoPuntos() {
        map.eachLayer(layer => {
            if (layer instanceof L.Marker) {
                const icon = layer.getElement();
                if (icon) {
                    icon.classList.remove('punto-activo');
                }
            }
        });
    }
    
    // Función actualizada para actualizar resumen de tuberías
    function actualizarResumenTuberias() {
        let totalPrincipal = 0;
        let totalSecundaria = 0;
        let totalRegante = 0;
        
        tuberias.forEach(t => {
            if (t.tipo === 'principal') totalPrincipal += t.longitud || 0;
            if (t.tipo === 'secundaria') totalSecundaria += t.longitud || 0;
            if (t.tipo === 'regante') totalRegante += t.longitud || 0;
        });
        
        document.getElementById('metrosPrincipal').textContent = totalPrincipal.toFixed(2) + ' m';
        document.getElementById('metrosSecundaria').textContent = totalSecundaria.toFixed(2) + ' m';
        document.getElementById('metrosRegante').textContent = totalRegante.toFixed(2) + ' m';
        
        const total = totalPrincipal + totalSecundaria + totalRegante;
        document.getElementById('metrosTotal').textContent = total.toFixed(2) + ' m';
    }
    
    // Configurar eventos de tuberías (viejo sistema - mantener para compatibilidad)
    function configurarEventosTuberias() {
        // Esta función se mantiene para compatibilidad con código existente
        // pero el nuevo sistema usa las funciones anteriores
    }
    
    // Sistema de elementos gráficos tipo "stickers"
    function iniciarModoElemento(tipoElemento) {
        // Desactivar modo tubería si está activo
        if (tuberiaActual) {
            tuberiaActual = null;
            puntoInicioTuberia = null;
            
            // Quitar clase activa de los botones de tubería
            document.querySelectorAll('.tuberia-btn').forEach(btn => {
                btn.classList.remove('activo');
            });
            
            // Ocultar instrucciones de tubería
            document.getElementById('instruccionesPrincipal').style.display = 'none';
            document.getElementById('instruccionesSecundaria').style.display = 'none';
            document.getElementById('instruccionesRegante').style.display = 'none';
        }
        
        // Desactivar modo conexión si está activo
        if (modoConexion) {
            modoConexion = false;
            tuberiaConexionTipo = null;
            puntoOrigenConexion = null;
            
            // Quitar clase modo conexión
            document.querySelectorAll('.tuberia-btn').forEach(btn => {
                btn.classList.remove('modo-conexion-activo');
            });
        }
        
        // Quitar clase active de todos los botones de elemento
        document.querySelectorAll('.elemento-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        
        // Agregar clase active al botón clickeado
        document.querySelector(`.elemento-btn[data-elemento="${tipoElemento}"]`).classList.add('active');
        
        modoAgregarElemento = tipoElemento;
        document.getElementById('instruccionesElementos').style.display = 'block';
        mostrarMensaje(`Modo elemento activado. Haz clic en el mapa para colocar el ${tipoElemento}.`);
    }
    
    function agregarElementoGrafico(latlng, tipo) {
        const iconos = {
            'cabezal': 'fa-water-pump',
            'purgaterminal': 'fa-faucet',
            'tomagua': 'fa-tint',
            'valvula': 'fa-toggle-on',
            'filtro': 'fa-filter'
        };
        
        const colores = {
            'cabezal': '#1772af',
            'purgaterminal': '#ff9f43',
            'tomagua': '#00a553',
            'valvula': '#ff6b6b',
            'filtro': '#4ecdc4'
        };
        
        const elemento = L.marker(latlng, {
            icon: L.divIcon({
                className: 'elemento-grafico',
                html: `<div style="background: ${colores[tipo]}; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                       <i class="fas ${iconos[tipo]}"></i></div>`,
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            }),
            draggable: true
        }).addTo(map);
        
        elemento.bindPopup(`<b>${tipo.toUpperCase()}</b><br>Arrastra para mover`);
        
        // Evento para actualizar posición al arrastrar
        elemento.on('dragend', function(e) {
            const nuevaPos = e.target.getLatLng();
            // Buscar y actualizar el elemento en el array
            const elementoIndex = elementosGraficos.findIndex(e => e.layer === elemento);
            if (elementoIndex !== -1) {
                elementosGraficos[elementoIndex].posicion = nuevaPos;
            }
        });
        
        elementosGraficos.push({
            type: 'elemento',
            layer: elemento,
            tipo: tipo,
            posicion: latlng
        });
        
        // Actualizar configuración del elemento
        actualizarConfiguracionElemento(tipo);
    }
    
    function actualizarConfiguracionElemento(tipo) {
        const configDiv = document.getElementById('elementoConfig');
        let contenido = '';
        
        switch(tipo) {
            case 'cabezal':
                contenido = `
                    <h4>Configuración del Cabezal</h4>
                    <div class="control-row">
                        <div class="control-label">Tipo:</div>
                        <select id="tipoCabezal">
                            <option>Básico</option>
                            <option>Filtración</option>
                            <option>Fertirriego</option>
                            <option>Automático</option>
                        </select>
                    </div>
                    <div class="control-row">
                        <div class="control-label">Bombas:</div>
                        <input type="number" id="bombasCabezal" min="1" max="3" value="1">
                    </div>
                    <div class="control-row">
                        <div class="control-label">Potencia:</div>
                        <input type="number" id="potenciaCabezal" min="1" max="100" value="10"> HP
                    </div>
                `;
                break;
                
            case 'purgaterminal':
                contenido = `
                    <h4>Configuración de Purgas/Terminales</h4>
                    <div class="control-row">
                        <div class="control-label">Cantidad:</div>
                        <input type="number" id="cantidadPurgas" min="1" max="20" value="4">
                    </div>
                    <div class="control-row">
                        <div class="control-label">Tipo:</div>
                        <select id="tipoPurgas">
                            <option>Automática</option>
                            <option>Manual</option>
                        </select>
                    </div>
                    <div class="control-row">
                        <div class="control-label">Diámetro:</div>
                        <select id="diametroPurgas">
                            <option>1"</option>
                            <option>1.5"</option>
                            <option>2"</option>
                        </select>
                    </div>
                `;
                break;
                
            case 'tomagua':
                contenido = `
                    <h4>Configuración de Toma de Agua</h4>
                    <div class="control-row">
                        <div class="control-label">Diámetro:</div>
                        <select id="diametroToma">
                            <option>2"</option>
                            <option>3"</option>
                            <option>4"</option>
                            <option>6"</option>
                        </select>
                    </div>
                    <div class="control-row">
                        <div class="control-label">Profundidad:</div>
                        <input type="number" id="profundidadToma" min="0.5" max="5" value="1.2" step="0.1"> m
                    </div>
                    <div class="control-row">
                        <div class="control-label">Caudal:</div>
                        <input type="number" id="caudalToma" min="1" max="1000" value="50" step="5"> L/s
                    </div>
                `;
                break;
                
            case 'valvula':
                contenido = `
                    <h4>Configuración de Válvula</h4>
                    <div class="control-row">
                        <div class="control-label">Tipo:</div>
                        <select id="tipoValvula">
                            <option>Manual</option>
                            <option>Automática</option>
                            <option>Electroválvula</option>
                        </select>
                    </div>
                    <div class="control-row">
                        <div class="control-label">Diámetro:</div>
                        <select id="diametroValvula">
                            <option>1"</option>
                            <option>2"</option>
                            <option>3"</option>
                            <option>4"</option>
                        </select>
                    </div>
                    <div class="control-row">
                        <div class="control-label">Presión:</div>
                        <input type="number" id="presionValvula" min="1" max="10" value="3" step="0.5"> bar
                    </div>
                `;
                break;
                
            case 'filtro':
                contenido = `
                    <h4>Configuración de Filtro</h4>
                    <div class="control-row">
                        <div class="control-label">Tipo:</div>
                        <select id="tipoFiltro">
                            <option>Anillas</option>
                            <option>Arena</option>
                            <option>Malla</option>
                            <option>Hidrociclón</option>
                        </select>
                    </div>
                    <div class="control-row">
                        <div class="control-label">Diámetro:</div>
                        <select id="diametroFiltro">
                            <option>2"</option>
                            <option>3"</option>
                            <option>4"</option>
                        </select>
                    </div>
                    <div class="control-row">
                        <div class="control-label">Capacidad:</div>
                        <input type="number" id="capacidadFiltro" min="10" max="500" value="100" step="10"> m³/h
                    </div>
                `;
                break;
                
            default:
                contenido = `<p>Selecciona un elemento para configurarlo</p>`;
        }
        
        configDiv.innerHTML = contenido;
    }
    
    // Sistema de guardado/exportación/importación
    function guardarDiseño(nombre = null) {
        if (!nombre) {
            nombre = prompt('Nombre del diseño:', `Diseño_${new Date().toLocaleDateString()}`);
            if (!nombre) return;
        }
        
        const diseño = {
            id: Date.now(),
            nombre: nombre,
            fecha: new Date().toISOString(),
            area: areaTotal,
            tuberias: tuberias.map(t => ({
                tipo: t.tipo,
                puntoInicio: t.puntoInicio ? [t.puntoInicio.lat, t.puntoInicio.lng] : null,
                puntoFin: t.puntoFin ? [t.puntoFin.lat, t.puntoFin.lng] : null,
                longitud: t.longitud || 0,
                color: t.color,
                grosor: t.grosor,
                diametro: t.diametro,
                tipoMaterial: t.tipoMaterial,
                conexiones: t.conexiones || [],
                esConexion: t.esConexion || false
            })),
            elementos: elementosGraficos.filter(e => e.type === 'elemento').map(e => ({
                tipo: e.tipo,
                posicion: [e.posicion.lat, e.posicion.lng]
            })),
            secciones: secciones,
            puntosTuberias: puntosTuberias.map(p => ({
                tipo: p.tipo,
                latlng: [p.latlng.lat, p.latlng.lng],
                tuberiaId: p.tuberiaId,
                esInicio: p.esInicio
            }))
        };
        
        // Guardar en localStorage
        diseñosGuardados = JSON.parse(localStorage.getItem('diseñosRiego') || '[]');
        diseñosGuardados.push(diseño);
        localStorage.setItem('diseñosRiego', JSON.stringify(diseñosGuardados));
        
        mostrarMensaje(`Diseño "${nombre}" guardado correctamente`);
        actualizarGaleriaDiseños();
        
        return diseño;
    }
    
    function exportarDiseño() {
        const diseño = guardarDiseño('Exportado_' + Date.now());
        
        // Crear JSON para descargar
        const dataStr = JSON.stringify(diseño, null, 2);
        const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
        
        const exportFileDefaultName = `diseño_riego_${Date.now()}.json`;
        
        const linkElement = document.createElement('a');
        linkElement.setAttribute('href', dataUri);
        linkElement.setAttribute('download', exportFileDefaultName);
        linkElement.click();
        
        mostrarMensaje('Diseño exportado como JSON');
    }
    
    function importarDiseño(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const diseño = JSON.parse(e.target.result);
                cargarDiseño(diseño);
                mostrarMensaje(`Diseño "${diseño.nombre}" importado correctamente`);
            } catch (error) {
                alert('Error al importar el diseño: ' + error.message);
            }
        };
        reader.readAsText(file);
    }
    
    function cargarDiseño(diseño) {
        // Limpiar mapa actual
        limpiarDiseño();
        
        // Restaurar puntos de tuberías primero
        if (diseño.puntosTuberias) {
            puntosTuberias = diseño.puntosTuberias.map(p => ({
                tipo: p.tipo,
                latlng: L.latLng(p.latlng[0], p.latlng[1]),
                tuberiaId: p.tuberiaId,
                esInicio: p.esInicio
            }));
        }
        
        // Cargar tuberías
        if (diseño.tuberias) {
            diseño.tuberias.forEach(tData => {
                if (tData.puntoInicio && tData.puntoFin) {
                    const puntoInicio = L.latLng(tData.puntoInicio[0], tData.puntoInicio[1]);
                    const puntoFin = L.latLng(tData.puntoFin[0], tData.puntoFin[1]);
                    
                    // Crear marcadores
                    const marcadorInicio = crearMarcadorTuberia(puntoInicio, 'inicio', tData.tipo);
                    marcadorInicio.addTo(map);
                    
                    const marcadorFin = crearMarcadorTuberia(puntoFin, 'fin', tData.tipo);
                    marcadorFin.addTo(map);
                    
                    // Dibujar línea
                    const linea = dibujarLineaTuberia(puntoInicio, puntoFin, tData.tipo);
                    
                    // Añadir etiqueta de longitud
                    const centro = L.latLng(
                        (puntoInicio.lat + puntoFin.lat) / 2,
                        (puntoInicio.lng + puntoFin.lng) / 2
                    );
                    
                    const etiqueta = L.marker(centro, {
                        icon: L.divIcon({
                            className: 'tuberia-label',
                            html: `<div style="background: white; padding: 2px 5px; border: 1px solid #ccc; border-radius: 3px; font-size: 10px; font-weight: bold;">
                                   ${tData.longitud.toFixed(1)}m</div>`,
                            iconSize: [60, 20],
                            iconAnchor: [30, 10]
                        })
                    }).addTo(map);
                    
                    // Guardar tubería
                    const tuberia = {
                        id: tData.id || Date.now() + Math.random(),
                        tipo: tData.tipo,
                        puntoInicio: puntoInicio,
                        puntoFin: puntoFin,
                        color: tData.color,
                        grosor: tData.grosor,
                        diametro: tData.diametro,
                        tipoMaterial: tData.tipoMaterial,
                        longitud: tData.longitud,
                        conexiones: tData.conexiones || [],
                        esConexion: tData.esConexion || false,
                        marcadorInicio: marcadorInicio,
                        marcadorFin: marcadorFin,
                        linea: linea,
                        etiquetaLongitud: etiqueta
                    };
                    
                    tuberias.push(tuberia);
                }
            });
        }
        
        // Cargar elementos
        if (diseño.elementos) {
            diseño.elementos.forEach(eData => {
                agregarElementoGrafico(L.latLng(eData.posicion[0], eData.posicion[1]), eData.tipo);
            });
        }
        
        // Cargar área y secciones
        if (diseño.area) {
            areaTotal = diseño.area;
            document.getElementById('areaDisplay').textContent = 
                `Área: ${areaTotal.toFixed(2)} m² (${(areaTotal / 10000).toFixed(2)} ha)`;
        }
        
        if (diseño.secciones) {
            secciones = diseño.secciones;
            generarSeccionesDesdeDatos();
        }
        
        actualizarResumenTuberias();
        actualizarCalculos();
        
        // Ocultar controles si hay área definida
        if (areaTotal > 0) {
            ocultarControlesMapa();
        }
    }
    
    function limpiarDiseño() {
        // Limpiar tuberías
        tuberias.forEach(t => {
            if (t.marcadorInicio) map.removeLayer(t.marcadorInicio);
            if (t.marcadorFin) map.removeLayer(t.marcadorFin);
            if (t.linea) map.removeLayer(t.linea);
            if (t.etiquetaLongitud) map.removeLayer(t.etiquetaLongitud);
        });
        tuberias = [];
        
        // Limpiar puntos
        puntosTuberias = [];
        
        // Limpiar elementos gráficos
        elementosGraficos.forEach(e => map.removeLayer(e.layer));
        elementosGraficos = [];
        
        // Limpiar área
        drawnItems.clearLayers();
        areaTotal = 0;
        document.getElementById('areaDisplay').textContent = 'Área: 0 m²';
        
        // Resetear secciones
        secciones = {};
        seccionActual = null;
        inicializarSecciones();
        
        // Resetear cálculos
        actualizarResumenTuberias();
        actualizarCalculos();
        
        // Mostrar controles
        mostrarControlesMapa();
        
        // Resetear modo de dibujo
        modoDibujoTuberia = null;
        tuberiaActual = null;
        puntoInicioTuberia = null;
        modoAgregarElemento = null;
        
        // Resetear modo conexión
        modoConexion = false;
        tuberiaConexionTipo = null;
        puntoOrigenConexion = null;
        
        // Quitar clases activas
        document.querySelectorAll('.tuberia-btn').forEach(btn => {
            btn.classList.remove('activo');
            btn.classList.remove('modo-conexion-activo');
        });
        
        document.querySelectorAll('.elemento-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        
        // Ocultar instrucciones
        document.getElementById('instruccionesPrincipal').style.display = 'none';
        document.getElementById('instruccionesSecundaria').style.display = 'none';
        document.getElementById('instruccionesRegante').style.display = 'none';
        document.getElementById('instruccionesElementos').style.display = 'none';
        
        // Quitar resaltado de puntos
        quitarResaltadoPuntos();
    }
    
    // Funciones para la galería
    function actualizarGaleriaDiseños() {
        const galeriaDiv = document.getElementById('galeriaDiseños');
        diseñosGuardados = JSON.parse(localStorage.getItem('diseñosRiego') || '[]');
        
        if (diseñosGuardados.length === 0) {
            galeriaDiv.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No hay diseños guardados</p>';
            return;
        }
        
        // Ordenar por fecha (más reciente primero)
        diseñosGuardados.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
        
        let html = '<div class="diseños-lista">';
        
        diseñosGuardados.forEach((diseño, index) => {
            const fecha = new Date(diseño.fecha).toLocaleDateString();
            const hora = new Date(diseño.fecha).toLocaleTimeString();
            html += `
                <div class="diseño-item" style="background: #f8f9fa; padding: 15px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #eee;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>${diseño.nombre}</strong><br>
                            <small style="color: #666;">${fecha} ${hora} | Área: ${diseño.area ? diseño.area.toFixed(2) + ' m²' : 'No definida'}</small><br>
                            <small style="color: #666;">Tuberías: ${diseño.tuberias ? diseño.tuberias.length : 0} | Elementos: ${diseño.elementos ? diseño.elementos.length : 0}</small>
                        </div>
                        <div>
                            <button class="mapa-btn" onclick="cargarDiseño(${JSON.stringify(diseño).replace(/"/g, '&quot;')})" 
                                    style="padding: 5px 10px; font-size: 0.8rem; margin-right: 5px;">
                                <i class="fas fa-edit"></i> Abrir
                            </button>
                            <button class="mapa-btn secondary" onclick="eliminarDiseño(${index})" 
                                    style="padding: 5px 10px; font-size: 0.8rem;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
        galeriaDiv.innerHTML = html;
    }
    
    function eliminarDiseño(index) {
        if (confirm('¿Eliminar este diseño?')) {
            diseñosGuardados.splice(index, 1);
            localStorage.setItem('diseñosRiego', JSON.stringify(diseñosGuardados));
            actualizarGaleriaDiseños();
            mostrarMensaje('Diseño eliminado');
        }
    }
    
    // Función para generar secciones desde datos cargados
    function generarSeccionesDesdeDatos() {
        const seccionesGrid = document.getElementById('seccionesGrid');
        seccionesGrid.innerHTML = '';
        
        for (const codigo in secciones) {
            const seccionElement = document.createElement('div');
            seccionElement.className = 'seccion-item';
            seccionElement.textContent = codigo;
            seccionElement.dataset.seccion = codigo;
            
            seccionElement.addEventListener('click', function() {
                seleccionarSeccion(codigo);
            });
            
            seccionesGrid.appendChild(seccionElement);
        }
        
        // Seleccionar primera sección si existe
        if (Object.keys(secciones).length > 0) {
            seleccionarSeccion(Object.keys(secciones)[0]);
        }
    }
    
    // Función para mostrar mensajes temporales
    function mostrarMensaje(mensaje) {
        // Crear o actualizar elemento de mensaje
        let mensajeDiv = document.getElementById('mensajeTemporal');
        if (!mensajeDiv) {
            mensajeDiv = document.createElement('div');
            mensajeDiv.id = 'mensajeTemporal';
            mensajeDiv.style.cssText = `
                position: fixed;
                top: 100px;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(0, 0, 0, 0.8);
                color: white;
                padding: 10px 20px;
                border-radius: 5px;
                z-index: 10000;
                font-size: 0.9rem;
                pointer-events: none;
            `;
            document.body.appendChild(mensajeDiv);
        }
        
        mensajeDiv.textContent = mensaje;
        mensajeDiv.style.display = 'block';
        
        // Ocultar después de 3 segundos
        setTimeout(() => {
            mensajeDiv.style.display = 'none';
        }, 3000);
    }
    
    // DOMContentLoaded
    document.addEventListener('DOMContentLoaded', function() {
        // Inicializar el mapa inmediatamente
        initMap();
        
        const mobileMenuBtn = document.getElementById('mobileMenuBtn');
        const mainNav = document.getElementById('mainNav');
        const mainHeader = document.getElementById('mainHeader');
        
        // Menú móvil
        mobileMenuBtn.addEventListener('click', function() {
            mainNav.classList.toggle('active');
            
            const icon = mobileMenuBtn.querySelector('i');
            if (mainNav.classList.contains('active')) {
                icon.classList.remove('fa-bars');
                icon.classList.add('fa-times');
                document.body.style.overflow = 'hidden';
            } else {
                icon.classList.remove('fa-times');
                icon.classList.add('fa-bars');
                document.body.style.overflow = '';
            }
        });
        
        // Cerrar menú al hacer clic en un enlace
        const navLinks = document.querySelectorAll('#mainNav a');
        navLinks.forEach(link => {
            link.addEventListener('click', function() {
                mainNav.classList.remove('active');
                mobileMenuBtn.querySelector('i').classList.remove('fa-times');
                mobileMenuBtn.querySelector('i').classList.add('fa-bars');
                document.body.style.overflow = '';
            });
        });
        
        // Header scroll effect
        window.addEventListener('scroll', function() {
            if (window.scrollY > 50) {
                mainHeader.classList.add('scrolled');
            } else {
                mainHeader.classList.remove('scrolled');
            }
        });
        
        // Animaciones al hacer scroll
        const observerOptions = {
            threshold: 0.1,
            rootMargin: '0px 0px -50px 0px'
        };
        
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('visible');
                }
            });
        }, observerOptions);
        
        // Observar elementos con clase fade-in
        document.querySelectorAll('.fade-in').forEach(el => {
            observer.observe(el);
        });
        
        // Smooth scroll para enlaces internos
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function(e) {
                const href = this.getAttribute('href');
                if (href !== '#' && !href.includes('.html')) {
                    e.preventDefault();
                    const targetElement = document.querySelector(href);
                    if (targetElement) {
                        window.scrollTo({
                            top: targetElement.offsetTop - 100,
                            behavior: 'smooth'
                        });
                    }
                }
            });
        });
        
        // Controladores para el diseñador de riego
        
        // Botón de búsqueda
        document.getElementById('searchBtn').addEventListener('click', buscarUbicacion);
        
        // Buscar al presionar Enter
        document.getElementById('location-search').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                buscarUbicacion();
            }
        });
        
        // Botón para delimitar terreno
        document.getElementById('drawPolygonBtn').addEventListener('click', function() {
            // Desactivar cualquier modo de dibujo actual
            if (currentDrawMode) {
                currentDrawMode.disable();
            }
            
            // Desactivar modo tubería si está activo
            if (tuberiaActual) {
                tuberiaActual = null;
                puntoInicioTuberia = null;
                
                // Quitar clase activa de los botones de tubería
                document.querySelectorAll('.tuberia-btn').forEach(btn => {
                    btn.classList.remove('activo');
                });
                
                // Ocultar instrucciones de tubería
                document.getElementById('instruccionesPrincipal').style.display = 'none';
                document.getElementById('instruccionesSecundaria').style.display = 'none';
                document.getElementById('instruccionesRegante').style.display = 'none';
            }
            
            // Desactivar modo elemento si está activo
            if (modoAgregarElemento) {
                modoAgregarElemento = null;
                document.getElementById('instruccionesElementos').style.display = 'none';
                
                // Quitar clase active de los botones de elemento
                document.querySelectorAll('.elemento-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
            }
            
            // Desactivar modo conexión si está activo
            if (modoConexion) {
                modoConexion = false;
                tuberiaConexionTipo = null;
                puntoOrigenConexion = null;
                
                // Quitar clase modo conexión
                document.querySelectorAll('.tuberia-btn').forEach(btn => {
                    btn.classList.remove('modo-conexion-activo');
                });
            }
            
            // Activar modo dibujo de polígono
            currentDrawMode = new L.Draw.Polygon(map, drawControl.options.draw.polygon);
            currentDrawMode.enable();
            
            // Mostrar botón para ocultar controles
            document.getElementById('hideControlsBtn').style.display = 'block';
            
            // Cambiar texto del botón
            this.innerHTML = '<i class="fas fa-hand-pointer"></i> Click para dibujar';
            this.style.backgroundColor = '#ff6b6b';
            
            // Restaurar botón después de 5 segundos
            setTimeout(() => {
                this.innerHTML = '<i class="fas fa-draw-polygon"></i> Delimitar Terreno';
                this.style.backgroundColor = '';
            }, 5000);
            
            mostrarMensaje('Haz clic en el mapa para iniciar el polígono. Doble clic para finalizar.');
        });
        
        // Botón para medir
        document.getElementById('measureBtn').addEventListener('click', function() {
            // Desactivar cualquier modo de dibujo actual
            if (currentDrawMode) {
                currentDrawMode.disable();
            }
            
            // Desactivar modo tubería si está activo
            if (tuberiaActual) {
                tuberiaActual = null;
                puntoInicioTuberia = null;
                
                // Quitar clase activa de los botones de tubería
                document.querySelectorAll('.tuberia-btn').forEach(btn => {
                    btn.classList.remove('activo');
                });
                
                // Ocultar instrucciones de tubería
                document.getElementById('instruccionesPrincipal').style.display = 'none';
                document.getElementById('instruccionesSecundaria').style.display = 'none';
                document.getElementById('instruccionesRegante').style.display = 'none';
            }
            
            // Desactivar modo elemento si está activo
            if (modoAgregarElemento) {
                modoAgregarElemento = null;
                document.getElementById('instruccionesElementos').style.display = 'none';
                
                // Quitar clase active de los botones de elemento
                document.querySelectorAll('.elemento-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
            }
            
            // Desactivar modo conexión si está activo
            if (modoConexion) {
                modoConexion = false;
                tuberiaConexionTipo = null;
                puntoOrigenConexion = null;
                
                // Quitar clase modo conexión
                document.querySelectorAll('.tuberia-btn').forEach(btn => {
                    btn.classList.remove('modo-conexion-activo');
                });
            }
            
            // Activar modo dibujo de polilínea
            currentDrawMode = new L.Draw.Polyline(map, drawControl.options.draw.polyline);
            currentDrawMode.enable();
            
            // Cambiar texto del botón
            this.innerHTML = '<i class="fas fa-hand-pointer"></i> Click para medir';
            this.style.backgroundColor = '#ff6b6b';
            
            // Restaurar botón después de 5 segundos
            setTimeout(() => {
                this.innerHTML = '<i class="fas fa-ruler"></i> Medir';
                this.style.backgroundColor = '';
            }, 5000);
            
            mostrarMensaje('Haz clic en el mapa para iniciar la medición. Doble clic para finalizar.');
        });
        
        // Botón para limpiar
        document.getElementById('clearBtn').addEventListener('click', function() {
            limpiarDiseño();
            mostrarMensaje('Diseño limpiado completamente');
        });
        
        // Botón para ocultar controles
        document.getElementById('hideControlsBtn').addEventListener('click', function() {
            ocultarControlesMapa();
            mostrarMensaje('Controles ocultados');
        });
        
        // Botón para mostrar controles
        document.getElementById('showControlsBtn').addEventListener('click', function() {
            mostrarControlesMapa();
            mostrarMensaje('Controles mostrados');
        });
        
        // Pestañas CAD
        document.querySelectorAll('.cad-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                const tabId = this.dataset.tab;
                
                // Remover clase active de todas las pestañas
                document.querySelectorAll('.cad-tab').forEach(t => {
                    t.classList.remove('active');
                });
                
                // Agregar clase active a la pestaña clickeada
                this.classList.add('active');
                
                // Ocultar todos los contenidos
                document.querySelectorAll('.cad-tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                
                // Mostrar el contenido correspondiente
                document.getElementById(tabId + '-tab').classList.add('active');
            });
        });
        
        // Botones para dibujar tuberías
        document.getElementById('btnTuberiaPrincipal').addEventListener('click', function() {
            iniciarModoTuberia('principal');
        });
        
        document.getElementById('btnTuberiaSecundaria').addEventListener('click', function() {
            iniciarModoTuberia('secundaria');
        });
        
        document.getElementById('btnTuberiaRegante').addEventListener('click', function() {
            iniciarModoTuberia('regante');
        });
        
        // Botones para conectar tuberías
        document.getElementById('btnConectarPrincipal').addEventListener('click', function() {
            iniciarModoConexion('principal');
        });
        
        document.getElementById('btnConectarSecundaria').addEventListener('click', function() {
            iniciarModoConexion('secundaria');
        });
        
        document.getElementById('btnConectarRegante').addEventListener('click', function() {
            iniciarModoConexion('regante');
        });
        
        // Elementos del diseño
        document.querySelectorAll('.elemento-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                // Remover clase active de todos los botones
                document.querySelectorAll('.elemento-btn').forEach(b => {
                    b.classList.remove('active');
                });
                
                // Agregar clase active al botón clickeado
                this.classList.add('active');
                
                selectedElement = this.dataset.elemento;
                actualizarConfiguracionElemento(selectedElement);
            });
        });
        
        // Eventos para cálculos de emisores
        document.getElementById('caudalEmisor').addEventListener('input', calcularEmisores);
        document.getElementById('separacionEmisor').addEventListener('input', calcularEmisores);
        document.getElementById('separacionSurco').addEventListener('input', calcularEmisores);
        document.getElementById('tipoEmisor').addEventListener('change', function() {
            // Cambiar valores por defecto según tipo de emisor
            const tipo = this.value;
            const caudalInput = document.getElementById('caudalEmisor');
            const separacionInput = document.getElementById('separacionEmisor');
            
            switch(tipo) {
                case 'goteo':
                    caudalInput.value = 4;
                    separacionInput.value = 0.5;
                    break;
                case 'aspersion':
                    caudalInput.value = 30;
                    separacionInput.value = 12;
                    break;
                case 'microaspersion':
                    caudalInput.value = 15;
                    separacionInput.value = 4;
                    break;
            }
            
            calcularEmisores();
        });
        
        // Cargar galería de diseños
        actualizarGaleriaDiseños();
        
        // Inicializar configuración de elemento
        actualizarConfiguracionElemento('cabezal');
    });
</script>
</body>
</html>