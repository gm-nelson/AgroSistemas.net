<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asesoría Técnica - Agrosistemas</title>
    <link rel="icon" type="image/webp" href="favicon.webp">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Leaflet CSS (OpenStreetMap) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    <!-- Leaflet Draw CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>
    <!-- jsPDF para exportación a PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* Reset y estilos base */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }
        
        body {
            color: #333;
            line-height: 1.6;
            background-color: #FFFFFF;
        }
        
        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        a {
            text-decoration: none;
            color: inherit;
        }
        
        ul {
            list-style: none;
        }
        
        .btn {
            display: inline-block;
            background-color: #00a553;
            color: white;
            padding: 14px 32px;
            border-radius: 50px;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            letter-spacing: 0.5px;
        }
        
        .btn:hover {
            background-color: #008a45;
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 165, 83, 0.3);
        }
        
        .btn-secondary {
            background-color: #1772af;
        }
        
        .btn-secondary:hover {
            background-color: #145c92;
            box-shadow: 0 8px 20px rgba(23, 114, 175, 0.3);
        }
        
        .section-title {
            text-align: center;
            margin-bottom: 50px;
            color: #111;
            font-size: 2.4rem;
            font-weight: 700;
        }
        
        /* Header */
        header {
            background-color: #FFFFFF;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 1000;
            transition: all 0.3s ease;
        }
        
        header.scrolled {
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.08);
        }
        
        .main-header {
            padding: 20px 0;
        }
        
        .main-header .container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            height: 100px;
            display: flex;
            align-items: center;
        }
        
        .logo img {
            height: 100px;
            width: auto;
        }
        
        .mobile-menu-btn {
            display: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #111;
            background: none;
            border: none;
            padding: 5px;
        }
        
        /* Hero Section - Específico para Asesoría Técnica */
        .page-hero {
            background: linear-gradient(135deg, rgba(0, 165, 83, 0.9) 0%, rgba(23, 114, 175, 0.9) 100%);
            color: white;
            padding: 160px 0 80px;
            text-align: center;
            margin-top: 80px;
        }
        
        .page-hero h1 {
            font-size: 3.5rem;
            margin-bottom: 20px;
            font-weight: 700;
            line-height: 1.1;
        }
        
        .page-hero p {
            font-size: 1.3rem;
            max-width: 800px;
            margin: 0 auto 40px;
            opacity: 0.9;
        }
        
        /* Servicios Detallados */
        .servicios-detalle {
            padding: 100px 0;
            background-color: #FFFFFF;
        }
        
        .servicios-grid-detalle {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 40px;
        }
        
        .servicio-detalle-card {
            background-color: #FFFFFF;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 5px 25px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
            border: 1px solid #f0f0f0;
            height: 100%;
        }
        
        .servicio-detalle-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.1);
            border-color: #00a553;
        }
        
        .servicio-detalle-icon {
            background-color: #f8f9fa;
            height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: #00a553;
        }
        
        .servicio-detalle-content {
            padding: 30px;
        }
        
        .servicio-detalle-content h3 {
            margin-bottom: 15px;
            color: #111;
            font-size: 1.6rem;
        }
        
        .servicio-detalle-content p {
            color: #666;
            line-height: 1.7;
            margin-bottom: 20px;
        }
        
        .servicio-beneficios {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .servicio-beneficios h4 {
            color: #1772af;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }
        
        .servicio-beneficios ul {
            list-style: disc;
            padding-left: 20px;
            color: #666;
        }
        
        .servicio-beneficios li {
            margin-bottom: 8px;
        }
        
        /* Diseñador de Riego CAD */
        .disenador-riego {
            padding: 100px 0;
            background-color: #f8f9fa;
        }
        
        .disenador-intro {
            text-align: center;
            max-width: 800px;
            margin: 0 auto 40px;
            color: #666;
            font-size: 1.1rem;
        }
        
        .disenador-grid {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 30px;
            height: 700px;
        }
        
        @media (max-width: 992px) {
            .disenador-grid {
                grid-template-columns: 1fr;
                height: auto;
            }
        }
        
        /* Panel del Mapa */
        .mapa-panel {
            background-color: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        .mapa-header {
            padding: 20px;
            background-color: #1772af;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .mapa-header h3 {
            font-size: 1.3rem;
            margin: 0;
        }
        
        .mapa-container {
            flex: 1;
            position: relative;
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        .mapa-controls {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1000;
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.1);
            width: 300px;
        }
        
        .search-container {
            margin-bottom: 15px;
        }
        
        #location-search {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        .mapa-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .mapa-btn {
            background-color: #00a553;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            flex: 1;
            min-width: 120px;
        }
        
        .mapa-btn:hover {
            background-color: #008a45;
        }
        
        .mapa-btn.secondary {
            background-color: #1772af;
        }
        
        .mapa-btn.secondary:hover {
            background-color: #145c92;
        }
        
        .area-display {
            background-color: rgba(0,0,0,0.7);
            color: white;
            padding: 10px 15px;
            border-radius: 4px;
            margin-top: 10px;
            font-size: 0.9rem;
        }
        
        /* Panel de Diseño CAD */
        .cad-panel {
            background-color: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        .cad-header {
            padding: 20px;
            background-color: #00a553;
            color: white;
        }
        
        .cad-header h3 {
            font-size: 1.3rem;
            margin: 0 0 10px 0;
        }
        
        .cad-header p {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .cad-tabs {
            display: flex;
            background-color: #f0f0f0;
            border-bottom: 1px solid #ddd;
        }
        
        .cad-tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
        }
        
        .cad-tab.active {
            background-color: white;
            color: #00a553;
            border-bottom: 3px solid #00a553;
        }
        
        .cad-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        .cad-tab-content {
            display: none;
        }
        
        .cad-tab-content.active {
            display: block;
        }
        
        .cad-controls {
            margin-bottom: 20px;
        }
        
        .control-group {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .control-group h4 {
            margin-bottom: 10px;
            color: #333;
            font-size: 1.1rem;
        }
        
        .control-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .control-label {
            width: 120px;
            font-size: 0.9rem;
            color: #666;
        }
        
        select, input[type="number"], input[type="text"], textarea {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        .color-indicator {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 10px;
        }
        
        /* Colores para tipos de tubería */
        .color-principal {
            background-color: #ff6b6b;
        }
        
        .color-secundaria {
            background-color: #4ecdc4;
        }
        
        .color-regante {
            background-color: #45b7d1;
        }
        
        .elementos-lista {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        
        .elemento-btn {
            background-color: #f0f0f0;
            border: 1px solid #ddd;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s;
        }
        
        .elemento-btn:hover {
            background-color: #e0e0e0;
        }
        
        .elemento-btn.active {
            background-color: #00a553;
            color: white;
            border-color: #00a553;
        }
        
        .cad-resumen {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .cad-resumen h4 {
            margin-bottom: 10px;
            color: #1772af;
        }
        
        .resumen-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }
        
        .secciones-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .seccion-item {
            background-color: #f0f0f0;
            padding: 10px;
            border-radius: 4px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .seccion-item:hover {
            background-color: #e0e0e0;
        }
        
        .seccion-item.active {
            background-color: #00a553;
            color: white;
        }
        
        .seccion-config {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }
        
        /* Panel de Emisores */
        .emisor-panel {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .emisor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .emisor-header h4 {
            color: #333;
            margin: 0;
        }
        
        .emisor-info {
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
            border: 1px solid #eee;
        }
        
        /* Contacto */
        .contacto {
            padding: 100px 0;
            background-color: #FFFFFF;
        }
        
        .contacto-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 50px;
        }
        
        .contact-info-card {
            background-color: #FFFFFF;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.05);
            border: 1px solid #f0f0f0;
        }
        
        .contact-info-card h3 {
            margin-bottom: 30px;
            color: #111;
            font-size: 1.8rem;
        }
        
        .contact-item {
            display: flex;
            align-items: center;
            margin-bottom: 25px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .contact-item:hover {
            background-color: #e8f4fd;
            transform: translateX(5px);
        }
        
        .contact-icon {
            background-color: #1772af;
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            flex-shrink: 0;
            font-size: 1.2rem;
        }
        
        .contact-text h4 {
            margin-bottom: 5px;
            color: #111;
            font-size: 1.1rem;
        }
        
        .contact-text a {
            color: #1772af;
            transition: color 0.3s;
            font-weight: 500;
        }
        
        .contact-text a:hover {
            color: #00a553;
        }
        
        .contact-text p {
            color: #666;
            font-size: 0.95rem;
        }
        
        .map-container {
            height: 400px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .map-container iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        
        /* Footer */
        footer {
            background-color: #FFFFFF;
            color: #333;
            padding: 60px 0 30px;
            text-align: center;
            border-top: 1px solid #f0f0f0;
        }
        
        .footer-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 30px;
        }
        
        .footer-logo {
            margin-bottom: 10px;
        }
        
        .footer-logo img {
            height: 100px;
            width: auto;
        }
        
        .footer-text {
            color: #666;
            max-width: 600px;
            margin: 0 auto;
            line-height: 1.7;
        }
        
        .copyright {
            padding-top: 30px;
            border-top: 1px solid #f0f0f0;
            font-size: 0.9rem;
            color: #888;
            width: 100%;
            margin-top: 20px;
        }
        
        /* Responsive */
        @media (max-width: 992px) {
            .page-hero h1 {
                font-size: 2.8rem;
            }
            
            .section-title {
                font-size: 2.2rem;
            }
        }
        
        @media (max-width: 768px) {
            .mobile-menu-btn {
                display: block;
            }
            
            nav {
                position: fixed;
                top: 0;
                right: -100%;
                width: 280px;
                height: 100vh;
                background-color: #FFFFFF;
                box-shadow: -5px 0 25px rgba(0,0,0,0.1);
                transition: right 0.3s;
                z-index: 1001;
                padding: 90px 30px 30px;
            }
            
            nav.active {
                right: 0;
            }
            
            nav ul {
                flex-direction: column;
                gap: 20px;
            }
            
            nav ul li a {
                font-weight: 600;
                color: #111;
                font-size: 1.1rem;
                display: block;
                padding: 10px 0;
            }
            
            .page-hero {
                padding: 140px 0 60px;
                margin-top: 80px;
            }
            
            .page-hero h1 {
                font-size: 2.4rem;
            }
            
            .page-hero p {
                font-size: 1.1rem;
            }
            
            .section-title {
                font-size: 2rem;
                margin-bottom: 40px;
            }
            
            .servicios-detalle, .disenador-riego, .contacto {
                padding: 70px 0;
            }
            
            .contact-item {
                flex-direction: column;
                text-align: center;
            }
            
            .contact-icon {
                margin-right: 0;
                margin-bottom: 15px;
            }
        }
        
        @media (max-width: 480px) {
            .page-hero h1 {
                font-size: 2rem;
            }
            
            .page-hero p {
                font-size: 1rem;
            }
            
            .servicios-grid-detalle {
                grid-template-columns: 1fr;
            }
        }
        
        /* Estilos de navegación */
        nav ul {
            display: flex;
            gap: 35px;
        }
        
        nav ul li a {
            font-weight: 600;
            color: #111;
            padding: 8px 0;
            position: relative;
            font-size: 1rem;
            transition: color 0.3s;
        }
        
        nav ul li a:hover {
            color: #00a553;
        }
        
        nav ul li a:after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 0;
            height: 2px;
            background-color: #00a553;
            transition: width 0.3s;
        }
        
        nav ul li a:hover:after {
            width: 100%;
        }
        
        .current-page {
            color: #00a553 !important;
        }
        
        .current-page:after {
            width: 100% !important;
        }
        
        /* Scroll suave */
        html {
            scroll-behavior: smooth;
        }
        
        /* Animaciones */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .fade-in {
            opacity: 0;
            animation: fadeInUp 0.6s ease forwards;
        }
        
        .fade-in.delay-1 {
            animation-delay: 0.2s;
        }
        
        .fade-in.delay-2 {
            animation-delay: 0.4s;
        }

        /* Estilos adicionales para el sistema CAD mejorado */
        .tuberia-label {
            pointer-events: none !important;
        }

        .elemento-grafico {
            cursor: move !important;
        }

        .diseños-lista {
            max-height: 300px;
            overflow-y: auto;
        }

        .diseño-item:hover {
            background-color: #e8f4fd !important;
            border-color: #00a553 !important;
        }

        .galeria-acciones {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        .galeria-acciones .btn {
            padding: 10px 15px;
            font-size: 0.9rem;
        }

        /* Botón para importar que se vea como botón */
        .btn-secondary input[type="file"] {
            display: none;
        }

        .instrucciones-tuberia {
            background-color: #e8f4fd;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-size: 0.85rem;
            color: #1772af;
            border-left: 3px solid #1772af;
        }

        .tuberia-btn {
            background-color: #f0f0f0;
            border: 1px solid #ddd;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            transition: all 0.3s;
            width: 100%;
            justify-content: center;
            margin-top: 10px;
        }

        .tuberia-btn:hover {
            background-color: #e0e0e0;
        }

        .tuberia-btn.activo {
            background-color: #00a553;
            color: white;
            border-color: #00a553;
        }
        
        /* Nuevos estilos para los cambios solicitados */
        .tuberia-btn.conexion-btn {
            background-color: #ff9f43;
            border-color: #ff9f43;
            color: white;
        }
        
        .tuberia-btn.conexion-btn:hover {
            background-color: #e6892f;
        }
        
        .tuberia-btn.modo-conexion-activo {
            background-color: #ff9f43 !important;
            color: white !important;
            border-color: #ff9f43 !important;
        }
        
        .punto-activo {
            animation: pulse 1s infinite;
            box-shadow: 0 0 0 5px rgba(255, 107, 107, 0.5) !important;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 107, 107, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0); }
        }
        
        /* Estilos para la pestaña de resultados */
        .resultados-tab {
            max-height: 500px;
            overflow-y: auto;
        }
        
        .resultado-seccion {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .resultado-titulo {
            color: #1772af;
            margin-bottom: 10px;
            font-size: 1.2rem;
        }
        
        .resultado-tabla {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 0.9rem;
        }
        
        .resultado-tabla th {
            background-color: #f8f9fa;
            padding: 8px 12px;
            text-align: left;
            font-weight: 600;
            border: 1px solid #ddd;
        }
        
        .resultado-tabla td {
            padding: 8px 12px;
            border: 1px solid #ddd;
        }
        
        .resultado-tabla tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        .btn-export-pdf {
            width: 100%;
            margin-top: 15px;
            background-color: #e74c3c;
        }
        
        .btn-export-pdf:hover {
            background-color: #c0392b;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header id="mainHeader">
        <div class="main-header">
            <div class="container">
                <div class="logo">
                    <img src="logo.png" alt="Agrosistemas Logo">
                </div>
                <button class="mobile-menu-btn" id="mobileMenuBtn">
                    <i class="fas fa-bars"></i>
                </button>
                <nav id="mainNav">
                    <ul>
                        <li><a href="index.html">Inicio</a></li>
                        <li><a href="asesoriaTecnica.html" class="current-page">Asesoría Técnica</a></li>
                        <li><a href="sistemaDeRiego.html">Sistemas de Riego</a></li>
                        <li><a href="energiaSolar.html">Energía Solar</a></li>
                        <li><a href="equipamientoAgricola.html">Equipamiento</a></li>
                        <li><a href="#contacto">Contacto</a></li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>

    <!-- Hero Section -->
    <section class="page-hero">
        <div class="container">
            <h1 class="fade-in">Asesoría Técnica Agrícola</h1>
            <p class="fade-in delay-1">Soluciones técnicas especializadas para optimizar cada etapa de tu producción agrícola. Implementamos tecnología de punta para maximizar rendimientos y rentabilidad.</p>
            <a href="#contacto" class="btn fade-in delay-2">Solicitar Asesoría</a>
        </div>
    </section>

    <!-- Servicios Detallados -->
    <section class="servicios-detalle" id="servicios">
        <div class="container">
            <h2 class="section-title">Nuestros Servicios de Asesoría</h2>
            <div class="servicios-grid-detalle">
                <div class="servicio-detalle-card fade-in">
                    <div class="servicio-detalle-icon">
                        <i class="fas fa-map-marked-alt"></i>
                    </div>
                    <div class="servicio-detalle-content">
                        <h3>Planificación de Cultivos</h3>
                        <p>Análisis de suelos, selección de cultivos adecuados, planificación de rotaciones y diseño de layouts de siembra para maximizar el uso del espacio y recursos.</p>
                        <div class="servicio-beneficios">
                            <h4>Beneficios:</h4>
                            <ul>
                                <li>Aumento del rendimiento por hectárea</li>
                                <li>Optimización del uso del agua</li>
                                <li>Reducción de costos operativos</li>
                                <li>Mejor manejo de nutrientes</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <div class="servicio-detalle-card fade-in delay-1">
                    <div class="servicio-detalle-icon">
                        <i class="fas fa-tint"></i>
                    </div>
                    <div class="servicio-detalle-content">
                        <h3>Diseño de Sistemas de Riego</h3>
                        <p>Diseño personalizado de sistemas de riego por goteo, aspersión o microaspersión, incluyendo cálculos hidráulicos y selección de componentes óptimos.</p>
                        <div class="servicio-beneficios">
                            <h4>Beneficios:</h4>
                            <ul>
                                <li>Ahorro de agua hasta 60%</li>
                                <li>Uniformidad de riego garantizada</li>
                                <li>Reducción de mano de obra</li>
                                <li>Fertirriego automatizado</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <div class="servicio-detalle-card fade-in delay-2">
                    <div class="servicio-detalle-icon">
                        <i class="fas fa-sun"></i>
                    </div>
                    <div class="servicio-detalle-content">
                        <h3>Energía Solar para Agricultura</h3>
                        <p>Implementación de sistemas fotovoltaicos para bombeo de agua, electrificación de instalaciones y reducción de costos energéticos.</p>
                        <div class="servicio-beneficios">
                            <h4>Beneficios:</h4>
                            <ul>
                                <li>Reducción de costos energéticos</li>
                                <li>Independencia energética</li>
                                <li>Bombeo solar eficiente</li>
                                <li>Subvenciones y financiamiento</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Diseñador de Riego CAD -->
    <section class="disenador-riego" id="disenador-riego">
        <div class="container">
            <h2 class="section-title">Diseñador de Sistemas de Riego</h2>
            <p class="disenador-intro fade-in">Diseña tu sistema de riego de manera interactiva. Ubica tu predio en el mapa, delimita las secciones y configura tuberías, emisores y elementos del sistema.</p>
            
            <div class="disenador-grid">
                <!-- Panel del Mapa -->
                <div class="mapa-panel fade-in">
                    <div class="mapa-header">
                        <h3>Ubicación del Predio</h3>
                        <div class="area-display" id="areaDisplay">Área: 0 m²</div>
                    </div>
                    <div class="mapa-container">
                        <div id="map"></div>
                        <div class="mapa-controls" id="mapaControls">
                            <div class="search-container">
                                <input type="text" id="location-search" placeholder="Buscar ubicación...">
                                <button id="searchBtn" class="mapa-btn" style="margin-top: 5px; padding: 5px 10px; font-size: 0.8rem;">
                                    <i class="fas fa-search"></i> Buscar
                                </button>
                            </div>
                            <div class="mapa-buttons">
                                <button class="mapa-btn" id="drawPolygonBtn">
                                    <i class="fas fa-draw-polygon"></i> Delimitar Terreno
                                </button>
                                <button class="mapa-btn secondary" id="measureBtn">
                                    <i class="fas fa-ruler"></i> Medir
                                </button>
                                <button class="mapa-btn secondary" id="clearBtn">
                                    <i class="fas fa-trash"></i> Limpiar
                                </button>
                                <button class="mapa-btn secondary" id="hideControlsBtn" style="display: none;">
                                    <i class="fas fa-eye-slash"></i> Ocultar Controles
                                </button>
                                <button class="mapa-btn secondary" id="showControlsBtn" style="display: none;">
                                    <i class="fas fa-eye"></i> Mostrar Controles
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Panel de Diseño CAD -->
                <div class="cad-panel fade-in delay-1">
                    <div class="cad-header">
                        <h3>Diseño del Sistema de Riego</h3>
                        <p>Configura tuberías, emisores y elementos del sistema</p>
                    </div>
                    
                    <div class="cad-tabs">
                        <div class="cad-tab active" data-tab="tuberias">Tuberías</div>
                        <div class="cad-tab" data-tab="elementos">Elementos</div>
                        <div class="cad-tab" data-tab="resultados">Resultados</div>
                        <div class="cad-tab" data-tab="galeria">Galería</div>
                    </div>
                    
                    <div class="cad-content">
                        <!-- Pestaña de Tuberías -->
                        <div class="cad-tab-content active" id="tuberias-tab">
                            <div class="control-group">
                                <h4>Tubería Principal</h4>
                                <div class="control-row">
                                    <div class="control-label">Color:</div>
                                    <div class="color-indicator color-principal"></div>
                                    <div>Rojo (Grosor: 8px)</div>
                                </div>
                                <div class="control-row">
                                    <div class="control-label">Diámetro:</div>
                                    <select id="diametroPrincipal">
                                        <option value="2">2"</option>
                                        <option value="3">3"</option>
                                        <option value="4">4"</option>
                                        <option value="6">6"</option>
                                        <option value="8">8"</option>
                                        <option value="10">10"</option>
                                        <option value="12">12"</option>
                                        <option value="14">14"</option>
                                        <option value="16">16"</option>
                                        <option value="18">18"</option>
                                        <option value="20">20"</option>
                                    </select>
                                </div>
                                <div class="control-row">
                                    <div class="control-label">Tipo:</div>
                                    <select id="tipoPrincipal">
                                        <option value="pvc">PVC</option>
                                        <option value="manguera">Manguera</option>
                                    </select>
                                </div>
                                <button class="tuberia-btn" onclick="iniciarModoTuberia('principal')" id="btnTuberiaPrincipal">
                                    <i class="fas fa-pencil-alt"></i> Dibujar Tubería Principal
                                </button>
                                <button class="tuberia-btn conexion-btn" onclick="iniciarModoConexion('principal')" id="btnConectarPrincipal" style="margin-top: 5px;">
                                    <i class="fas fa-link"></i> Conectar Tuberías
                                </button>
                                <div class="instrucciones-tuberia" id="instruccionesPrincipal" style="display: none;">
                                    Haz clic en el mapa para iniciar la tubería. Click para agregar puntos. Doble click para finalizar.
                                </div>
                            </div>
                            
                            <div class="control-group">
                                <h4>Tubería Secundaria</h4>
                                <div class="control-row">
                                    <div class="control-label">Color:</div>
                                    <div class="color-indicator color-secundaria"></div>
                                    <div>Turquesa (Grosor: 6px)</div>
                                </div>
                                <div class="control-row">
                                    <div class="control-label">Diámetro:</div>
                                    <select id="diametroSecundaria">
                                        <option value="1">1"</option>
                                        <option value="1.5">1.5"</option>
                                        <option value="2">2"</option>
                                        <option value="3">3"</option>
                                        <option value="4">4"</option>
                                    </select>
                                </div>
                                <div class="control-row">
                                    <div class="control-label">Tipo:</div>
                                    <select id="tipoSecundaria">
                                        <option value="pvc">PVC</option>
                                        <option value="manguera">Manguera</option>
                                    </select>
                                </div>
                                <button class="tuberia-btn" onclick="iniciarModoTuberia('secundaria')" id="btnTuberiaSecundaria">
                                    <i class="fas fa-pencil-alt"></i> Dibujar Tubería Secundaria
                                </button>
                                <button class="tuberia-btn conexion-btn" onclick="iniciarModoConexion('secundaria')" id="btnConectarSecundaria" style="margin-top: 5px;">
                                    <i class="fas fa-link"></i> Conectar Tuberías
                                </button>
                                <div class="instrucciones-tuberia" id="instruccionesSecundaria" style="display: none;">
                                    Haz clic en el mapa para iniciar la tubería. Click para agregar puntos. Doble click para finalizar.
                                </div>
                            </div>
                            
                            <div class="control-group">
                                <h4>Tubería Regante</h4>
                                <div class="control-row">
                                    <div class="control-label">Color:</div>
                                    <div class="color-indicator color-regante"></div>
                                    <div>Azul (Grosor: 4px)</div>
                                </div>
                                <div class="control-row">
                                    <div class="control-label">Diámetro:</div>
                                    <select id="diametroRegante">
                                        <option value="0.5">1/2"</option>
                                        <option value="0.75">3/4"</option>
                                        <option value="1">1"</option>
                                    </select>
                                </div>
                                <div class="control-row">
                                    <div class="control-label">Tipo:</div>
                                    <select id="tipoRegante">
                                        <option value="pvc">PVC</option>
                                        <option value="manguera">Manguera</option>
                                    </select>
                                </div>
                                <button class="tuberia-btn" onclick="iniciarModoTuberia('regante')" id="btnTuberiaRegante">
                                    <i class="fas fa-pencil-alt"></i> Dibujar Tubería Regante
                                </button>
                                <button class="tuberia-btn conexion-btn" onclick="iniciarModoConexion('regante')" id="btnConectarRegante" style="margin-top: 5px;">
                                    <i class="fas fa-link"></i> Conectar Tuberías
                                </button>
                                <div class="instrucciones-tuberia" id="instruccionesRegante" style="display: none;">
                                    Haz clic en el mapa para iniciar la tubería. Click para agregar puntos. Doble click para finalizar.
                                </div>
                            </div>
                            
                            <div class="cad-resumen">
                                <h4>Resumen de Tuberías</h4>
                                <div id="resumenTuberiasDetallado">
                                    <!-- Aquí se mostrará el resumen detallado por diámetros -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- Pestaña de Elementos -->
                        <div class="cad-tab-content" id="elementos-tab">
                            <div class="control-group">
                                <h4>Agregar Elementos al Diseño</h4>
                                <div class="elementos-lista">
                                    <div class="elemento-btn active" data-elemento="cabezal" onclick="iniciarModoElemento('cabezal')">
                                        <i class="fas fa-water-pump"></i> Cabezal
                                    </div>
                                    <div class="elemento-btn" data-elemento="purgaterminal" onclick="iniciarModoElemento('purgaterminal')">
                                        <i class="fas fa-faucet"></i> Purgas/Terminales
                                    </div>
                                    <div class="elemento-btn" data-elemento="tomagua" onclick="iniciarModoElemento('tomagua')">
                                        <i class="fas fa-tint"></i> Toma de Agua
                                    </div>
                                    <div class="elemento-btn" data-elemento="valvula" onclick="iniciarModoElemento('valvula')">
                                        <i class="fas fa-toggle-on"></i> Válvula
                                    </div>
                                    <div class="elemento-btn" data-elemento="filtro" onclick="iniciarModoElemento('filtro')">
                                        <i class="fas fa-filter"></i> Filtro
                                    </div>
                                </div>
                                <div class="instrucciones-tuberia" id="instruccionesElementos" style="display: none;">
                                    Haz clic en el mapa para colocar el elemento seleccionado.
                                </div>
                            </div>
                            
                            <div class="control-group">
                                <h4>Configuración del Elemento</h4>
                                <div id="elementoConfig">
                                    <p>Selecciona un elemento para configurarlo</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Pestaña de Resultados -->
                        <div class="cad-tab-content resultados-tab" id="resultados-tab">
                            <div class="control-group">
                                <h4>Resultados del Diseño</h4>
                                <div id="resultadosCalculos">
                                    <!-- Aquí se mostrarán todos los cálculos -->
                                </div>
                                <button class="btn btn-export-pdf" onclick="exportarPDF()">
                                    <i class="fas fa-file-pdf"></i> Exportar a PDF
                                </button>
                            </div>
                        </div>
                        
                        <!-- Pestaña de Galería -->
                        <div class="cad-tab-content" id="galeria-tab">
                            <div class="control-group">
                                <h4>Diseños Guardados</h4>
                                <div class="galeria-acciones">
                                    <button class="btn" onclick="guardarDiseño()" style="margin-right: 10px;">
                                        <i class="fas fa-save"></i> Guardar Actual
                                    </button>
                                    <button class="btn btn-secondary" onclick="exportarDiseño()">
                                        <i class="fas fa-download"></i> Exportar JSON
                                    </button>
                                    <label class="btn btn-secondary" style="display: inline-block; cursor: pointer;">
                                        <i class="fas fa-upload"></i> Importar JSON
                                        <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importarDiseño(event)">
                                    </label>
                                </div>
                                
                                <div class="galeria-diseños" id="galeriaDiseños" style="margin-top: 20px; max-height: 300px; overflow-y: auto;">
                                    <!-- Diseños se cargarán aquí -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Contacto -->
    <section class="contacto" id="contacto">
        <div class="container">
            <h2 class="section-title">Contacto</h2>
            <div class="contacto-grid">
                <div class="contact-info-card fade-in">
                    <h3>Información de Contacto</h3>
                    
                    <div class="contact-item">
                        <div class="contact-icon">
                            <i class="fas fa-map-marker-alt"></i>
                        </div>
                        <div class="contact-text">
                            <h4>Dirección</h4>
                            <p>Los Mochis, Sinaloa, México</p>
                        </div>
                    </div>
                    
                    <div class="contact-item">
                        <div class="contact-icon">
                            <i class="fas fa-phone"></i>
                        </div>
                        <div class="contact-text">
                            <h4>Teléfono</h4>
                            <a href="tel:+526681234567">+52 668 123 4567</a>
                        </div>
                    </div>
                    
                    <div class="contact-item">
                        <div class="contact-icon">
                            <i class="fas fa-envelope"></i>
                        </div>
                        <div class="contact-text">
                            <h4>Email</h4>
                            <a href="mailto:info@agrosistemas.com">info@agrosistemas.com</a>
                        </div>
                    </div>
                    
                    <div class="contact-item">
                        <div class="contact-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="contact-text">
                            <h4>Horario de Atención</h4>
                            <p>Lunes a Viernes: 8:00 - 18:00<br>Sábados: 9:00 - 13:00</p>
                        </div>
                    </div>
                </div>
                
                <div class="fade-in delay-1">
                    <h3 style="margin-bottom: 20px; color: #111;">Ubicación</h3>
                    <div class="map-container">
                        <iframe src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d115260.94825251572!2d-109.02480815!3d25.813333!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x86c7a5f40b6e008d%3A0x9a3f37c0e13f2cf6!2sLos%20Mochis%2C%20Sin.!5e0!3m2!1ses-419!2smx!4v1689690161688!5m2!1ses-419!2smx" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-logo">
                    <img src="logo.png" alt="Agrosistemas Logo">
                </div>
                <p class="footer-text">Especialistas en soluciones agrícolas integrales. Optimizamos tu producción con tecnología de punta y asesoría técnica especializada.</p>
                <div class="copyright">
                    &copy; 2024 Agrosistemas. Todos los derechos reservados.
                </div>
            </div>
        </div>
    </footer>

    <!-- Scripts -->
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    <!-- Leaflet Draw JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    
<script>
    // Variables globales
    let map;
    let drawnItems;
    let drawControl;
    let currentDrawMode = null;
    let areaTotal = 0;
    let selectedElement = 'cabezal';
    let valvulas = [];
    let tuberias = [];
    let elementosGraficos = [];
    let modoDibujoTuberia = null;
    let tuberiaActual = null;
    let puntoInicioTuberia = null;
    let diseñosGuardados = [];
    let modoAgregarElemento = null;
    let modoConexion = false;
    let tuberiaConexionTipo = null;
    let puntoOrigenConexion = null;
    let puntosTuberias = [];
    let cabezales = [];
    
    // Función para obtener el grosor basado en el tipo y diámetro
    function getGrosorTuberia(tipo, diametro) {
        const grosoresBase = {
            'principal': 8,
            'secundaria': 6,
            'regante': 4
        };
        
        const base = grosoresBase[tipo] || 4;
        const diametroNum = parseFloat(diametro);
        
        if (tipo === 'principal') {
            return base + (diametroNum * 0.5);
        } else if (tipo === 'secundaria') {
            return base + (diametroNum * 0.3);
        } else {
            return base + (diametroNum * 0.2);
        }
    }
    
    // Función para obtener color de tubería
    function getColorTuberia(tipo) {
        const colores = {
            'principal': '#ff6b6b',
            'secundaria': '#4ecdc4',
            'regante': '#45b7d1'
        };
        return colores[tipo] || '#000000';
    }
    
    // Inicializar el mapa
    function initMap() {
        const losMochis = [25.8133, -108.9719];
        
        map = L.map('map').setView(losMochis, 15);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(map);
        
        drawnItems = new L.FeatureGroup();
        map.addLayer(drawnItems);
        
        drawControl = new L.Control.Draw({
            position: 'topright',
            draw: {
                polygon: {
                    allowIntersection: false,
                    shapeOptions: {
                        color: '#008a45',
                        fillColor: '#00a553',
                        fillOpacity: 0.3,
                        weight: 2
                    },
                    showArea: true,
                    metric: true
                },
                polyline: {
                    shapeOptions: {
                        color: '#ff0000',
                        weight: 2
                    },
                    showLength: true,
                    metric: true
                },
                rectangle: false,
                circle: false,
                marker: false,
                circlemarker: false
            },
            edit: {
                featureGroup: drawnItems,
                remove: true
            }
        });
        
        map.addControl(drawControl);
        
        map.on(L.Draw.Event.CREATED, function(event) {
            const layer = event.layer;
            drawnItems.addLayer(layer);
            
            if (event.layerType === 'polygon') {
                calcularAreaPoligono(layer);
            } else if (event.layerType === 'polyline') {
                calcularLongitudPolilinea(layer);
            }
            
            if (currentDrawMode) {
                currentDrawMode.disable();
                currentDrawMode = null;
            }
        });
        
        map.on(L.Draw.Event.EDITED, function(event) {
            const layers = event.layers;
            layers.eachLayer(function(layer) {
                if (layer instanceof L.Polygon) {
                    calcularAreaPoligono(layer);
                } else if (layer instanceof L.Polyline) {
                    calcularLongitudPolilinea(layer);
                }
            });
        });
        
        map.on(L.Draw.Event.DELETED, function(event) {
            const layers = event.layers;
            layers.eachLayer(function(layer) {
                if (layer instanceof L.Polygon) {
                    areaTotal = 0;
                    document.getElementById('areaDisplay').textContent = 'Área: 0 m²';
                    actualizarResultados();
                    mostrarControlesMapa();
                }
            });
        });
    }
    
    function calcularAreaPoligono(polygon) {
        areaTotal = L.GeometryUtil.geodesicArea(polygon.getLatLngs()[0]);
        
        document.getElementById('areaDisplay').textContent = 
            `Área: ${areaTotal.toFixed(2)} m² (${(areaTotal / 10000).toFixed(2)} ha)`;
        
        ocultarControlesMapa();
        actualizarResultados();
    }
    
    function ocultarControlesMapa() {
        const controls = document.getElementById('mapaControls');
        controls.style.display = 'none';
        document.getElementById('showControlsBtn').style.display = 'block';
    }
    
    function mostrarControlesMapa() {
        const controls = document.getElementById('mapaControls');
        controls.style.display = 'block';
        document.getElementById('showControlsBtn').style.display = 'none';
        document.getElementById('hideControlsBtn').style.display = 'none';
    }
    
    function calcularLongitudPolilinea(polyline) {
        const latlngs = polyline.getLatLngs();
        let length = 0;
        
        for (let i = 0; i < latlngs.length - 1; i++) {
            length += latlngs[i].distanceTo(latlngs[i + 1]);
        }
        
        const areaDisplay = document.getElementById('areaDisplay');
        const currentArea = areaDisplay.textContent.includes('Longitud') ? 
            areaDisplay.textContent.split(' | ')[0] : areaDisplay.textContent;
        areaDisplay.textContent = `${currentArea} | Longitud: ${length.toFixed(2)} m`;
    }
    
    function buscarUbicacion() {
        const query = document.getElementById('location-search').value;
        if (!query.trim()) return;
        
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                if (data && data.length > 0) {
                    const result = data[0];
                    const lat = parseFloat(result.lat);
                    const lon = parseFloat(result.lon);
                    
                    map.setView([lat, lon], 15);
                    
                    L.marker([lat, lon])
                        .addTo(map)
                        .bindPopup(`<b>${result.display_name}</b>`)
                        .openPopup();
                } else {
                    alert('Ubicación no encontrada');
                }
            })
            .catch(error => {
                console.error('Error en la búsqueda:', error);
                alert('Error al buscar la ubicación');
            });
    }
    
    function iniciarModoTuberia(tipoTuberia) {
        if (currentDrawMode) {
            currentDrawMode.disable();
            currentDrawMode = null;
        }
        
        modoConexion = false;
        tuberiaConexionTipo = null;
        puntoOrigenConexion = null;
        
        document.querySelectorAll('.tuberia-btn').forEach(btn => {
            btn.classList.remove('modo-conexion-activo');
        });
        
        document.querySelectorAll('.tuberia-btn').forEach(btn => {
            btn.classList.remove('activo');
        });
        
        const botonId = tipoTuberia === 'principal' ? 'btnTuberiaPrincipal' : 
                       tipoTuberia === 'secundaria' ? 'btnTuberiaSecundaria' : 'btnTuberiaRegante';
        document.getElementById(botonId).classList.add('activo');
        
        const instruccionesId = tipoTuberia === 'principal' ? 'instruccionesPrincipal' : 
                               tipoTuberia === 'secundaria' ? 'instruccionesSecundaria' : 'instruccionesRegante';
        document.getElementById(instruccionesId).style.display = 'block';
        
        const diametroSelectId = tipoTuberia === 'principal' ? 'diametroPrincipal' : 
                                 tipoTuberia === 'secundaria' ? 'diametroSecundaria' : 'diametroRegante';
        const diametro = document.getElementById(diametroSelectId).value;
        
        const tipoSelectId = tipoTuberia === 'principal' ? 'tipoPrincipal' : 
                             tipoTuberia === 'secundaria' ? 'tipoSecundaria' : 'tipoRegante';
        const tipoMaterial = document.getElementById(tipoSelectId).value;
        
        tuberiaActual = {
            tipo: tipoTuberia,
            puntoInicio: null,
            puntoFin: null,
            color: getColorTuberia(tipoTuberia),
            grosor: getGrosorTuberia(tipoTuberia, diametro),
            diametro: diametro,
            tipoMaterial: tipoMaterial,
            id: Date.now(),
            conexiones: []
        };
        
        mostrarMensaje(`Modo dibujo tubería ${tipoTuberia} (${diametro}"). Haz clic en el mapa para establecer el punto de inicio.`);
        
        map.off('click');
        map.on('click', function(e) {
            if (tuberiaActual && !tuberiaActual.puntoInicio) {
                tuberiaActual.puntoInicio = e.latlng;
                
                const marcadorInicio = crearMarcadorTuberia(e.latlng, 'inicio', tipoTuberia, diametro);
                marcadorInicio.addTo(map);
                tuberiaActual.marcadorInicio = marcadorInicio;
                
                puntosTuberias.push({
                    tipo: tipoTuberia,
                    latlng: e.latlng,
                    tuberiaId: tuberiaActual.id,
                    esInicio: true
                });
                
                mostrarMensaje(`Punto de inicio establecido. Ahora haz clic para establecer el punto final.`);
                
                map.off('click');
                map.on('click', function(e2) {
                    establecerPuntoFinal(e2.latlng, tipoTuberia, diametro, tipoMaterial);
                });
            }
        });
    }
    
    function establecerPuntoFinal(latlng, tipoTuberia, diametro, tipoMaterial) {
        if (!tuberiaActual || !tuberiaActual.puntoInicio) return;
        
        let puntoExistente = null;
        let esConexion = false;
        
        puntosTuberias.forEach(punto => {
            const distancia = latlng.distanceTo(punto.latlng);
            if (distancia < 5) {
                puntoExistente = punto;
                esConexion = true;
            }
        });
        
        tuberiaActual.puntoFin = puntoExistente ? puntoExistente.latlng : latlng;
        
        if (!puntoExistente) {
            const marcadorFin = crearMarcadorTuberia(latlng, 'fin', tipoTuberia, diametro);
            marcadorFin.addTo(map);
            tuberiaActual.marcadorFin = marcadorFin;
            
            puntosTuberias.push({
                tipo: tipoTuberia,
                latlng: latlng,
                tuberiaId: tuberiaActual.id,
                esInicio: false
            });
        } else {
            tuberiaActual.conexiones.push({
                tuberiaId: puntoExistente.tuberiaId,
                punto: puntoExistente.esInicio ? 'inicio' : 'fin',
                latlng: puntoExistente.latlng
            });
            
            const otraTuberia = tuberias.find(t => t.id === puntoExistente.tuberiaId);
            if (otraTuberia) {
                otraTuberia.conexiones.push({
                    tuberiaId: tuberiaActual.id,
                    punto: 'pendiente',
                    latlng: tuberiaActual.puntoFin
                });
            }
        }
        
        const linea = dibujarLineaTuberia(tuberiaActual.puntoInicio, tuberiaActual.puntoFin, tipoTuberia, diametro);
        tuberiaActual.linea = linea;
        
        const longitud = tuberiaActual.puntoInicio.distanceTo(tuberiaActual.puntoFin);
        tuberiaActual.longitud = longitud;
        
        const centro = L.latLng(
            (tuberiaActual.puntoInicio.lat + tuberiaActual.puntoFin.lat) / 2,
            (tuberiaActual.puntoInicio.lng + tuberiaActual.puntoFin.lng) / 2
        );
        
        const etiqueta = L.marker(centro, {
            icon: L.divIcon({
                className: 'tuberia-label',
                html: `<div style="background: white; padding: 2px 5px; border: 1px solid #ccc; border-radius: 3px; font-size: 9px; font-weight: bold;">
                       ${longitud.toFixed(1)}m - ${diametro}"</div>`,
                iconSize: [80, 20],
                iconAnchor: [40, 10]
            })
        }).addTo(map);
        
        tuberiaActual.etiquetaLongitud = etiqueta;
        
        tuberias.push({...tuberiaActual});
        
        actualizarResumenTuberias();
        actualizarResultados();
        
        tuberiaActual = null;
        map.off('click');
        
        const instruccionesId = tipoTuberia === 'principal' ? 'instruccionesPrincipal' : 
                               tipoTuberia === 'secundaria' ? 'instruccionesSecundaria' : 'instruccionesRegante';
        document.getElementById(instruccionesId).style.display = 'none';
        
        const botonId = tipoTuberia === 'principal' ? 'btnTuberiaPrincipal' : 
                       tipoTuberia === 'secundaria' ? 'btnTuberiaSecundaria' : 'btnTuberiaRegante';
        document.getElementById(botonId).classList.remove('activo');
        
        mostrarMensaje(`Tubería ${tipoTuberia} (${diametro}") creada. Longitud: ${longitud.toFixed(1)} metros`);
        
        if (esConexion) {
            mostrarMensaje('¡Conexión establecida con tubería existente!');
        }
    }
    
    function crearMarcadorTuberia(latlng, tipo, tipoTuberia, diametro) {
        const colores = getColorTuberia(tipoTuberia);
        const tamanos = {
            'principal': 18,
            'secundaria': 15,
            'regante': 12
        };
        
        const tamano = tamanos[tipoTuberia];
        
        const marcador = L.marker(latlng, {
            icon: L.divIcon({
                className: 'tuberia-punto',
                html: `<div style="background: ${colores}; width: ${tamano}px; height: ${tamano}px; 
                       border-radius: 50%; border: 2px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.5); 
                       cursor: pointer;" title="${tipoTuberia} ${diametro}"></div>`,
                iconSize: [tamano, tamano],
                iconAnchor: [tamano/2, tamano/2]
            })
        });
        
        marcador.draggable = true;
        marcador.on('dragend', function(e) {
            const nuevoLatLng = e.target.getLatLng();
            
            const puntoIndex = puntosTuberias.findIndex(p => 
                Math.abs(p.latlng.lat - latlng.lat) < 0.00001 && 
                Math.abs(p.latlng.lng - latlng.lng) < 0.00001
            );
            
            if (puntoIndex !== -1) {
                puntosTuberias[puntoIndex].latlng = nuevoLatLng;
            }
            
            actualizarTuberiasConPunto(latlng, nuevoLatLng);
        });
        
        return marcador;
    }
    
    function dibujarLineaTuberia(puntoInicio, puntoFin, tipoTuberia, diametro) {
        const color = getColorTuberia(tipoTuberia);
        const grosor = getGrosorTuberia(tipoTuberia, diametro);
        
        const linea = L.polyline([puntoInicio, puntoFin], {
            color: color,
            weight: grosor,
            opacity: 0.8,
            lineCap: 'round',
            lineJoin: 'round'
        }).addTo(map);
        
        linea.editing.enable();
        
        return linea;
    }
    
    function actualizarTuberiasConPunto(viejoLatLng, nuevoLatLng) {
        tuberias.forEach(tuberia => {
            if (tuberia.puntoInicio && 
                Math.abs(tuberia.puntoInicio.lat - viejoLatLng.lat) < 0.00001 && 
                Math.abs(tuberia.puntoInicio.lng - viejoLatLng.lng) < 0.00001) {
                tuberia.puntoInicio = nuevoLatLng;
                
                if (tuberia.linea && tuberia.puntoFin) {
                    const nuevosPuntos = [nuevoLatLng, tuberia.puntoFin];
                    tuberia.linea.setLatLngs(nuevosPuntos);
                }
                
                if (tuberia.etiquetaLongitud && tuberia.puntoFin) {
                    const centro = L.latLng(
                        (nuevoLatLng.lat + tuberia.puntoFin.lat) / 2,
                        (nuevoLatLng.lng + tuberia.puntoFin.lng) / 2
                    );
                    tuberia.etiquetaLongitud.setLatLng(centro);
                    
                    const nuevaLongitud = nuevoLatLng.distanceTo(tuberia.puntoFin);
                    tuberia.longitud = nuevaLongitud;
                    tuberia.etiquetaLongitud.setIcon(L.divIcon({
                        className: 'tuberia-label',
                        html: `<div style="background: white; padding: 2px 5px; border: 1px solid #ccc; border-radius: 3px; font-size: 9px; font-weight: bold;">
                               ${nuevaLongitud.toFixed(1)}m - ${tuberia.diametro}"</div>`,
                        iconSize: [80, 20],
                        iconAnchor: [40, 10]
                    }));
                }
            }
            
            if (tuberia.puntoFin && 
                Math.abs(tuberia.puntoFin.lat - viejoLatLng.lat) < 0.00001 && 
                Math.abs(tuberia.puntoFin.lng - viejoLatLng.lng) < 0.00001) {
                tuberia.puntoFin = nuevoLatLng;
                
                if (tuberia.linea && tuberia.puntoInicio) {
                    const nuevosPuntos = [tuberia.puntoInicio, nuevoLatLng];
                    tuberia.linea.setLatLngs(nuevosPuntos);
                }
                
                if (tuberia.etiquetaLongitud && tuberia.puntoInicio) {
                    const centro = L.latLng(
                        (tuberia.puntoInicio.lat + nuevoLatLng.lat) / 2,
                        (tuberia.puntoInicio.lng + nuevoLatLng.lng) / 2
                    );
                    tuberia.etiquetaLongitud.setLatLng(centro);
                    
                    const nuevaLongitud = tuberia.puntoInicio.distanceTo(nuevoLatLng);
                    tuberia.longitud = nuevaLongitud;
                    tuberia.etiquetaLongitud.setIcon(L.divIcon({
                        className: 'tuberia-label',
                        html: `<div style="background: white; padding: 2px 5px; border: 1px solid #ccc; border-radius: 3px; font-size: 9px; font-weight: bold;">
                               ${nuevaLongitud.toFixed(1)}m - ${tuberia.diametro}"</div>`,
                        iconSize: [80, 20],
                        iconAnchor: [40, 10]
                    }));
                }
            }
        });
        
        actualizarResumenTuberias();
        actualizarResultados();
    }
    
    function actualizarResumenTuberias() {
        const resumen = {};
        
        tuberias.forEach(t => {
            const key = `${t.tipo}_${t.diametro}`;
            if (!resumen[key]) {
                resumen[key] = {
                    tipo: t.tipo,
                    diametro: t.diametro,
                    longitudTotal: 0,
                    tipoMaterial: t.tipoMaterial,
                    conexiones: 0
                };
            }
            resumen[key].longitudTotal += t.longitud || 0;
            resumen[key].conexiones += t.conexiones ? t.conexiones.length : 0;
        });
        
        let html = '<h4>Resumen de Tuberías por Diámetro</h4>';
        
        const totalesPorTipo = {};
        
        Object.keys(resumen).forEach(key => {
            const item = resumen[key];
            if (!totalesPorTipo[item.tipo]) {
                totalesPorTipo[item.tipo] = 0;
            }
            totalesPorTipo[item.tipo] += item.longitudTotal;
        });
        
        ['principal', 'secundaria', 'regante'].forEach(tipo => {
            const itemsTipo = Object.values(resumen).filter(item => item.tipo === tipo);
            if (itemsTipo.length > 0) {
                html += `<div style="margin-bottom: 10px;">`;
                html += `<strong>${tipo.charAt(0).toUpperCase() + tipo.slice(1)}:</strong>`;
                
                itemsTipo.forEach(item => {
                    html += `<div class="resumen-item">
                        <span>${item.diametro}" (${item.tipoMaterial}):</span>
                        <span>${item.longitudTotal.toFixed(2)} m</span>
                    </div>`;
                });
                
                html += `<div class="resumen-item" style="font-weight: bold;">
                    <span>Total ${tipo}:</span>
                    <span>${totalesPorTipo[tipo]?.toFixed(2) || '0.00'} m</span>
                </div>`;
                html += `</div>`;
            }
        });
        
        const totalGeneral = Object.values(totalesPorTipo).reduce((sum, val) => sum + val, 0);
        
        html += `<div class="resumen-item" style="font-weight: bold; border-top: 1px solid #ddd; padding-top: 8px;">
            <span>Total General:</span>
            <span>${totalGeneral.toFixed(2)} m</span>
        </div>`;
        
        document.getElementById('resumenTuberiasDetallado').innerHTML = html;
    }
    
    function iniciarModoConexion(tipoTuberia) {
        if (currentDrawMode) {
            currentDrawMode.disable();
            currentDrawMode = null;
        }
        
        if (tuberiaActual) {
            tuberiaActual = null;
        }
        
        document.querySelectorAll('.tuberia-btn').forEach(btn => {
            btn.classList.remove('activo');
        });
        
        const botonId = tipoTuberia === 'principal' ? 'btnConectarPrincipal' : 
                       tipoTuberia === 'secundaria' ? 'btnConectarSecundaria' : 'btnConectarRegante';
        document.getElementById(botonId).classList.add('modo-conexion-activo');
        
        modoConexion = true;
        tuberiaConexionTipo = tipoTuberia;
        puntoOrigenConexion = null;
        
        const diametroSelectId = tipoTuberia === 'principal' ? 'diametroPrincipal' : 
                                 tipoTuberia === 'secundaria' ? 'diametroSecundaria' : 'diametroRegante';
        const diametro = document.getElementById(diametroSelectId).value;
        
        const tipoSelectId = tipoTuberia === 'principal' ? 'tipoPrincipal' : 
                             tipoTuberia === 'secundaria' ? 'tipoSecundaria' : 'tipoRegante';
        const tipoMaterial = document.getElementById(tipoSelectId).value;
        
        mostrarMensaje(`Modo conexión ${tipoTuberia} (${diametro}"). Haz clic en un punto de tubería para iniciar la conexión.`);
        
        map.off('click');
        map.on('click', function(e) {
            manejarClicConexion(e.latlng, tipoTuberia, diametro, tipoMaterial);
        });
    }
    
    function manejarClicConexion(latlng, tipoTuberia, diametro, tipoMaterial) {
        let puntoCercano = null;
        let distanciaMinima = Infinity;
        
        puntosTuberias.forEach(punto => {
            const distancia = latlng.distanceTo(punto.latlng);
            if (distancia < 10) {
                if (distancia < distanciaMinima) {
                    distanciaMinima = distancia;
                    puntoCercano = punto;
                }
            }
        });
        
        if (!puntoCercano) {
            mostrarMensaje('No hay un punto de tubería cerca. Haz clic cerca de un punto existente.');
            return;
        }
        
        if (!puntoOrigenConexion) {
            puntoOrigenConexion = {
                punto: puntoCercano,
                latlng: puntoCercano.latlng
            };
            
            resaltarPunto(puntoCercano.latlng);
            mostrarMensaje('Punto origen seleccionado. Ahora haz clic en otro punto para conectar.');
        } else {
            if (puntoCercano.latlng.lat === puntoOrigenConexion.latlng.lat && 
                puntoCercano.latlng.lng === puntoOrigenConexion.latlng.lng) {
                mostrarMensaje('No puedes conectar un punto consigo mismo. Selecciona otro punto.');
                return;
            }
            
            const nuevaTuberia = {
                tipo: tipoTuberia,
                puntoInicio: puntoOrigenConexion.latlng,
                puntoFin: puntoCercano.latlng,
                color: getColorTuberia(tipoTuberia),
                grosor: getGrosorTuberia(tipoTuberia, diametro),
                diametro: diametro,
                tipoMaterial: tipoMaterial,
                id: Date.now(),
                conexiones: [
                    {
                        tuberiaId: puntoOrigenConexion.punto.tuberiaId,
                        punto: puntoOrigenConexion.punto.esInicio ? 'inicio' : 'fin',
                        latlng: puntoOrigenConexion.latlng
                    },
                    {
                        tuberiaId: puntoCercano.tuberiaId,
                        punto: puntoCercano.esInicio ? 'inicio' : 'fin',
                        latlng: puntoCercano.latlng
                    }
                ],
                esConexion: true
            };
            
            const linea = dibujarLineaTuberia(nuevaTuberia.puntoInicio, nuevaTuberia.puntoFin, tipoTuberia, diametro);
            nuevaTuberia.linea = linea;
            
            nuevaTuberia.longitud = nuevaTuberia.puntoInicio.distanceTo(nuevaTuberia.puntoFin);
            
            const centro = L.latLng(
                (nuevaTuberia.puntoInicio.lat + nuevaTuberia.puntoFin.lat) / 2,
                (nuevaTuberia.puntoInicio.lng + nuevaTuberia.puntoFin.lng) / 2
            );
            
            const etiqueta = L.marker(centro, {
                icon: L.divIcon({
                    className: 'tuberia-label',
                    html: `<div style="background: white; padding: 2px 5px; border: 1px solid #ccc; border-radius: 3px; font-size: 9px; font-weight: bold;">
                           ${nuevaTuberia.longitud.toFixed(1)}m - ${diametro}"</div>`,
                    iconSize: [80, 20],
                    iconAnchor: [40, 10]
                })
            }).addTo(map);
            
            nuevaTuberia.etiquetaLongitud = etiqueta;
            
            tuberias.push(nuevaTuberia);
            
            const tuberiaOrigen = tuberias.find(t => t.id === puntoOrigenConexion.punto.tuberiaId);
            const tuberiaDestino = tuberias.find(t => t.id === puntoCercano.tuberiaId);
            
            if (tuberiaOrigen) {
                if (!tuberiaOrigen.conexiones) tuberiaOrigen.conexiones = [];
                tuberiaOrigen.conexiones.push({
                    tuberiaId: nuevaTuberia.id,
                    punto: 'conexion',
                    latlng: puntoOrigenConexion.latlng
                });
            }
            
            if (tuberiaDestino) {
                if (!tuberiaDestino.conexiones) tuberiaDestino.conexiones = [];
                tuberiaDestino.conexiones.push({
                    tuberiaId: nuevaTuberia.id,
                    punto: 'conexion',
                    latlng: puntoCercano.latlng
                });
            }
            
            actualizarResumenTuberias();
            actualizarResultados();
            
            modoConexion = false;
            tuberiaConexionTipo = null;
            puntoOrigenConexion = null;
            
            const botonId = tipoTuberia === 'principal' ? 'btnConectarPrincipal' : 
                           tipoTuberia === 'secundaria' ? 'btnConectarSecundaria' : 'btnConectarRegante';
            document.getElementById(botonId).classList.remove('modo-conexion-activo');
            
            map.off('click');
            quitarResaltadoPuntos();
            
            mostrarMensaje(`Conexión establecida entre tuberías. Longitud: ${nuevaTuberia.longitud.toFixed(1)} metros`);
        }
    }
    
    function resaltarPunto(latlng) {
        map.eachLayer(layer => {
            if (layer instanceof L.Marker) {
                const markerLatLng = layer.getLatLng();
                if (markerLatLng && 
                    Math.abs(markerLatLng.lat - latlng.lat) < 0.00001 && 
                    Math.abs(markerLatLng.lng - latlng.lng) < 0.00001) {
                    const icon = layer.getElement();
                    if (icon) {
                        icon.classList.add('punto-activo');
                    }
                }
            }
        });
    }
    
    function quitarResaltadoPuntos() {
        map.eachLayer(layer => {
            if (layer instanceof L.Marker) {
                const icon = layer.getElement();
                if (icon) {
                    icon.classList.remove('punto-activo');
                }
            }
        });
    }
    
    function iniciarModoElemento(tipoElemento) {
        if (tuberiaActual) {
            tuberiaActual = null;
            puntoInicioTuberia = null;
            
            document.querySelectorAll('.tuberia-btn').forEach(btn => {
                btn.classList.remove('activo');
            });
            
            document.getElementById('instruccionesPrincipal').style.display = 'none';
            document.getElementById('instruccionesSecundaria').style.display = 'none';
            document.getElementById('instruccionesRegante').style.display = 'none';
        }
        
        if (modoConexion) {
            modoConexion = false;
            tuberiaConexionTipo = null;
            puntoOrigenConexion = null;
            
            document.querySelectorAll('.tuberia-btn').forEach(btn => {
                btn.classList.remove('modo-conexion-activo');
            });
        }
        
        document.querySelectorAll('.elemento-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        
        document.querySelector(`.elemento-btn[data-elemento="${tipoElemento}"]`).classList.add('active');
        
        modoAgregarElemento = tipoElemento;
        document.getElementById('instruccionesElementos').style.display = 'block';
        mostrarMensaje(`Modo elemento activado. Haz clic en el mapa para colocar el ${tipoElemento}.`);
        
        actualizarConfiguracionElemento(tipoElemento);
    }
    
    function agregarElementoGrafico(latlng, tipo) {
        const iconos = {
            'cabezal': 'fa-water-pump',
            'purgaterminal': 'fa-faucet',
            'tomagua': 'fa-tint',
            'valvula': 'fa-toggle-on',
            'filtro': 'fa-filter'
        };
        
        const colores = {
            'cabezal': '#1772af',
            'purgaterminal': '#ff9f43',
            'tomagua': '#00a553',
            'valvula': '#ff6b6b',
            'filtro': '#4ecdc4'
        };
        
        const elemento = L.marker(latlng, {
            icon: L.divIcon({
                className: 'elemento-grafico',
                html: `<div style="background: ${colores[tipo]}; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                       <i class="fas ${iconos[tipo]}"></i></div>`,
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            }),
            draggable: true
        }).addTo(map);
        
        elemento.bindPopup(`<b>${tipo.toUpperCase()}</b><br>Arrastra para mover`);
        
        elemento.on('dragend', function(e) {
            const nuevaPos = e.target.getLatLng();
            const elementoIndex = elementosGraficos.findIndex(e => e.layer === elemento);
            if (elementoIndex !== -1) {
                elementosGraficos[elementoIndex].posicion = nuevaPos;
                
                if (tipo === 'valvula') {
                    const valvulaIndex = valvulas.findIndex(v => v.elementoId === elementosGraficos[elementoIndex].id);
                    if (valvulaIndex !== -1) {
                        valvulas[valvulaIndex].posicion = nuevaPos;
                    }
                } else if (tipo === 'cabezal') {
                    const cabezalIndex = cabezales.findIndex(c => c.elementoId === elementosGraficos[elementoIndex].id);
                    if (cabezalIndex !== -1) {
                        cabezales[cabezalIndex].posicion = nuevaPos;
                    }
                }
            }
        });
        
        const elementoId = Date.now();
        elementosGraficos.push({
            id: elementoId,
            type: 'elemento',
            layer: elemento,
            tipo: tipo,
            posicion: latlng
        });
        
        if (tipo === 'valvula') {
            const nombre = generarNombreValvula();
            valvulas.push({
                id: elementoId,
                nombre: nombre,
                elementoId: elementoId,
                posicion: latlng,
                caudalEmisor: 4,
                numeroEmisores: 100,
                tipo: 'Manual',
                diametro: '2"',
                presion: 3,
                caudalTotal: 400
            });
            
            elemento.bindPopup(`<b>VÁLVULA ${nombre}</b><br>Caudal: 400 L/h<br>Arrastra para mover`);
            
            actualizarResultados();
        }
        
        if (tipo === 'cabezal') {
            cabezales.push({
                id: elementoId,
                elementoId: elementoId,
                posicion: latlng,
                caudalBomba: 50,
                diametroSuccion: '4"',
                diametroDescarga: '3"',
                numeroFiltros: 2,
                tipoFiltros: 'Anillas',
                notas: 'Cabezal principal del sistema'
            });
            
            elemento.bindPopup(`<b>CABEZAL PRINCIPAL</b><br>Caudal: 50 L/s<br>Arrastra para mover`);
            
            actualizarResultados();
        }
        
        actualizarConfiguracionElemento(tipo, elementoId);
    }
    
    function generarNombreValvula() {
        const letras = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z'];
        const numeros = Array.from({length: 10}, (_, i) => i + 1);
        
        const nombresExistentes = valvulas.map(v => v.nombre);
        
        for (let letra of letras) {
            for (let numero of numeros) {
                const nombre = `${letra}${numero}`;
                if (!nombresExistentes.includes(nombre)) {
                    return nombre;
                }
            }
        }
        
        return `V${valvulas.length + 1}`;
    }
    
    function actualizarConfiguracionElemento(tipo, elementoId = null) {
        const configDiv = document.getElementById('elementoConfig');
        
        if (tipo === 'valvula' && elementoId) {
            const valvula = valvulas.find(v => v.id === elementoId);
            if (valvula) {
                configDiv.innerHTML = `
                    <h4>Configuración de Válvula ${valvula.nombre}</h4>
                    <div class="control-row">
                        <div class="control-label">Nombre:</div>
                        <input type="text" id="nombreValvula" value="${valvula.nombre}" onchange="actualizarValvula('${elementoId}', 'nombre', this.value)">
                    </div>
                    <div class="control-row">
                        <div class="control-label">Caudal emisor:</div>
                        <input type="number" id="caudalEmisorValvula" value="${valvula.caudalEmisor}" step="0.5" min="1" max="100" onchange="actualizarValvula('${elementoId}', 'caudalEmisor', this.value)">
                        L/h
                    </div>
                    <div class="control-row">
                        <div class="control-label">N° emisores:</div>
                        <input type="number" id="numEmisoresValvula" value="${valvula.numeroEmisores}" min="1" max="10000" onchange="actualizarValvula('${elementoId}', 'numeroEmisores', this.value)">
                    </div>
                    <div class="control-row">
                        <div class="control-label">Tipo:</div>
                        <select id="tipoValvula" onchange="actualizarValvula('${elementoId}', 'tipo', this.value)">
                            <option value="Manual" ${valvula.tipo === 'Manual' ? 'selected' : ''}>Manual</option>
                            <option value="Automática" ${valvula.tipo === 'Automática' ? 'selected' : ''}>Automática</option>
                            <option value="Electroválvula" ${valvula.tipo === 'Electroválvula' ? 'selected' : ''}>Electroválvula</option>
                        </select>
                    </div>
                    <div class="control-row">
                        <div class="control-label">Diámetro:</div>
                        <select id="diametroValvula" onchange="actualizarValvula('${elementoId}', 'diametro', this.value)">
                            <option value="1\"" ${valvula.diametro === '1"' ? 'selected' : ''}>1"</option>
                            <option value="2\"" ${valvula.diametro === '2"' ? 'selected' : ''}>2"</option>
                            <option value="3\"" ${valvula.diametro === '3"' ? 'selected' : ''}>3"</option>
                            <option value="4\"" ${valvula.diametro === '4"' ? 'selected' : ''}>4"</option>
                        </select>
                    </div>
                    <div class="control-row">
                        <div class="control-label">Presión:</div>
                        <input type="number" id="presionValvula" value="${valvula.presion}" step="0.5" min="1" max="10" onchange="actualizarValvula('${elementoId}', 'presion', this.value)">
                        bar
                    </div>
                    <div style="margin-top: 10px; padding: 10px; background-color: #e8f4fd; border-radius: 5px;">
                        <strong>Caudal Total:</strong> ${valvula.caudalTotal} L/h (${(valvula.caudalTotal / 3600).toFixed(2)} L/s)
                    </div>
                `;
            }
        } else if (tipo === 'cabezal' && elementoId) {
            const cabezal = cabezales.find(c => c.id === elementoId);
            if (cabezal) {
                configDiv.innerHTML = `
                    <h4>Configuración del Cabezal</h4>
                    <div class="control-row">
                        <div class="control-label">Caudal bomba:</div>
                        <input type="number" id="caudalBomba" value="${cabezal.caudalBomba}" step="5" min="1" max="1000" onchange="actualizarCabezal('${elementoId}', 'caudalBomba', this.value)">
                        L/s
                    </div>
                    <div class="control-row">
                        <div class="control-label">Diámetro succión:</div>
                        <select id="diametroSuccion" onchange="actualizarCabezal('${elementoId}', 'diametroSuccion', this.value)">
                            <option value="2\"" ${cabezal.diametroSuccion === '2"' ? 'selected' : ''}>2"</option>
                            <option value="3\"" ${cabezal.diametroSuccion === '3"' ? 'selected' : ''}>3"</option>
                            <option value="4\"" ${cabezal.diametroSuccion === '4"' ? 'selected' : ''}>4"</option>
                            <option value="6\"" ${cabezal.diametroSuccion === '6"' ? 'selected' : ''}>6"</option>
                            <option value="8\"" ${cabezal.diametroSuccion === '8"' ? 'selected' : ''}>8"</option>
                        </select>
                    </div>
                    <div class="control-row">
                        <div class="control-label">Diámetro descarga:</div>
                        <select id="diametroDescarga" onchange="actualizarCabezal('${elementoId}', 'diametroDescarga', this.value)">
                            <option value="2\"" ${cabezal.diametroDescarga === '2"' ? 'selected' : ''}>2"</option>
                            <option value="3\"" ${cabezal.diametroDescarga === '3"' ? 'selected' : ''}>3"</option>
                            <option value="4\"" ${cabezal.diametroDescarga === '4"' ? 'selected' : ''}>4"</option>
                            <option value="6\"" ${cabezal.diametroDescarga === '6"' ? 'selected' : ''}>6"</option>
                        </select>
                    </div>
                    <div class="control-row">
                        <div class="control-label">N° filtros:</div>
                        <input type="number" id="numFiltros" value="${cabezal.numeroFiltros}" min="1" max="10" onchange="actualizarCabezal('${elementoId}', 'numeroFiltros', this.value)">
                    </div>
                    <div class="control-row">
                        <div class="control-label">Tipo filtros:</div>
                        <select id="tipoFiltros" onchange="actualizarCabezal('${elementoId}', 'tipoFiltros', this.value)">
                            <option value="Anillas" ${cabezal.tipoFiltros === 'Anillas' ? 'selected' : ''}>Anillas</option>
                            <option value="Arena" ${cabezal.tipoFiltros === 'Arena' ? 'selected' : ''}>Arena</option>
                            <option value="Malla" ${cabezal.tipoFiltros === 'Malla' ? 'selected' : ''}>Malla</option>
                            <option value="Hidrociclón" ${cabezal.tipoFiltros === 'Hidrociclón' ? 'selected' : ''}>Hidrociclón</option>
                        </select>
                    </div>
                    <div class="control-row">
                        <div class="control-label">Notas:</div>
                        <textarea id="notasCabezal" rows="3" style="width: 100%; margin-top: 5px;" onchange="actualizarCabezal('${elementoId}', 'notas', this.value)">${cabezal.notas}</textarea>
                    </div>
                `;
            }
        } else {
            let contenido = '';
            
            switch(tipo) {
                case 'cabezal':
                    contenido = `
                        <h4>Configuración del Cabezal</h4>
                        <div class="control-row">
                            <div class="control-label">Caudal bomba:</div>
                            <input type="number" id="caudalBomba" value="50" step="5" min="1" max="1000"> L/s
                        </div>
                        <div class="control-row">
                            <div class="control-label">Diámetro succión:</div>
                            <select id="diametroSuccion">
                                <option value="2\"" selected>2"</option>
                                <option value="3"">3"</option>
                                <option value="4"">4"</option>
                                <option value="6"">6"</option>
                                <option value="8"">8"</option>
                            </select>
                        </div>
                        <div class="control-row">
                            <div class="control-label">Diámetro descarga:</div>
                            <select id="diametroDescarga">
                                <option value="2\"">2"</option>
                                <option value="3\"" selected>3"</option>
                                <option value="4\"">4"</option>
                                <option value="6\"">6"</option>
                            </select>
                        </div>
                        <div class="control-row">
                            <div class="control-label">N° filtros:</div>
                            <input type="number" id="numFiltros" value="2" min="1" max="10">
                        </div>
                        <div class="control-row">
                            <div class="control-label">Tipo filtros:</div>
                            <select id="tipoFiltros">
                                <option value="Anillas" selected>Anillas</option>
                                <option value="Arena">Arena</option>
                                <option value="Malla">Malla</option>
                                <option value="Hidrociclón">Hidrociclón</option>
                            </select>
                        </div>
                        <div class="control-row">
                            <div class="control-label">Notas:</div>
                            <textarea id="notasCabezal" rows="3" style="width: 100%; margin-top: 5px;">Cabezal principal del sistema</textarea>
                        </div>
                    `;
                    break;
                    
                case 'purgaterminal':
                    contenido = `
                        <h4>Configuración de Purgas/Terminales</h4>
                        <div class="control-row">
                            <div class="control-label">Cantidad:</div>
                            <input type="number" id="cantidadPurgas" min="1" max="20" value="4">
                        </div>
                        <div class="control-row">
                            <div class="control-label">Tipo:</div>
                            <select id="tipoPurgas">
                                <option>Automática</option>
                                <option>Manual</option>
                            </select>
                        </div>
                        <div class="control-row">
                            <div class="control-label">Diámetro:</div>
                            <select id="diametroPurgas">
                                <option>1"</option>
                                <option>1.5"</option>
                                <option>2"</option>
                            </select>
                    `;
                    break;
                    
                case 'tomagua':
                    contenido = `
                        <h4>Configuración de Toma de Agua</h4>
                        <div class="control-row">
                            <div class="control-label">Diámetro:</div>
                            <select id="diametroToma">
                                <option>2"</option>
                                <option>3"</option>
                                <option>4"</option>
                                <option>6"</option>
                            </select>
                        </div>
                        <div class="control-row">
                            <div class="control-label">Profundidad:</div>
                            <input type="number" id="profundidadToma" min="0.5" max="5" value="1.2" step="0.1"> m
                        </div>
                        <div class="control-row">
                            <div class="control-label">Caudal:</div>
                            <input type="number" id="caudalToma" min="1" max="1000" value="50" step="5"> L/s
                        </div>
                    `;
                    break;
                    
                case 'valvula':
                    const nombreValvula = generarNombreValvula();
                    contenido = `
                        <h4>Configuración de Válvula ${nombreValvula}</h4>
                        <div class="control-row">
                            <div class="control-label">Nombre:</div>
                            <input type="text" id="nombreValvula" value="${nombreValvula}">
                        </div>
                        <div class="control-row">
                            <div class="control-label">Caudal emisor:</div>
                            <input type="number" id="caudalEmisorValvula" value="4" step="0.5" min="1" max="100"> L/h
                        </div>
                        <div class="control-row">
                            <div class="control-label">N° emisores:</div>
                            <input type="number" id="numEmisoresValvula" value="100" min="1" max="10000">
                        </div>
                        <div class="control-row">
                            <div class="control-label">Tipo:</div>
                            <select id="tipoValvula">
                                <option value="Manual">Manual</option>
                                <option value="Automática">Automática</option>
                                <option value="Electroválvula">Electroválvula</option>
                            </select>
                        </div>
                        <div class="control-row">
                            <div class="control-label">Diámetro:</div>
                            <select id="diametroValvula">
                                <option value="1\"">1"</option>
                                <option value="2\"" selected>2"</option>
                                <option value="3\"">3"</option>
                                <option value="4\"">4"</option>
                            </select>
                        </div>
                        <div class="control-row">
                            <div class="control-label">Presión:</div>
                            <input type="number" id="presionValvula" value="3" step="0.5" min="1" max="10"> bar
                        </div>
                        <div style="margin-top: 10px; padding: 10px; background-color: #e8f4fd; border-radius: 5px;">
                            <strong>Caudal Total Estimado:</strong> 400 L/h (0.11 L/s)
                        </div>
                    `;
                    break;
                    
                case 'filtro':
                    contenido = `
                        <h4>Configuración de Filtro</h4>
                        <div class="control-row">
                            <div class="control-label">Tipo:</div>
                            <select id="tipoFiltro">
                                <option>Anillas</option>
                                <option>Arena</option>
                                <option>Malla</option>
                                <option>Hidrociclón</option>
                            </select>
                        </div>
                        <div class="control-row">
                            <div class="control-label">Diámetro:</div>
                            <select id="diametroFiltro">
                                <option>2"</option>
                                <option>3"</option>
                                <option>4"</option>
                            </select>
                        </div>
                        <div class="control-row">
                            <div class="control-label">Capacidad:</div>
                            <input type="number" id="capacidadFiltro" min="10" max="500" value="100" step="10"> m³/h
                        </div>
                    `;
                    break;
                    
                default:
                    contenido = `<p>Selecciona un elemento para configurarlo</p>`;
            }
            
            configDiv.innerHTML = contenido;
        }
    }
    
    function actualizarValvula(elementoId, campo, valor) {
        const valvula = valvulas.find(v => v.id === parseInt(elementoId));
        if (valvula) {
            valvula[campo] = valor;
            
            if (campo === 'caudalEmisor' || campo === 'numeroEmisores') {
                valvula.caudalTotal = valvula.caudalEmisor * valvula.numeroEmisores;
            }
            
            const elementoGrafico = elementosGraficos.find(e => e.id === parseInt(elementoId));
            if (elementoGrafico && elementoGrafico.layer) {
                elementoGrafico.layer.bindPopup(`<b>VÁLVULA ${valvula.nombre}</b><br>Caudal: ${valvula.caudalTotal} L/h<br>Tipo: ${valvula.tipo}<br>Arrastra para mover`);
            }
            
            actualizarResultados();
        }
    }
    
    function actualizarCabezal(elementoId, campo, valor) {
        const cabezal = cabezales.find(c => c.id === parseInt(elementoId));
        if (cabezal) {
            cabezal[campo] = valor;
            
            const elementoGrafico = elementosGraficos.find(e => e.id === parseInt(elementoId));
            if (elementoGrafico && elementoGrafico.layer) {
                elementoGrafico.layer.bindPopup(`<b>CABEZAL PRINCIPAL</b><br>Caudal: ${cabezal.caudalBomba} L/s<br>Filtros: ${cabezal.numeroFiltros} ${cabezal.tipoFiltros}<br>Arrastra para mover`);
            }
            
            actualizarResultados();
        }
    }
    
    function actualizarResultados() {
        const resultadosDiv = document.getElementById('resultadosCalculos');
        
        if (tuberias.length === 0 && valvulas.length === 0 && cabezales.length === 0) {
            resultadosDiv.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No hay elementos en el diseño. Agrega tuberías y elementos para ver los resultados.</p>';
            return;
        }
        
        let html = '';
        
        html += '<div class="resultado-seccion">';
        html += '<h4 class="resultado-titulo">Información General</h4>';
        html += '<table class="resultado-tabla">';
        html += '<tr><th>Área Total</th><td>' + (areaTotal > 0 ? areaTotal.toFixed(2) + ' m² (' + (areaTotal / 10000).toFixed(2) + ' ha)' : 'No definida') + '</td></tr>';
        html += '<tr><th>Fecha de Diseño</th><td>' + new Date().toLocaleDateString() + '</td></tr>';
        html += '</table>';
        html += '</div>';
        
        if (tuberias.length > 0) {
            html += '<div class="resultado-seccion">';
            html += '<h4 class="resultado-titulo">Tuberías por Diámetro</h4>';
            html += '<table class="resultado-tabla">';
            html += '<tr><th>Tipo</th><th>Diámetro</th><th>Material</th><th>Longitud (m)</th><th>Conexiones</th></tr>';
            
            const resumen = {};
            
            tuberias.forEach(t => {
                const key = `${t.tipo}_${t.diametro}_${t.tipoMaterial}`;
                if (!resumen[key]) {
                    resumen[key] = {
                        tipo: t.tipo,
                        diametro: t.diametro,
                        tipoMaterial: t.tipoMaterial,
                        longitudTotal: 0,
                        conexiones: 0
                    };
                }
                resumen[key].longitudTotal += t.longitud || 0;
                resumen[key].conexiones += t.conexiones ? t.conexiones.length : 0;
            });
            
            let totalGeneral = 0;
            Object.values(resumen).forEach(item => {
                html += `<tr>
                    <td>${item.tipo.charAt(0).toUpperCase() + item.tipo.slice(1)}</td>
                    <td>${item.diametro}"</td>
                    <td>${item.tipoMaterial}</td>
                    <td>${item.longitudTotal.toFixed(2)}</td>
                    <td>${item.conexiones}</td>
                </tr>`;
                totalGeneral += item.longitudTotal;
            });
            
            html += `<tr style="font-weight: bold; background-color: #f0f0f0;">
                <td colspan="3">TOTAL GENERAL</td>
                <td>${totalGeneral.toFixed(2)} m</td>
                <td></td>
            </tr>`;
            
            html += '</table>';
            html += '</div>';
        }
        
        if (valvulas.length > 0) {
            html += '<div class="resultado-seccion">';
            html += '<h4 class="resultado-titulo">Válvulas de Control</h4>';
            html += '<table class="resultado-tabla">';
            html += '<tr><th>Nombre</th><th>Tipo</th><th>Diámetro</th><th>Presión (bar)</th><th>Emisores</th><th>Caudal Emisor (L/h)</th><th>Caudal Total (L/h)</th></tr>';
            
            let caudalTotalSistema = 0;
            valvulas.forEach(valvula => {
                html += `<tr>
                    <td>${valvula.nombre}</td>
                    <td>${valvula.tipo}</td>
                    <td>${valvula.diametro}</td>
                    <td>${valvula.presion}</td>
                    <td>${valvula.numeroEmisores}</td>
                    <td>${valvula.caudalEmisor}</td>
                    <td>${valvula.caudalTotal}</td>
                </tr>`;
                caudalTotalSistema += valvula.caudalTotal;
            });
            
            html += `<tr style="font-weight: bold; background-color: #f0f0f0;">
                <td colspan="6">CAUDAL TOTAL DEL SISTEMA</td>
                <td>${caudalTotalSistema.toFixed(2)} L/h (${(caudalTotalSistema / 3600).toFixed(2)} L/s)</td>
            </tr>`;
            
            html += '</table>';
            html += '</div>';
        }
        
        if (cabezales.length > 0) {
            html += '<div class="resultado-seccion">';
            html += '<h4 class="resultado-titulo">Cabezal de Bombeo y Filtración</h4>';
            
            cabezales.forEach(cabezal => {
                html += '<table class="resultado-tabla" style="margin-bottom: 15px;">';
                html += `<tr><th colspan="2" style="text-align: center;">CABEZAL PRINCIPAL</th></tr>`;
                html += `<tr><td>Caudal de Bomba</td><td>${cabezal.caudalBomba} L/s</td></tr>`;
                html += `<tr><td>Diámetro Succión</td><td>${cabezal.diametroSuccion}</td></tr>`;
                html += `<tr><td>Diámetro Descarga</td><td>${cabezal.diametroDescarga}</td></tr>`;
                html += `<tr><td>Número de Filtros</td><td>${cabezal.numeroFiltros}</td></tr>`;
                html += `<tr><td>Tipo de Filtros</td><td>${cabezal.tipoFiltros}</td></tr>`;
                if (cabezal.notas) {
                    html += `<tr><td>Notas</td><td>${cabezal.notas}</td></tr>`;
                }
                html += '</table>';
            });
            
            html += '</div>';
        }
        
        if (valvulas.length > 0) {
            html += '<div class="resultado-seccion">';
            html += '<h4 class="resultado-titulo">Resumen Hidráulico</h4>';
            html += '<table class="resultado-tabla">';
            html += '<tr><th>Parámetro</th><th>Valor</th><th>Observaciones</th></tr>';
            
            const caudalTotalSistema = valvulas.reduce((sum, v) => sum + v.caudalTotal, 0);
            const caudalLps = caudalTotalSistema / 3600;
            
            html += `<tr>
                <td>Caudal Total Requerido</td>
                <td>${caudalTotalSistema.toFixed(2)} L/h (${caudalLps.toFixed(2)} L/s)</td>
                <td>Suma de todas las válvulas</td>
            </tr>`;
            
            if (cabezales.length > 0) {
                const cabezalPrincipal = cabezales[0];
                const caudalCabezal = cabezalPrincipal.caudalBomba * 1000;
                const diferencia = caudalCabezal - caudalTotalSistema;
                const porcentaje = (diferencia / caudalCabezal) * 100;
                
                html += `<tr>
                    <td>Caudal Disponible (Cabezal)</td>
                    <td>${(cabezalPrincipal.caudalBomba * 1000).toFixed(2)} L/h (${cabezalPrincipal.caudalBomba} L/s)</td>
                    <td>Capacidad del sistema de bombeo</td>
                </tr>`;
                
                html += `<tr>
                    <td>Diferencia</td>
                    <td>${diferencia.toFixed(2)} L/h (${(diferencia / 3600).toFixed(2)} L/s)</td>
                    <td>${diferencia >= 0 ? 'Sobrecapacidad: ' + porcentaje.toFixed(1) + '%' : 'Deficit: ' + Math.abs(porcentaje).toFixed(1) + '%'}</td>
                </tr>`;
            }
            
            if (areaTotal > 0 && caudalTotalSistema > 0) {
                const laminaPorHora = caudalTotalSistema / (areaTotal * 1000);
                const horasPara10mm = 10 / laminaPorHora;
                
                html += `<tr>
                    <td>Lámina de Riego por Hora</td>
                    <td>${laminaPorHora.toFixed(3)} mm/h</td>
                    <td></td>
                </tr>`;
                html += `<tr>
                    <td>Tiempo para 10 mm de riego</td>
                    <td>${horasPara10mm.toFixed(1)} horas</td>
                    <td>Lámina estándar para muchos cultivos</td>
                </tr>`;
            }
            
            html += '</table>';
            html += '</div>';
        }
        
        resultadosDiv.innerHTML = html;
    }
    
    function exportarPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4');
        
        doc.setFontSize(20);
        doc.setTextColor(0, 165, 83);
        doc.text('MEMORIA DE CÁLCULO - SISTEMA DE RIEGO', 105, 20, { align: 'center' });
        
        doc.setFontSize(11);
        doc.setTextColor(0, 0, 0);
        doc.text('Agrosistemas - Asesoría Técnica', 105, 30, { align: 'center' });
        doc.text('Fecha: ' + new Date().toLocaleDateString(), 105, 37, { align: 'center' });
        
        let yPos = 50;
        
        doc.setFontSize(14);
        doc.setTextColor(23, 114, 175);
        doc.text('1. INFORMACIÓN GENERAL', 20, yPos);
        
        doc.setFontSize(11);
        doc.setTextColor(0, 0, 0);
        yPos += 10;
        doc.text('Área Total: ' + (areaTotal > 0 ? areaTotal.toFixed(2) + ' m² (' + (areaTotal / 10000).toFixed(2) + ' ha)' : 'No definida'), 25, yPos);
        yPos += 7;
        doc.text('Fecha de Diseño: ' + new Date().toLocaleDateString(), 25, yPos);
        yPos += 7;
        doc.text('Número de Válvulas: ' + valvulas.length, 25, yPos);
        yPos += 7;
        doc.text('Longitud Total de Tuberías: ' + tuberias.reduce((sum, t) => sum + (t.longitud || 0), 0).toFixed(2) + ' m', 25, yPos);
        
        yPos += 15;
        
        if (tuberias.length > 0) {
            doc.setFontSize(14);
            doc.setTextColor(23, 114, 175);
            doc.text('2. TUBERÍAS POR DIÁMETRO', 20, yPos);
            yPos += 10;
            
            const resumen = {};
            tuberias.forEach(t => {
                const key = `${t.tipo}_${t.diametro}_${t.tipoMaterial}`;
                if (!resumen[key]) {
                    resumen[key] = {
                        tipo: t.tipo,
                        diametro: t.diametro,
                        tipoMaterial: t.tipoMaterial,
                        longitudTotal: 0,
                        conexiones: 0
                    };
                }
                resumen[key].longitudTotal += t.longitud || 0;
                resumen[key].conexiones += t.conexiones ? t.conexiones.length : 0;
            });
            
            const headers = [['Tipo', 'Diámetro', 'Material', 'Longitud (m)', 'Conexiones']];
            const data = Object.values(resumen).map(item => [
                item.tipo.charAt(0).toUpperCase() + item.tipo.slice(1),
                item.diametro + '"',
                item.tipoMaterial,
                item.longitudTotal.toFixed(2),
                item.conexiones.toString()
            ]);
            
            const totalGeneral = tuberias.reduce((sum, t) => sum + (t.longitud || 0), 0);
            data.push(['TOTAL GENERAL', '', '', totalGeneral.toFixed(2), '']);
            
            doc.autoTable({
                startY: yPos,
                head: headers,
                body: data,
                margin: { left: 20 },
                theme: 'grid',
                headStyles: { fillColor: [23, 114, 175] },
                styles: { fontSize: 9 }
            });
            
            yPos = doc.lastAutoTable.finalY + 10;
        }
        
        if (valvulas.length > 0) {
            doc.setFontSize(14);
            doc.setTextColor(23, 114, 175);
            doc.text('3. VÁLVULAS DE CONTROL', 20, yPos);
            yPos += 10;
            
            const headers = [['Nombre', 'Tipo', 'Diámetro', 'Presión (bar)', 'Emisores', 'Caudal Emisor (L/h)', 'Caudal Total (L/h)']];
            const data = valvulas.map(valvula => [
                valvula.nombre,
                valvula.tipo,
                valvula.diametro,
                valvula.presion.toString(),
                valvula.numeroEmisores.toString(),
                valvula.caudalEmisor.toString(),
                valvula.caudalTotal.toString()
            ]);
            
            const caudalTotalSistema = valvulas.reduce((sum, v) => sum + v.caudalTotal, 0);
            data.push(['CAUDAL TOTAL', '', '', '', '', '', caudalTotalSistema.toFixed(2)]);
            
            doc.autoTable({
                startY: yPos,
                head: headers,
                body: data,
                margin: { left: 20 },
                theme: 'grid',
                headStyles: { fillColor: [23, 114, 175] },
                styles: { fontSize: 8 },
                columnStyles: {
                    0: { cellWidth: 20 },
                    6: { cellWidth: 25 }
                }
            });
            
            yPos = doc.lastAutoTable.finalY + 10;
        }
        
        if (cabezales.length > 0) {
            doc.setFontSize(14);
            doc.setTextColor(23, 114, 175);
            doc.text('4. CABEZAL DE BOMBEO Y FILTRACIÓN', 20, yPos);
            yPos += 10;
            
            cabezales.forEach(cabezal => {
                doc.setFontSize(11);
                doc.setTextColor(0, 0, 0);
                doc.text('Caudal de Bomba: ' + cabezal.caudalBomba + ' L/s', 25, yPos);
                yPos += 6;
                doc.text('Diámetro Succión: ' + cabezal.diametroSuccion, 25, yPos);
                yPos += 6;
                doc.text('Diámetro Descarga: ' + cabezal.diametroDescarga, 25, yPos);
                yPos += 6;
                doc.text('Número de Filtros: ' + cabezal.numeroFiltros, 25, yPos);
                yPos += 6;
                doc.text('Tipo de Filtros: ' + cabezal.tipoFiltros, 25, yPos);
                yPos += 6;
                if (cabezal.notas) {
                    doc.text('Notas: ' + cabezal.notas, 25, yPos);
                    yPos += 6;
                }
                yPos += 5;
            });
        }
        
        if (valvulas.length > 0) {
            doc.setFontSize(14);
            doc.setTextColor(23, 114, 175);
            doc.text('5. RESUMEN HIDRÁULICO', 20, yPos);
            yPos += 10;
            
            const caudalTotalSistema = valvulas.reduce((sum, v) => sum + v.caudalTotal, 0);
            const caudalLps = caudalTotalSistema / 3600;
            
            doc.setFontSize(11);
            doc.setTextColor(0, 0, 0);
            doc.text('Caudal Total Requerido: ' + caudalTotalSistema.toFixed(2) + ' L/h (' + caudalLps.toFixed(2) + ' L/s)', 25, yPos);
            yPos += 6;
            
            if (cabezales.length > 0) {
                const cabezalPrincipal = cabezales[0];
                const caudalCabezal = cabezalPrincipal.caudalBomba * 1000;
                const diferencia = caudalCabezal - caudalTotalSistema;
                const porcentaje = (diferencia / caudalCabezal) * 100;
                
                doc.text('Caudal Disponible (Cabezal): ' + caudalCabezal.toFixed(2) + ' L/h (' + cabezalPrincipal.caudalBomba + ' L/s)', 25, yPos);
                yPos += 6;
                doc.text('Diferencia: ' + diferencia.toFixed(2) + ' L/h (' + (diferencia / 3600).toFixed(2) + ' L/s)', 25, yPos);
                yPos += 6;
                doc.text('Estado: ' + (diferencia >= 0 ? 'Sobrecapacidad (' + porcentaje.toFixed(1) + '%)' : 'Deficit (' + Math.abs(porcentaje).toFixed(1) + '%)'), 25, yPos);
                yPos += 6;
            }
            
            if (areaTotal > 0) {
                const laminaPorHora = caudalTotalSistema / (areaTotal * 1000);
                const horasPara10mm = 10 / laminaPorHora;
                
                doc.text('Lámina de Riego por Hora: ' + laminaPorHora.toFixed(3) + ' mm/h', 25, yPos);
                yPos += 6;
                doc.text('Tiempo para 10 mm de riego: ' + horasPara10mm.toFixed(1) + ' horas', 25, yPos);
            }
        }
        
        const pageCount = doc.internal.getNumberOfPages();
        for (let i = 1; i <= pageCount; i++) {
            doc.setPage(i);
            doc.setFontSize(8);
            doc.setTextColor(100, 100, 100);
            doc.text('Página ' + i + ' de ' + pageCount, 105, 285, { align: 'center' });
            doc.text('Agrosistemas - www.agrosistemas.com', 105, 290, { align: 'center' });
        }
        
        doc.save('Memoria_Calculo_Riego_' + new Date().toISOString().slice(0, 10) + '.pdf');
        
        mostrarMensaje('PDF generado correctamente');
    }
    
    function guardarDiseño(nombre = null) {
        if (!nombre) {
            nombre = prompt('Nombre del diseño:', `Diseño_${new Date().toLocaleDateString()}`);
            if (!nombre) return;
        }
        
        const diseño = {
            id: Date.now(),
            nombre: nombre,
            fecha: new Date().toISOString(),
            area: areaTotal,
            tuberias: tuberias.map(t => ({
                tipo: t.tipo,
                puntoInicio: t.puntoInicio ? [t.puntoInicio.lat, t.puntoInicio.lng] : null,
                puntoFin: t.puntoFin ? [t.puntoFin.lat, t.puntoFin.lng] : null,
                longitud: t.longitud || 0,
                color: t.color,
                grosor: t.grosor,
                diametro: t.diametro,
                tipoMaterial: t.tipoMaterial,
                conexiones: t.conexiones || [],
                esConexion: t.esConexion || false
            })),
            elementos: elementosGraficos.filter(e => e.type === 'elemento').map(e => ({
                tipo: e.tipo,
                posicion: [e.posicion.lat, e.posicion.lng]
            })),
            valvulas: valvulas,
            cabezales: cabezales,
            puntosTuberias: puntosTuberias.map(p => ({
                tipo: p.tipo,
                latlng: [p.latlng.lat, p.latlng.lng],
                tuberiaId: p.tuberiaId,
                esInicio: p.esInicio
            }))
        };
        
        diseñosGuardados = JSON.parse(localStorage.getItem('diseñosRiego') || '[]');
        diseñosGuardados.push(diseño);
        localStorage.setItem('diseñosRiego', JSON.stringify(diseñosGuardados));
        
        mostrarMensaje(`Diseño "${nombre}" guardado correctamente`);
        actualizarGaleriaDiseños();
        
        return diseño;
    }
    
    function exportarDiseño() {
        const diseño = guardarDiseño('Exportado_' + Date.now());
        
        const dataStr = JSON.stringify(diseño, null, 2);
        const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
        
        const exportFileDefaultName = `diseño_riego_${Date.now()}.json`;
        
        const linkElement = document.createElement('a');
        linkElement.setAttribute('href', dataUri);
        linkElement.setAttribute('download', exportFileDefaultName);
        linkElement.click();
        
        mostrarMensaje('Diseño exportado como JSON');
    }
    
    function importarDiseño(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const diseño = JSON.parse(e.target.result);
                cargarDiseño(diseño);
                mostrarMensaje(`Diseño "${diseño.nombre}" importado correctamente`);
            } catch (error) {
                alert('Error al importar el diseño: ' + error.message);
            }
        };
        reader.readAsText(file);
    }
    
    function cargarDiseño(diseño) {
        limpiarDiseño();
        
        if (diseño.puntosTuberias) {
            puntosTuberias = diseño.puntosTuberias.map(p => ({
                tipo: p.tipo,
                latlng: L.latLng(p.latlng[0], p.latlng[1]),
                tuberiaId: p.tuberiaId,
                esInicio: p.esInicio
            }));
        }
        
        if (diseño.tuberias) {
            diseño.tuberias.forEach(tData => {
                if (tData.puntoInicio && tData.puntoFin) {
                    const puntoInicio = L.latLng(tData.puntoInicio[0], tData.puntoInicio[1]);
                    const puntoFin = L.latLng(tData.puntoFin[0], tData.puntoFin[1]);
                    
                    const marcadorInicio = crearMarcadorTuberia(puntoInicio, 'inicio', tData.tipo, tData.diametro);
                    marcadorInicio.addTo(map);
                    
                    const marcadorFin = crearMarcadorTuberia(puntoFin, 'fin', tData.tipo, tData.diametro);
                    marcadorFin.addTo(map);
                    
                    const linea = dibujarLineaTuberia(puntoInicio, puntoFin, tData.tipo, tData.diametro);
                    
                    const centro = L.latLng(
                        (puntoInicio.lat + puntoFin.lat) / 2,
                        (puntoInicio.lng + puntoFin.lng) / 2
                    );
                    
                    const etiqueta = L.marker(centro, {
                        icon: L.divIcon({
                            className: 'tuberia-label',
                            html: `<div style="background: white; padding: 2px 5px; border: 1px solid #ccc; border-radius: 3px; font-size: 9px; font-weight: bold;">
                                   ${tData.longitud.toFixed(1)}m - ${tData.diametro}"</div>`,
                            iconSize: [80, 20],
                            iconAnchor: [40, 10]
                        })
                    }).addTo(map);
                    
                    const tuberia = {
                        id: tData.id || Date.now() + Math.random(),
                        tipo: tData.tipo,
                        puntoInicio: puntoInicio,
                        puntoFin: puntoFin,
                        color: tData.color,
                        grosor: tData.grosor,
                        diametro: tData.diametro,
                        tipoMaterial: tData.tipoMaterial,
                        longitud: tData.longitud,
                        conexiones: tData.conexiones || [],
                        esConexion: tData.esConexion || false,
                        marcadorInicio: marcadorInicio,
                        marcadorFin: marcadorFin,
                        linea: linea,
                        etiquetaLongitud: etiqueta
                    };
                    
                    tuberias.push(tuberia);
                }
            });
        }
        
        if (diseño.elementos) {
            diseño.elementos.forEach(eData => {
                agregarElementoGrafico(L.latLng(eData.posicion[0], eData.posicion[1]), eData.tipo);
            });
        }
        
        if (diseño.valvulas) {
            valvulas = diseño.valvulas.map(v => ({
                ...v,
                posicion: v.posicion ? L.latLng(v.posicion[0], v.posicion[1]) : null
            }));
        }
        
        if (diseño.cabezales) {
            cabezales = diseño.cabezales.map(c => ({
                ...c,
                posicion: c.posicion ? L.latLng(c.posicion[0], c.posicion[1]) : null
            }));
        }
        
        if (diseño.area) {
            areaTotal = diseño.area;
            document.getElementById('areaDisplay').textContent = 
                `Área: ${areaTotal.toFixed(2)} m² (${(areaTotal / 10000).toFixed(2)} ha)`;
        }
        
        actualizarResumenTuberias();
        actualizarResultados();
        
        if (areaTotal > 0) {
            ocultarControlesMapa();
        }
    }
    
    function limpiarDiseño() {
        tuberias.forEach(t => {
            if (t.marcadorInicio) map.removeLayer(t.marcadorInicio);
            if (t.marcadorFin) map.removeLayer(t.marcadorFin);
            if (t.linea) map.removeLayer(t.linea);
            if (t.etiquetaLongitud) map.removeLayer(t.etiquetaLongitud);
        });
        tuberias = [];
        
        puntosTuberias = [];
        
        elementosGraficos.forEach(e => map.removeLayer(e.layer));
        elementosGraficos = [];
        
        drawnItems.clearLayers();
        areaTotal = 0;
        document.getElementById('areaDisplay').textContent = 'Área: 0 m²';
        
        valvulas = [];
        cabezales = [];
        
        actualizarResumenTuberias();
        actualizarResultados();
        
        mostrarControlesMapa();
        
        modoDibujoTuberia = null;
        tuberiaActual = null;
        puntoInicioTuberia = null;
        modoAgregarElemento = null;
        
        modoConexion = false;
        tuberiaConexionTipo = null;
        puntoOrigenConexion = null;
        
        document.querySelectorAll('.tuberia-btn').forEach(btn => {
            btn.classList.remove('activo');
            btn.classList.remove('modo-conexion-activo');
        });
        
        document.querySelectorAll('.elemento-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        
        document.getElementById('instruccionesPrincipal').style.display = 'none';
        document.getElementById('instruccionesSecundaria').style.display = 'none';
        document.getElementById('instruccionesRegante').style.display = 'none';
        document.getElementById('instruccionesElementos').style.display = 'none';
        
        quitarResaltadoPuntos();
    }
    
    function actualizarGaleriaDiseños() {
        const galeriaDiv = document.getElementById('galeriaDiseños');
        diseñosGuardados = JSON.parse(localStorage.getItem('diseñosRiego') || '[]');
        
        if (diseñosGuardados.length === 0) {
            galeriaDiv.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No hay diseños guardados</p>';
            return;
        }
        
        diseñosGuardados.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
        
        let html = '<div class="diseños-lista">';
        
        diseñosGuardados.forEach((diseño, index) => {
            const fecha = new Date(diseño.fecha).toLocaleDateString();
            const hora = new Date(diseño.fecha).toLocaleTimeString();
            html += `
                <div class="diseño-item" style="background: #f8f9fa; padding: 15px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #eee;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>${diseño.nombre}</strong><br>
                            <small style="color: #666;">${fecha} ${hora} | Área: ${diseño.area ? diseño.area.toFixed(2) + ' m²' : 'No definida'}</small><br>
                            <small style="color: #666;">Tuberías: ${diseño.tuberias ? diseño.tuberias.length : 0} | Elementos: ${diseño.elementos ? diseño.elementos.length : 0}</small>
                        </div>
                        <div>
                            <button class="mapa-btn" onclick="cargarDiseño(${JSON.stringify(diseño).replace(/"/g, '&quot;')})" 
                                    style="padding: 5px 10px; font-size: 0.8rem; margin-right: 5px;">
                                <i class="fas fa-edit"></i> Abrir
                            </button>
                            <button class="mapa-btn secondary" onclick="eliminarDiseño(${index})" 
                                    style="padding: 5px 10px; font-size: 0.8rem;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
        galeriaDiv.innerHTML = html;
    }
    
    function eliminarDiseño(index) {
        if (confirm('¿Eliminar este diseño?')) {
            diseñosGuardados.splice(index, 1);
            localStorage.setItem('diseñosRiego', JSON.stringify(diseñosGuardados));
            actualizarGaleriaDiseños();
            mostrarMensaje('Diseño eliminado');
        }
    }
    
    function mostrarMensaje(mensaje) {
        let mensajeDiv = document.getElementById('mensajeTemporal');
        if (!mensajeDiv) {
            mensajeDiv = document.createElement('div');
            mensajeDiv.id = 'mensajeTemporal';
            mensajeDiv.style.cssText = `
                position: fixed;
                top: 100px;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(0, 0, 0, 0.8);
                color: white;
                padding: 10px 20px;
                border-radius: 5px;
                z-index: 10000;
                font-size: 0.9rem;
                pointer-events: none;
            `;
            document.body.appendChild(mensajeDiv);
        }
        
        mensajeDiv.textContent = mensaje;
        mensajeDiv.style.display = 'block';
        
        setTimeout(() => {
            mensajeDiv.style.display = 'none';
        }, 3000);
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        initMap();
        
        const mobileMenuBtn = document.getElementById('mobileMenuBtn');
        const mainNav = document.getElementById('mainNav');
        const mainHeader = document.getElementById('mainHeader');
        
        mobileMenuBtn.addEventListener('click', function() {
            mainNav.classList.toggle('active');
            
            const icon = mobileMenuBtn.querySelector('i');
            if (mainNav.classList.contains('active')) {
                icon.classList.remove('fa-bars');
                icon.classList.add('fa-times');
                document.body.style.overflow = 'hidden';
            } else {
                icon.classList.remove('fa-times');
                icon.classList.add('fa-bars');
                document.body.style.overflow = '';
            }
        });
        
        const navLinks = document.querySelectorAll('#mainNav a');
        navLinks.forEach(link => {
            link.addEventListener('click', function() {
                mainNav.classList.remove('active');
                mobileMenuBtn.querySelector('i').classList.remove('fa-times');
                mobileMenuBtn.querySelector('i').classList.add('fa-bars');
                document.body.style.overflow = '';
            });
        });
        
        window.addEventListener('scroll', function() {
            if (window.scrollY > 50) {
                mainHeader.classList.add('scrolled');
            } else {
                mainHeader.classList.remove('scrolled');
            }
        });
        
        const observerOptions = {
            threshold: 0.1,
            rootMargin: '0px 0px -50px 0px'
        };
        
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('visible');
                }
            });
        }, observerOptions);
        
        document.querySelectorAll('.fade-in').forEach(el => {
            observer.observe(el);
        });
        
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function(e) {
                const href = this.getAttribute('href');
                if (href !== '#' && !href.includes('.html')) {
                    e.preventDefault();
                    const targetElement = document.querySelector(href);
                    if (targetElement) {
                        window.scrollTo({
                            top: targetElement.offsetTop - 100,
                            behavior: 'smooth'
                        });
                    }
                }
            });
        });
        
        document.getElementById('searchBtn').addEventListener('click', buscarUbicacion);
        
        document.getElementById('location-search').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                buscarUbicacion();
            }
        });
        
        document.getElementById('drawPolygonBtn').addEventListener('click', function() {
            if (currentDrawMode) {
                currentDrawMode.disable();
                currentDrawMode = null;
            }
            
            if (tuberiaActual) {
                tuberiaActual = null;
                puntoInicioTuberia = null;
                
                document.querySelectorAll('.tuberia-btn').forEach(btn => {
                    btn.classList.remove('activo');
                });
                
                document.getElementById('instruccionesPrincipal').style.display = 'none';
                document.getElementById('instruccionesSecundaria').style.display = 'none';
                document.getElementById('instruccionesRegante').style.display = 'none';
            }
            
            if (modoAgregarElemento) {
                modoAgregarElemento = null;
                document.getElementById('instruccionesElementos').style.display = 'none';
                
                document.querySelectorAll('.elemento-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
            }
            
            if (modoConexion) {
                modoConexion = false;
                tuberiaConexionTipo = null;
                puntoOrigenConexion = null;
                
                document.querySelectorAll('.tuberia-btn').forEach(btn => {
                    btn.classList.remove('modo-conexion-activo');
                });
            }
            
            currentDrawMode = new L.Draw.Polygon(map, drawControl.options.draw.polygon);
            currentDrawMode.enable();
            
            document.getElementById('hideControlsBtn').style.display = 'block';
            
            this.innerHTML = '<i class="fas fa-hand-pointer"></i> Click para dibujar';
            this.style.backgroundColor = '#ff6b6b';
            
            setTimeout(() => {
                this.innerHTML = '<i class="fas fa-draw-polygon"></i> Delimitar Terreno';
                this.style.backgroundColor = '';
            }, 5000);
            
            mostrarMensaje('Haz clic en el mapa para iniciar el polígono. Doble clic para finalizar.');
        });
        
        document.getElementById('measureBtn').addEventListener('click', function() {
            if (currentDrawMode) {
                currentDrawMode.disable();
                currentDrawMode = null;
            }
            
            if (tuberiaActual) {
                tuberiaActual = null;
                puntoInicioTuberia = null;
                
                document.querySelectorAll('.tuberia-btn').forEach(btn => {
                    btn.classList.remove('activo');
                });
                
                document.getElementById('instruccionesPrincipal').style.display = 'none';
                document.getElementById('instruccionesSecundaria').style.display = 'none';
                document.getElementById('instruccionesRegante').style.display = 'none';
            }
            
            if (modoAgregarElemento) {
                modoAgregarElemento = null;
                document.getElementById('instruccionesElementos').style.display = 'none';
                
                document.querySelectorAll('.elemento-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
            }
            
            if (modoConexion) {
                modoConexion = false;
                tuberiaConexionTipo = null;
                puntoOrigenConexion = null;
                
                document.querySelectorAll('.tuberia-btn').forEach(btn => {
                    btn.classList.remove('modo-conexion-activo');
                });
            }
            
            currentDrawMode = new L.Draw.Polyline(map, drawControl.options.draw.polyline);
            currentDrawMode.enable();
            
            this.innerHTML = '<i class="fas fa-hand-pointer"></i> Click para medir';
            this.style.backgroundColor = '#ff6b6b';
            
            setTimeout(() => {
                this.innerHTML = '<i class="fas fa-ruler"></i> Medir';
                this.style.backgroundColor = '';
            }, 5000);
            
            mostrarMensaje('Haz clic en el mapa para iniciar la medición. Doble clic para finalizar.');
        });
        
        document.getElementById('clearBtn').addEventListener('click', function() {
            limpiarDiseño();
            mostrarMensaje('Diseño limpiado completamente');
        });
        
        document.getElementById('hideControlsBtn').addEventListener('click', function() {
            ocultarControlesMapa();
            mostrarMensaje('Controles ocultados');
        });
        
        document.getElementById('showControlsBtn').addEventListener('click', function() {
            mostrarControlesMapa();
            mostrarMensaje('Controles mostrados');
        });
        
        document.querySelectorAll('.cad-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                const tabId = this.dataset.tab;
                
                document.querySelectorAll('.cad-tab').forEach(t => {
                    t.classList.remove('active');
                });
                
                this.classList.add('active');
                
                document.querySelectorAll('.cad-tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                
                document.getElementById(tabId + '-tab').classList.add('active');
                
                if (tabId === 'resultados') {
                    actualizarResultados();
                }
            });
        });
        
        document.getElementById('btnTuberiaPrincipal').addEventListener('click', function() {
            iniciarModoTuberia('principal');
        });
        
        document.getElementById('btnTuberiaSecundaria').addEventListener('click', function() {
            iniciarModoTuberia('secundaria');
        });
        
        document.getElementById('btnTuberiaRegante').addEventListener('click', function() {
            iniciarModoTuberia('regante');
        });
        
        document.getElementById('btnConectarPrincipal').addEventListener('click', function() {
            iniciarModoConexion('principal');
        });
        
        document.getElementById('btnConectarSecundaria').addEventListener('click', function() {
            iniciarModoConexion('secundaria');
        });
        
        document.getElementById('btnConectarRegante').addEventListener('click', function() {
            iniciarModoConexion('regante');
        });
        
        actualizarConfiguracionElemento('cabezal');
        actualizarResultados();
        actualizarGaleriaDiseños();
    });
</script>
</body>
</html>