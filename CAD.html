<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Diseñador de Riego CAD - Agrosistemas</title>
    <link rel="icon" type="image/webp" href="favicon.webp">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Leaflet CSS (OpenStreetMap) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    
    <!-- Leaflet Draw CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>
    
    <!-- jsPDF para exportación a PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <!-- Para captura de pantalla -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        /* Reset y estilos base */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }
        
        body {
            color: #333;
            line-height: 1.6;
            background-color: #FFFFFF;
            overflow-x: hidden;
            width: 100vw;
            max-width: 100vw;
            position: relative;
        }
        
        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        a {
            text-decoration: none;
            color: inherit;
        }
        
        ul {
            list-style: none;
        }
        
        .btn {
            display: inline-block;
            background-color: #00a553;
            color: white;
            padding: 14px 32px;
            border-radius: 50px;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            letter-spacing: 0.5px;
        }
        
        .btn:hover {
            background-color: #008a45;
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 165, 83, 0.3);
        }
        
        .btn-secondary {
            background-color: #1772af;
        }
        
        .btn-secondary:hover {
            background-color: #145c92;
            box-shadow: 0 8px 20px rgba(23, 114, 175, 0.3);
        }
        
        .section-title {
            text-align: center;
            margin-bottom: 50px;
            color: #111;
            font-size: 2.4rem;
            font-weight: 700;
        }
        
        /* Header */
        header {
            background-color: #FFFFFF;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 1000;
            transition: all 0.3s ease;
        }
        
        header.scrolled {
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.08);
        }
        
        .main-header {
            padding: 20px 0;
        }
        
        .main-header .container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            height: 100px;
            display: flex;
            align-items: center;
        }
        
        .logo img {
            height: 100px;
            width: auto;
        }
        
        .mobile-menu-btn {
            display: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #111;
            background: none;
            border: none;
            padding: 5px;
        }
        
        /* Hero Section - Específico para Diseñador CAD */
        .page-hero {
            background: linear-gradient(135deg, rgba(0, 165, 83, 0.9) 0%, rgba(23, 114, 175, 0.9) 100%);
            color: white;
            padding: 160px 0 80px;
            text-align: center;
            margin-top: 80px;
        }
        
        .page-hero h1 {
            font-size: 3.5rem;
            margin-bottom: 20px;
            font-weight: 700;
            line-height: 1.1;
        }
        
        .page-hero p {
            font-size: 1.3rem;
            max-width: 800px;
            margin: 0 auto 40px;
            opacity: 0.9;
        }
        
        /* Diseñador de Riego CAD */
        .disenador-riego {
            padding: 80px 0;
            background-color: #f8f9fa;
            min-height: calc(100vh - 140px);
            width: 100%;
            max-width: 100vw;
            overflow: hidden;
        }
        
        .disenador-intro {
            text-align: center;
            max-width: 800px;
            margin: 0 auto 40px;
            color: #666;
            font-size: 1.1rem;
        }
        
        .disenador-grid {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 30px;
            height: 700px;
            width: 100%;
            min-height: 700px;
        }
        
        @media (max-width: 992px) {
            .disenador-grid {
                grid-template-columns: 1fr;
                height: auto;
                min-height: auto;
            }
        }
        
        /* Panel del Mapa */
        .mapa-panel {
            background-color: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            height: 100%;
            display: flex;
            flex-direction: column;
            min-height: 600px;
            position: relative;
        }
        
        .mapa-header {
            padding: 20px;
            background-color: #1772af;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 60px;
        }
        
        .mapa-header h3 {
            font-size: 1.3rem;
            margin: 0;
        }
        
        .mapa-container {
            flex: 1;
            position: relative;
            min-height: 500px;
            width: 100%;
            height: 100%;
        }
        
        #map {
            width: 100%;
            height: 100%;
            min-height: 500px;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }
        
        .mapa-controls {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1000;
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.1);
            width: 300px;
        }
        
        .search-container {
            margin-bottom: 15px;
        }
        
        #location-search {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        .mapa-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .mapa-btn {
            background-color: #00a553;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            flex: 1;
            min-width: 120px;
        }
        
        .mapa-btn:hover {
            background-color: #008a45;
        }
        
        .mapa-btn.secondary {
            background-color: #1772af;
        }
        
        .mapa-btn.secondary:hover {
            background-color: #145c92;
        }
        
        .area-display {
            background-color: rgba(0,0,0,0.7);
            color: white;
            padding: 10px 15px;
            border-radius: 4px;
            margin-top: 10px;
            font-size: 0.9rem;
        }
        
        /* Panel de Diseño CAD */
        .cad-panel {
            background-color: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            height: 100%;
            display: flex;
            flex-direction: column;
            min-height: 700px;
        }
        
        .cad-header {
            padding: 20px;
            background-color: #00a553;
            color: white;
        }
        
        .cad-header h3 {
            font-size: 1.3rem;
            margin: 0 0 10px 0;
        }
        
        .cad-header p {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .cad-tabs {
            display: flex;
            background-color: #f0f0f0;
            border-bottom: 1px solid #ddd;
            min-height: 50px;
        }
        
        .cad-tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
        }
        
        .cad-tab.active {
            background-color: white;
            color: #00a553;
            border-bottom: 3px solid #00a553;
        }
        
        .cad-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            max-height: calc(700px - 140px);
        }
        
        .cad-tab-content {
            display: none;
            height: 100%;
        }
        
        .cad-tab-content.active {
            display: block;
        }
        
        .cad-controls {
            margin-bottom: 20px;
        }
        
        .control-group {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .control-group h4 {
            margin-bottom: 10px;
            color: #333;
            font-size: 1.1rem;
        }
        
        .control-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .control-label {
            width: 120px;
            font-size: 0.9rem;
            color: #666;
        }
        
        select, input[type="number"], input[type="text"], textarea {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        .color-indicator {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 10px;
        }
        
        /* Colores para tipos de tubería */
        .color-principal {
            background-color: #ff6b6b;
        }
        
        .color-secundaria {
            background-color: #4ecdc4;
        }
        
        .color-regante {
            background-color: #45b7d1;
        }
        
        .elementos-lista {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        
        .elemento-btn {
            background-color: #f0f0f0;
            border: 1px solid #ddd;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s;
        }
        
        .elemento-btn:hover {
            background-color: #e0e0e0;
        }
        
        .elemento-btn.active {
            background-color: #00a553;
            color: white;
            border-color: #00a553;
        }
        
        /* Nuevos estilos para los cambios solicitados */
        .tuberia-btn.conexion-btn {
            background-color: #ff9f43;
            border-color: #ff9f43;
            color: white;
        }
        
        .tuberia-btn.conexion-btn:hover {
            background-color: #e6892f;
        }
        
        .tuberia-btn.modo-conexion-activo {
            background-color: #ff9f43 !important;
            color: white !important;
            border-color: #ff9f43 !important;
        }
        
        .punto-activo {
            animation: pulse 1s infinite;
            box-shadow: 0 0 0 5px rgba(255, 107, 107, 0.5) !important;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 107, 107, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0); }
        }
        
        /* Estilos para la pestaña de resultados */
        .resultados-tab {
            max-height: 500px;
            overflow-y: auto;
        }
        
        .resultado-seccion {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .resultado-titulo {
            color: #1772af;
            margin-bottom: 10px;
            font-size: 1.2rem;
        }
        
        .resultado-tabla {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 0.9rem;
        }
        
        .resultado-tabla th {
            background-color: #f8f9fa;
            padding: 8px 12px;
            text-align: left;
            font-weight: 600;
            border: 1px solid #ddd;
        }
        
        .resultado-tabla td {
            padding: 8px 12px;
            border: 1px solid #ddd;
        }
        
        .resultado-tabla tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        .btn-export-pdf {
            width: 100%;
            margin-top: 15px;
            background-color: #e74c3c;
        }
        
        .btn-export-pdf:hover {
            background-color: #c0392b;
        }
        
        /* Estilos para vista previa */
        .modal-vista-previa {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 10000;
            display: flex;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease;
        }
        
        .modal-contenido {
            background: white;
            border-radius: 10px;
            padding: 20px;
            max-width: 95%;
            max-height: 95%;
            animation: zoomIn 0.3s ease;
            position: relative;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes zoomIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        .cad-resumen {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .cad-resumen h4 {
            margin-bottom: 10px;
            color: #1772af;
        }
        
        .resumen-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }
        
        .secciones-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .seccion-item {
            background-color: #f0f0f0;
            padding: 10px;
            border-radius: 4px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .seccion-item:hover {
            background-color: #e0e0e0;
        }
        
        .seccion-item.active {
            background-color: #00a553;
            color: white;
        }
        
        .seccion-config {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }
        
        /* Panel de Emisores */
        .emisor-panel {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .emisor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .emisor-header h4 {
            color: #333;
            margin: 0;
        }
        
        .emisor-info {
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
            border: 1px solid #eee;
        }
        
        /* Estilos adicionales para el sistema CAD mejorado */
        .tuberia-label {
            pointer-events: none !important;
        }

        .elemento-grafico {
            cursor: move !important;
        }

        .diseños-lista {
            max-height: 300px;
            overflow-y: auto;
        }

        .diseño-item:hover {
            background-color: #e8f4fd !important;
            border-color: #00a553 !important;
        }

        .galeria-acciones {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        .galeria-acciones .btn {
            padding: 10px 15px;
            font-size: 0.9rem;
        }

        /* Botón para importar que se vea como botón */
        .btn-secondary input[type="file"] {
            display: none;
        }

        .instrucciones-tuberia {
            background-color: #e8f4fd;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-size: 0.85rem;
            color: #1772af;
            border-left: 3px solid #1772af;
        }

        .tuberia-btn {
            background-color: #f0f0f0;
            border: 1px solid #ddd;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            transition: all 0.3s;
            width: 100%;
            justify-content: center;
            margin-top: 10px;
        }

        .tuberia-btn:hover {
            background-color: #e0e0e0;
        }

        .tuberia-btn.activo {
            background-color: #00a553;
            color: white;
            border-color: #00a553;
        }
        
        /* Estilos de navegación */
        nav ul {
            display: flex;
            gap: 35px;
        }
        
        nav ul li a {
            font-weight: 600;
            color: #111;
            padding: 8px 0;
            position: relative;
            font-size: 1rem;
            transition: color 0.3s;
        }
        
        nav ul li a:hover {
            color: #00a553;
        }
        
        nav ul li a:after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 0;
            height: 2px;
            background-color: #00a553;
            transition: width 0.3s;
        }
        
        nav ul li a:hover:after {
            width: 100%;
        }
        
        .current-page {
            color: #00a553 !important;
        }
        
        .current-page:after {
            width: 100% !important;
        }
        
        /* Scroll suave */
        html {
            scroll-behavior: smooth;
        }
        
        /* Animaciones */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .fade-in {
            opacity: 0;
            animation: fadeInUp 0.6s ease forwards;
        }
        
        .fade-in.delay-1 {
            animation-delay: 0.2s;
        }
        
        .fade-in.delay-2 {
            animation-delay: 0.4s;
        }
        
        /* Footer */
        footer {
            background-color: #FFFFFF;
            color: #333;
            padding: 60px 0 30px;
            text-align: center;
            border-top: 1px solid #f0f0f0;
        }
        
        .footer-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 30px;
        }
        
        .footer-logo {
            margin-bottom: 10px;
        }
        
        .footer-logo img {
            height: 100px;
            width: auto;
        }
        
        .footer-text {
            color: #666;
            max-width: 600px;
            margin: 0 auto;
            line-height: 1.7;
        }
        
        .copyright {
            padding-top: 30px;
            border-top: 1px solid #f0f0f0;
            font-size: 0.9rem;
            color: #888;
            width: 100%;
            margin-top: 20px;
        }
        
        /* Responsive mejorado para móviles y tablets */
        @media (max-width: 1200px) {
            .container {
                max-width: 95%;
                padding: 0 15px;
            }
        }
        
        @media (max-width: 992px) {
            .page-hero h1 {
                font-size: 2.8rem;
            }
            
            .section-title {
                font-size: 2.2rem;
            }
            
            .disenador-grid {
                grid-template-columns: 1fr;
                gap: 20px;
                height: auto;
            }
            
            .mapa-panel {
                height: 500px;
            }
            
            .cad-panel {
                height: auto;
                min-height: 600px;
            }
            
            .cad-content {
                max-height: 500px;
            }
        }
        
        @media (max-width: 768px) {
            .mobile-menu-btn {
                display: block;
            }
            
            nav {
                position: fixed;
                top: 0;
                right: -100%;
                width: 280px;
                height: 100vh;
                background-color: #FFFFFF;
                box-shadow: -5px 0 25px rgba(0,0,0,0.1);
                transition: right 0.3s;
                z-index: 1001;
                padding: 90px 30px 30px;
            }
            
            nav.active {
                right: 0;
            }
            
            nav ul {
                flex-direction: column;
                gap: 20px;
            }
            
            nav ul li a {
                font-weight: 600;
                color: #111;
                font-size: 1.1rem;
                display: block;
                padding: 10px 0;
            }
            
            .page-hero {
                padding: 140px 0 60px;
                margin-top: 80px;
            }
            
            .page-hero h1 {
                font-size: 2.4rem;
            }
            
            .page-hero p {
                font-size: 1.1rem;
            }
            
            .section-title {
                font-size: 2rem;
                margin-bottom: 40px;
            }
            
            .disenador-riego {
                padding: 50px 0;
            }
            
            .mapa-panel {
                height: 450px;
            }
            
            .mapa-controls {
                position: relative;
                top: 0;
                left: 0;
                width: 100%;
                margin-bottom: 15px;
                box-shadow: none;
                border-radius: 0;
            }
            
            #map {
                height: 400px;
            }
            
            .cad-tabs {
                flex-wrap: wrap;
            }
            
            .cad-tab {
                min-width: 25%;
                padding: 12px 5px;
                font-size: 0.9rem;
            }
            
            .cad-content {
                padding: 15px;
            }
            
            .control-row {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .control-label {
                width: 100%;
                margin-bottom: 5px;
            }
        }
        
        @media (max-width: 480px) {
            .page-hero h1 {
                font-size: 2rem;
            }
            
            .page-hero p {
                font-size: 1rem;
            }
            
            .mapa-panel {
                height: 400px;
            }
            
            #map {
                height: 350px;
            }
            
            .mapa-header {
                padding: 15px;
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .cad-tab {
                min-width: 50%;
                font-size: 0.8rem;
                padding: 10px 5px;
            }
            
            .btn {
                padding: 12px 24px;
                font-size: 0.9rem;
            }
            
            .galeria-acciones {
                flex-direction: column;
            }
            
            .galeria-acciones .btn {
                width: 100%;
            }
        }
        
        /* Orientación landscape para móviles y tablets */
        @media (max-width: 992px) and (orientation: landscape) {
            .disenador-riego {
                padding: 40px 0;
            }
            
            .disenador-grid {
                grid-template-columns: 1fr 300px;
                height: 500px;
            }
            
            .mapa-panel {
                height: 450px;
            }
            
            .cad-panel {
                height: 450px;
            }
            
            .cad-content {
                max-height: 350px;
            }
            
            .page-hero {
                padding: 120px 0 40px;
            }
        }
        
        /* iOS specific fixes */
        @supports (-webkit-touch-callout: none) {
            .disenador-grid {
                min-height: auto;
            }
            
            .mapa-panel, .cad-panel {
                min-height: auto;
            }
            
            .cad-content {
                -webkit-overflow-scrolling: touch;
            }
        }
        
        /* Android specific fixes */
        @media screen and (-webkit-min-device-pixel-ratio: 0) and (max-width: 768px) {
            select, input, textarea {
                font-size: 16px !important; /* Previene zoom en iOS */
            }
        }
        
        /* Pantallas pequeñas portrait */
        @media (max-width: 360px) {
            .page-hero h1 {
                font-size: 1.8rem;
            }
            
            .section-title {
                font-size: 1.8rem;
            }
            
            .mapa-panel {
                height: 350px;
            }
            
            #map {
                height: 300px;
            }
            
            .cad-tab {
                font-size: 0.75rem;
                padding: 8px 3px;
            }
        }
        
        /* Ajustes para tablets grandes */
        @media (min-width: 769px) and (max-width: 1024px) {
            .disenador-grid {
                grid-template-columns: 1fr 320px;
                height: 650px;
            }
            
            .mapa-panel {
                height: 600px;
            }
            
            .cad-panel {
                height: 600px;
            }
            
            .cad-content {
                max-height: 480px;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header id="mainHeader">
        <div class="main-header">
            <div class="container">
                <div class="logo">
                    <img src="logo.png" alt="Agrosistemas Logo">
                </div>
                <button class="mobile-menu-btn" id="mobileMenuBtn">
                    <i class="fas fa-bars"></i>
                </button>
                <nav id="mainNav">
                    <ul>
                        <li><a href="index.html">Inicio</a></li>
                        <li><a href="asesoriaTecnica.html">Asesoría Técnica</a></li>
                        <li><a href="sistemaDeRiego.html">Sistemas de Riego</a></li>
                        <li><a href="energiaSolar.html">Energía Solar</a></li>
                        <li><a href="equipamientoAgricola.html">Equipamiento</a></li>
                        <li><a href="CAD.html" class="current-page">Diseñador CAD</a></li>
                        <li><a href="#contacto">Contacto</a></li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>

    <!-- Hero Section -->
    <section class="page-hero">
        <div class="container">
            <h1 class="fade-in">Diseñador de Sistemas de Riego CAD</h1>
            <p class="fade-in delay-1">Diseña y simula sistemas de riego de manera interactiva. Ubica tu predio, delimita secciones y configura tuberías, emisores y elementos del sistema con tecnología avanzada.</p>
            <a href="#disenador-riego" class="btn fade-in delay-2">Comenzar Diseño</a>
        </div>
    </section>

    <!-- Diseñador de Riego CAD -->
    <section class="disenador-riego" id="disenador-riego">
        <div class="container">
            <h2 class="section-title">Diseñador de Sistemas de Riego</h2>
            <p class="disenador-intro fade-in">Diseña tu sistema de riego de manera interactiva. Ubica tu predio en el mapa, delimita las secciones y configura tuberías, emisores y elementos del sistema.</p>
            
            <div class="disenador-grid">
                <!-- Panel del Mapa -->
                <div class="mapa-panel fade-in">
                    <div class="mapa-header">
                        <h3>Ubicación del Predio</h3>
                        <div class="area-display" id="areaDisplay">Área: 0 m²</div>
                    </div>
                    <div class="mapa-container">
                        <div id="map"></div>
                        <div class="mapa-controls" id="mapaControls">
                            <div class="search-container">
                                <input type="text" id="location-search" placeholder="Buscar ubicación...">
                                <button id="searchBtn" class="mapa-btn" style="margin-top: 5px; padding: 5px 10px; font-size: 0.8rem;">
                                    <i class="fas fa-search"></i> Buscar
                                </button>
                            </div>
                            <div class="mapa-buttons">
                                <button class="mapa-btn" id="drawPolygonBtn">
                                    <i class="fas fa-draw-polygon"></i> Delimitar Terreno
                                </button>
                                <button class="mapa-btn secondary" id="measureBtn">
                                    <i class="fas fa-ruler"></i> Medir
                                </button>
                                <button class="mapa-btn secondary" id="clearBtn">
                                    <i class="fas fa-trash"></i> Limpiar
                                </button>
                                <button class="mapa-btn secondary" id="hideControlsBtn" style="display: none;">
                                    <i class="fas fa-eye-slash"></i> Ocultar Controles
                                </button>
                                <button class="mapa-btn secondary" id="showControlsBtn" style="display: none;">
                                    <i class="fas fa-eye"></i> Mostrar Controles
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Panel de Diseño CAD -->
                <div class="cad-panel fade-in delay-1">
                    <div class="cad-header">
                        <h3>Diseño del Sistema de Riego</h3>
                        <p>Configura tuberías, emisores y elementos del sistema</p>
                    </div>
                    
                    <div class="cad-tabs">
                        <div class="cad-tab active" data-tab="tuberias">Tuberías</div>
                        <div class="cad-tab" data-tab="elementos">Elementos</div>
                        <div class="cad-tab" data-tab="resultados">Resultados</div>
                        <div class="cad-tab" data-tab="galeria">Galería</div>
                    </div>
                    
                    <div class="cad-content">
                        <!-- Pestaña de Tuberías -->
                        <div class="cad-tab-content active" id="tuberias-tab">
                            <div class="control-group">
                                <h4>Tubería Principal</h4>
                                <div class="control-row">
                                    <div class="control-label">Color:</div>
                                    <div class="color-indicator color-principal"></div>
                                    <div>Rojo (Grosor: 8px)</div>
                                </div>
                                <div class="control-row">
                                    <div class="control-label">Diámetro:</div>
                                    <select id="diametroPrincipal">
                                        <option value="2">2"</option>
                                        <option value="3">3"</option>
                                        <option value="4">4"</option>
                                        <option value="6">6"</option>
                                        <option value="8">8"</option>
                                        <option value="10">10"</option>
                                        <option value="12">12"</option>
                                        <option value="14">14"</option>
                                        <option value="16">16"</option>
                                        <option value="18">18"</option>
                                        <option value="20">20"</option>
                                    </select>
                                </div>
                                <div class="control-row">
                                    <div class="control-label">Tipo:</div>
                                    <select id="tipoPrincipal">
                                        <option value="pvc">PVC</option>
                                        <option value="manguera">Manguera</option>
                                    </select>
                                </div>
                                <button class="tuberia-btn" onclick="iniciarModoTuberia('principal')" id="btnTuberiaPrincipal">
                                    <i class="fas fa-pencil-alt"></i> Dibujar Tubería Principal
                                </button>
                                <button class="tuberia-btn conexion-btn" onclick="iniciarModoConexion('principal')" id="btnConectarPrincipal" style="margin-top: 5px;">
                                    <i class="fas fa-link"></i> Conectar Tuberías
                                </button>
                                <div class="instrucciones-tuberia" id="instruccionesPrincipal" style="display: none;">
                                    Haz clic en el mapa para iniciar la tubería. Click para agregar puntos. Doble click para finalizar.
                                </div>
                            </div>
                            
                            <div class="control-group">
                                <h4>Tubería Secundaria</h4>
                                <div class="control-row">
                                    <div class="control-label">Color:</div>
                                    <div class="color-indicator color-secundaria"></div>
                                    <div>Turquesa (Grosor: 6px)</div>
                                </div>
                                <div class="control-row">
                                    <div class="control-label">Diámetro:</div>
                                    <select id="diametroSecundaria">
                                        <option value="1">1"</option>
                                        <option value="1.5">1.5"</option>
                                        <option value="2">2"</option>
                                        <option value="3">3"</option>
                                        <option value="4">4"</option>
                                    </select>
                                </div>
                                <div class="control-row">
                                    <div class="control-label">Tipo:</div>
                                    <select id="tipoSecundaria">
                                        <option value="pvc">PVC</option>
                                        <option value="manguera">Manguera</option>
                                    </select>
                                </div>
                                <button class="tuberia-btn" onclick="iniciarModoTuberia('secundaria')" id="btnTuberiaSecundaria">
                                    <i class="fas fa-pencil-alt"></i> Dibujar Tubería Secundaria
                                </button>
                                <button class="tuberia-btn conexion-btn" onclick="iniciarModoConexion('secundaria')" id="btnConectarSecundaria" style="margin-top: 5px;">
                                    <i class="fas fa-link"></i> Conectar Tuberías
                                </button>
                                <div class="instrucciones-tuberia" id="instruccionesSecundaria" style="display: none;">
                                    Haz clic en el mapa para iniciar la tubería. Click para agregar puntos. Doble click para finalizar.
                                </div>
                            </div>
                            
                            <div class="control-group">
                                <h4>Tubería Regante</h4>
                                <div class="control-row">
                                    <div class="control-label">Color:</div>
                                    <div class="color-indicator color-regante"></div>
                                    <div>Azul (Grosor: 4px)</div>
                                </div>
                                <div class="control-row">
                                    <div class="control-label">Diámetro:</div>
                                    <select id="diametroRegante">
                                        <option value="0.5">1/2"</option>
                                        <option value="0.75">3/4"</option>
                                        <option value="1">1"</option>
                                    </select>
                                </div>
                                <div class="control-row">
                                    <div class="control-label">Tipo:</div>
                                    <select id="tipoRegante">
                                        <option value="pvc">PVC</option>
                                        <option value="manguera">Manguera</option>
                                    </select>
                                </div>
                                <button class="tuberia-btn" onclick="iniciarModoTuberia('regante')" id="btnTuberiaRegante">
                                    <i class="fas fa-pencil-alt"></i> Dibujar Tubería Regante
                                </button>
                                <button class="tuberia-btn conexion-btn" onclick="iniciarModoConexion('regante')" id="btnConectarRegante" style="margin-top: 5px;">
                                    <i class="fas fa-link"></i> Conectar Tuberías
                                </button>
                                <div class="instrucciones-tuberia" id="instruccionesRegante" style="display: none;">
                                    Haz clic en el mapa para iniciar la tubería. Click para agregar puntos. Doble click para finalizar.
                                </div>
                            </div>
                            
                            <div class="cad-resumen">
                                <h4>Resumen de Tuberías</h4>
                                <div id="resumenTuberiasDetallado">
                                    <!-- Aquí se mostrará el resumen detallado por diámetros -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- Pestaña de Elementos -->
                        <div class="cad-tab-content" id="elementos-tab">
                            <div class="control-group">
                                <h4>Agregar Elementos al Diseño</h4>
                                <div class="elementos-lista">
                                    <div class="elemento-btn active" data-elemento="cabezal" onclick="iniciarModoElemento('cabezal')">
                                        <i class="fas fa-gear"></i> Cabezal
                                    </div>
                                    <div class="elemento-btn" data-elemento="purgaterminal" onclick="iniciarModoElemento('purgaterminal')">
                                        <i class="fas fa-faucet"></i> Purgas/Terminales
                                    </div>
                                    <div class="elemento-btn" data-elemento="tomagua" onclick="iniciarModoElemento('tomagua')">
                                        <i class="fas fa-tint"></i> Toma de Agua
                                    </div>
                                    <div class="elemento-btn" data-elemento="valvula" onclick="iniciarModoElemento('valvula')">
                                        <i class="fas fa-toggle-on"></i> Válvula
                                    </div>
                                    <div class="elemento-btn" data-elemento="filtro" onclick="iniciarModoElemento('filtro')">
                                        <i class="fas fa-filter"></i> Filtro
                                    </div>
                                </div>
                                <div class="instrucciones-tuberia" id="instruccionesElementos" style="display: none;">
                                    Haz clic en el mapa para colocar el elemento seleccionado.
                                </div>
                            </div>
                            
                            <div class="control-group">
                                <h4>Configuración del Elemento</h4>
                                <div id="elementoConfig">
                                    <p>Selecciona un elemento para configurarlo</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Pestaña de Resultados -->
                        <div class="cad-tab-content resultados-tab" id="resultados-tab">
                            <div class="control-group">
                                <h4>Resultados del Diseño</h4>
                                <div id="resultadosCalculos">
                                    <!-- Aquí se mostrarán todos los cálculos -->
                                </div>
                                <button class="btn btn-export-pdf" onclick="exportarPDF()">
                                    <i class="fas fa-file-pdf"></i> Exportar a PDF
                                </button>
                            </div>
                        </div>
                        
                        <!-- Pestaña de Galería -->
                        <div class="cad-tab-content" id="galeria-tab">
                            <div class="control-group">
                                <h4>Diseños Guardados</h4>
                                <div class="galeria-acciones">
                                    <button class="btn" onclick="guardarDiseño()" style="margin-right: 10px;">
                                        <i class="fas fa-save"></i> Guardar Actual
                                    </button>
                                    <button class="btn btn-secondary" onclick="exportarDiseño()">
                                        <i class="fas fa-download"></i> Exportar JSON
                                    </button>
                                    <label class="btn btn-secondary" style="display: inline-block; cursor: pointer;">
                                        <i class="fas fa-upload"></i> Importar JSON
                                        <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importarDiseño(event)">
                                    </label>
                                </div>
                                <div class="control-group">
                                    <h4>Captura para PDF</h4>
                                    <div class="galeria-acciones">
                                        <button class="btn" onclick="capturarDiseñoActual()">
                                            <i class="fas fa-camera"></i> Capturar Diseño Actual
                                        </button>
                                        <button class="btn" onclick="forzarRecaptura()" style="background-color: #ff9f43;">
                                            <i class="fas fa-sync-alt"></i> Nueva Captura
                                        </button>
                                    </div>
                                    <div id="capturaStatus" style="margin-top: 10px; min-height: 60px;">
                                        <!-- Estado de la captura aparecerá aquí -->
                                    </div>
                                </div>
                                
                                <div class="galeria-diseños" id="galeriaDiseños" style="margin-top: 20px; max-height: 300px; overflow-y: auto;">
                                    <!-- Diseños se cargarán aquí -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer id="contacto">
        <div class="container">
            <div class="footer-content">
                <div class="footer-logo">
                    <img src="logo.png" alt="Agrosistemas Logo">
                </div>
                <p class="footer-text">Especialistas en soluciones agrícolas integrales. Diseñamos sistemas de riego eficientes con tecnología de punta.</p>
                <div class="copyright">
                    &copy; 2024 Agrosistemas. Todos los derechos reservados. | Diseñador de Riego CAD v1.0
                </div>
            </div>
        </div>
    </footer>

    <!-- Scripts -->
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    <!-- Leaflet Draw JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    
    <script>
        // ============================================
        // VARIABLES GLOBALES
        // ============================================
        let map;
        let drawnItems;
        let drawControl;
        let currentDrawMode = null;
        let areaTotal = 0;
        let selectedElement = 'cabezal';
        let valvulas = [];
        let tuberias = [];
        let elementosGraficos = [];
        let modoDibujoTuberia = null;
        let tuberiaActual = null;
        let puntoInicioTuberia = null;
        let diseñosGuardados = [];
        let modoAgregarElemento = null;
        let modoConexion = false;
        let tuberiaConexionTipo = null;
        let puntoOrigenConexion = null;
        let puntosTuberias = [];
        let cabezales = [];
        let elementoSeleccionado = null;
        
        // Variables para captura de pantalla
        let capturaMapaDataUrl = null;
        let capturaTomada = false;
        let capturaCanvas = null;
        
        // ============================================
        // FUNCIONES DE INICIALIZACIÓN
        // ============================================
        
        function initMap() {
            const losMochis = [25.8133, -108.9719];
            
            map = L.map('map').setView(losMochis, 15);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);
            
            drawnItems = new L.FeatureGroup();
            map.addLayer(drawnItems);
            
            drawControl = new L.Control.Draw({
                position: 'topright',
                draw: {
                    polygon: {
                        allowIntersection: false,
                        shapeOptions: {
                            color: '#008a45',
                            fillColor: '#00a553',
                            fillOpacity: 0.3,
                            weight: 2
                        },
                        showArea: true,
                        metric: true
                    },
                    polyline: {
                        shapeOptions: {
                            color: '#ff0000',
                            weight: 2
                        },
                        showLength: true,
                        metric: true
                    },
                    rectangle: false,
                    circle: false,
                    marker: false,
                    circlemarker: false
                },
                edit: {
                    featureGroup: drawnItems,
                    remove: true
                }
            });
            
            map.addControl(drawControl);
            
            // Evento para agregar elementos gráficos cuando se hace clic en el mapa
            map.on('click', function(e) {
                if (modoAgregarElemento) {
                    agregarElementoGrafico(e.latlng, modoAgregarElemento);
                    modoAgregarElemento = null;
                    document.getElementById('instruccionesElementos').style.display = 'none';
                    
                    // Quitar clase active del botón
                    document.querySelectorAll('.elemento-btn').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    
                    mostrarMensaje('Elemento agregado. Selecciona otro para agregar más.');
                } else {
                    // Deseleccionar elemento si se hace clic en el mapa vacío
                    if (!e.originalEvent.ctrlKey) {
                        deseleccionarElemento();
                    }
                }
            });
            
            map.on(L.Draw.Event.CREATED, function(event) {
                const layer = event.layer;
                drawnItems.addLayer(layer);
                
                if (event.layerType === 'polygon') {
                    calcularAreaPoligono(layer);
                } else if (event.layerType === 'polyline') {
                    calcularLongitudPolilinea(layer);
                }
                
                if (currentDrawMode) {
                    currentDrawMode.disable();
                    currentDrawMode = null;
                }
            });
            
            map.on(L.Draw.Event.EDITED, function(event) {
                const layers = event.layers;
                layers.eachLayer(function(layer) {
                    if (layer instanceof L.Polygon) {
                        calcularAreaPoligono(layer);
                    } else if (layer instanceof L.Polyline) {
                        calcularLongitudPolilinea(layer);
                    }
                });
            });
            
            map.on(L.Draw.Event.DELETED, function(event) {
                const layers = event.layers;
                layers.eachLayer(function(layer) {
                    if (layer instanceof L.Polygon) {
                        areaTotal = 0;
                        document.getElementById('areaDisplay').textContent = 'Área: 0 m²';
                        actualizarResultados();
                        mostrarControlesMapa();
                    }
                });
            });
            
            // Redimensionar mapa cuando cambia el tamaño de la ventana
            window.addEventListener('resize', function() {
                setTimeout(function() {
                    map.invalidateSize();
                }, 100);
            });
        }
        
        // ============================================
        // FUNCIONES DE UTILIDAD
        // ============================================
        
        function getGrosorTuberia(tipo, diametro) {
            const grosoresBase = {
                'principal': 8,
                'secundaria': 6,
                'regante': 4
            };
            
            const base = grosoresBase[tipo] || 4;
            const diametroNum = parseFloat(diametro);
            
            // Ajustar grosor según diámetro (más realista)
            if (tipo === 'principal') {
                return base + (diametroNum * 1.2);
            } else if (tipo === 'secundaria') {
                return base + (diametroNum * 0.8);
            } else {
                return base + (diametroNum * 0.5);
            }
        }
        
        function getColorTuberia(tipo) {
            const colores = {
                'principal': '#ff6b6b',
                'secundaria': '#4ecdc4',
                'regante': '#45b7d1'
            };
            return colores[tipo] || '#000000';
        }
        
        function calcularAreaPoligono(polygon) {
            areaTotal = L.GeometryUtil.geodesicArea(polygon.getLatLngs()[0]);
            
            document.getElementById('areaDisplay').textContent = 
                `Área: ${areaTotal.toFixed(2)} m² (${(areaTotal / 10000).toFixed(2)} ha)`;
            
            ocultarControlesMapa();
            actualizarResultados();
        }
        
        function calcularLongitudPolilinea(polyline) {
            const latlngs = polyline.getLatLngs();
            let length = 0;
            
            for (let i = 0; i < latlngs.length - 1; i++) {
                length += latlngs[i].distanceTo(latlngs[i + 1]);
            }
            
            const areaDisplay = document.getElementById('areaDisplay');
            const currentArea = areaDisplay.textContent.includes('Longitud') ? 
                areaDisplay.textContent.split(' | ')[0] : areaDisplay.textContent;
            areaDisplay.textContent = `${currentArea} | Longitud: ${length.toFixed(2)} m`;
        }
        
        // ============================================
        // FUNCIONES DE ELEMENTOS (MEJORADAS)
        // ============================================
        
        function agregarElementoGrafico(latlng, tipo) {
            const iconos = {
                'cabezal': 'fa-gear',
                'purgaterminal': 'fa-faucet',
                'tomagua': 'fa-tint',
                'valvula': 'fa-toggle-on',
                'filtro': 'fa-filter'
            };
            
            const colores = {
                'cabezal': '#1772af',
                'purgaterminal': '#ff9f43',
                'tomagua': '#00a553',
                'valvula': '#ff6b6b',
                'filtro': '#4ecdc4'
            };
            
            const elementoId = Date.now();
            const elemento = L.marker(latlng, {
                icon: L.divIcon({
                    className: 'elemento-grafico',
                    html: `<div style="background: ${colores[tipo]}; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                        <i class="fas ${iconos[tipo]}"></i></div>`,
                    iconSize: [30, 30],
                    iconAnchor: [15, 15]
                }),
                draggable: true
            }).addTo(map);
            
            // Configurar popup inicial
            let popupContent = `<b>${tipo.toUpperCase()}</b><br>Arrastra para mover`;
            let nombreValvula = '';
            
            // Si es una válvula, configurar específicamente
            if (tipo === 'valvula') {
                nombreValvula = generarNombreValvula();
                valvulas.push({
                    id: elementoId,
                    nombre: nombreValvula,
                    elementoId: elementoId,
                    posicion: latlng,
                    caudalEmisor: 4,
                    numeroEmisores: 100,
                    tipo: 'Manual',
                    diametro: '2"',
                    presion: 3,
                    caudalTotal: 400
                });
                popupContent = `<b>VÁLVULA ${nombreValvula}</b><br>Caudal: 400 L/h<br>Arrastra para mover`;
            }
            
            // Si es un cabezal, configurar específicamente
            if (tipo === 'cabezal') {
                cabezales.push({
                    id: elementoId,
                    elementoId: elementoId,
                    posicion: latlng,
                    caudalBomba: 50,
                    diametroSuccion: '4"',
                    diametroDescarga: '3"',
                    numeroFiltros: 2,
                    tipoFiltros: 'Anillas',
                    notas: 'Cabezal principal del sistema'
                });
                popupContent = `<b>CABEZAL PRINCIPAL</b><br>Caudal: 50 L/s<br>Arrastra para mover`;
            }
            
            elemento.bindPopup(popupContent);
            
            // Evento para hacer clic en el elemento (para seleccionarlo)
            elemento.on('click', function(e) {
                // Si se mantiene presionado Ctrl, no hacer nada (para arrastrar)
                if (e.originalEvent.ctrlKey) return;
                
                // Seleccionar este elemento
                seleccionarElemento(elementoId, tipo);
                e.originalEvent.stopPropagation();
            });
            
            // Evento para arrastrar
            elemento.on('dragend', function(e) {
                const nuevaPos = e.target.getLatLng();
                const elementoIndex = elementosGraficos.findIndex(e => e.layer === elemento);
                if (elementoIndex !== -1) {
                    elementosGraficos[elementoIndex].posicion = nuevaPos;
                    
                    // Actualizar en el array correspondiente
                    if (tipo === 'valvula') {
                        const valvulaIndex = valvulas.findIndex(v => v.elementoId === elementosGraficos[elementoIndex].id);
                        if (valvulaIndex !== -1) {
                            valvulas[valvulaIndex].posicion = nuevaPos;
                            
                            // Actualizar la configuración si está seleccionada
                            if (elementoSeleccionado && elementoSeleccionado.id === elementoId) {
                                actualizarConfiguracionElemento(tipo, elementoId);
                            }
                        }
                    } else if (tipo === 'cabezal') {
                        const cabezalIndex = cabezales.findIndex(c => c.elementoId === elementosGraficos[elementoIndex].id);
                        if (cabezalIndex !== -1) {
                            cabezales[cabezalIndex].posicion = nuevaPos;
                            
                            // Actualizar la configuración si está seleccionada
                            if (elementoSeleccionado && elementoSeleccionado.id === elementoId) {
                                actualizarConfiguracionElemento(tipo, elementoId);
                            }
                        }
                    }
                }
            });
            
            // Guardar referencia
            elementosGraficos.push({
                id: elementoId,
                type: 'elemento',
                layer: elemento,
                tipo: tipo,
                posicion: latlng
            });
            
            // Si es válvula o cabezal, seleccionarlo automáticamente
            if (tipo === 'valvula' || tipo === 'cabezal') {
                seleccionarElemento(elementoId, tipo);
            }
            
            // Actualizar resultados
            actualizarResultados();
            
            return elementoId;
        }
        
        function seleccionarElemento(elementoId, tipo) {
            // Limpiar selección anterior
            if (elementoSeleccionado && elementoSeleccionado.layer) {
                // Quitar efecto visual de selección
                const icon = elementoSeleccionado.layer.getElement();
                if (icon) {
                    icon.style.boxShadow = '';
                    icon.style.border = '';
                }
            }
            
            // Buscar el elemento
            const elemento = elementosGraficos.find(e => e.id === elementoId);
            if (!elemento) return;
            
            // Establecer como seleccionado
            elementoSeleccionado = elemento;
            
            // Aplicar efecto visual de selección
            const icon = elemento.layer.getElement();
            if (icon) {
                icon.style.boxShadow = '0 0 0 3px #ff9f43';
                icon.style.border = '2px solid white';
            }
            
            // Abrir popup
            elemento.layer.openPopup();
            
            // Cambiar a la pestaña de elementos si no está activa
            if (!document.querySelector('.cad-tab[data-tab="elementos"]').classList.contains('active')) {
                document.querySelectorAll('.cad-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                document.querySelectorAll('.cad-tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                
                const elementosTab = document.querySelector('.cad-tab[data-tab="elementos"]');
                elementosTab.classList.add('active');
                document.getElementById('elementos-tab').classList.add('active');
            }
            
            // Actualizar la configuración del elemento seleccionado
            actualizarConfiguracionElemento(tipo, elementoId);
            
            // Mostrar mensaje
            let nombreElemento = tipo;
            if (tipo === 'valvula') {
                const valvula = valvulas.find(v => v.elementoId === elementoId);
                if (valvula) nombreElemento = `Válvula ${valvula.nombre}`;
            } else if (tipo === 'cabezal') {
                nombreElemento = 'Cabezal';
            }
            
            mostrarMensaje(`${nombreElemento} seleccionado. Puedes modificar sus propiedades en el panel.`);
        }
        
        function deseleccionarElemento() {
            if (elementoSeleccionado && elementoSeleccionado.layer) {
                // Quitar efecto visual de selección
                const icon = elementoSeleccionado.layer.getElement();
                if (icon) {
                    icon.style.boxShadow = '';
                    icon.style.border = '';
                }
                
                // Cerrar popup
                elementoSeleccionado.layer.closePopup();
            }
            
            elementoSeleccionado = null;
            
            // Restaurar configuración por defecto
            actualizarConfiguracionElemento('cabezal');
        }
        
        function eliminarElemento(elementoId, tipo) {
            if (!confirm(`¿Estás seguro de eliminar este ${tipo}?`)) return;
            
            // Buscar el elemento en elementosGraficos
            const elementoIndex = elementosGraficos.findIndex(e => e.id === parseInt(elementoId));
            if (elementoIndex !== -1) {
                // Remover del mapa
                map.removeLayer(elementosGraficos[elementoIndex].layer);
                // Remover del array
                elementosGraficos.splice(elementoIndex, 1);
            }
            
            // Remover de arrays específicos
            if (tipo === 'valvula') {
                const valvulaIndex = valvulas.findIndex(v => v.id === parseInt(elementoId));
                if (valvulaIndex !== -1) {
                    valvulas.splice(valvulaIndex, 1);
                }
            } else if (tipo === 'cabezal') {
                const cabezalIndex = cabezales.findIndex(c => c.id === parseInt(elementoId));
                if (cabezalIndex !== -1) {
                    cabezales.splice(cabezalIndex, 1);
                }
            }
            
            // Deseleccionar si era el elemento seleccionado
            if (elementoSeleccionado && elementoSeleccionado.id === parseInt(elementoId)) {
                deseleccionarElemento();
            }
            
            // Actualizar resultados
            actualizarResultados();
            
            mostrarMensaje(`${tipo.charAt(0).toUpperCase() + tipo.slice(1)} eliminado`);
        }
        
        function generarNombreValvula() {
            const letras = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z'];
            const numeros = Array.from({length: 10}, (_, i) => i + 1);
            
            const nombresExistentes = valvulas.map(v => v.nombre);
            
            for (let letra of letras) {
                for (let numero of numeros) {
                    const nombre = `${letra}${numero}`;
                    if (!nombresExistentes.includes(nombre)) {
                        return nombre;
                    }
                }
            }
            
            return `V${valvulas.length + 1}`;
        }
        
        function actualizarConfiguracionElemento(tipo, elementoId = null) {
            const configDiv = document.getElementById('elementoConfig');
            
            // Si no hay elementoId especificado pero hay un elemento seleccionado del mismo tipo
            if (!elementoId && elementoSeleccionado && elementoSeleccionado.tipo === tipo) {
                elementoId = elementoSeleccionado.id;
            }
            
            if (tipo === 'valvula' && elementoId) {
                const valvula = valvulas.find(v => v.id === parseInt(elementoId));
                if (valvula) {
                    configDiv.innerHTML = `
                        <h4>Configuración de Válvula ${valvula.nombre}</h4>
                        <div class="control-row">
                            <div class="control-label">Nombre:</div>
                            <input type="text" id="nombreValvula" value="${valvula.nombre}" onchange="actualizarValvula('${elementoId}', 'nombre', this.value)">
                        </div>
                        <div class="control-row">
                            <div class="control-label">Caudal emisor:</div>
                            <input type="number" id="caudalEmisorValvula" value="${valvula.caudalEmisor}" step="0.5" min="1" max="100" onchange="actualizarValvula('${elementoId}', 'caudalEmisor', this.value)">
                            L/h
                        </div>
                        <div class="control-row">
                            <div class="control-label">N° emisores:</div>
                            <input type="number" id="numEmisoresValvula" value="${valvula.numeroEmisores}" min="1" max="10000" onchange="actualizarValvula('${elementoId}', 'numeroEmisores', this.value)">
                        </div>
                        <div class="control-row">
                            <div class="control-label">Tipo:</div>
                            <select id="tipoValvula" onchange="actualizarValvula('${elementoId}', 'tipo', this.value)">
                                <option value="Manual" ${valvula.tipo === 'Manual' ? 'selected' : ''}>Manual</option>
                                <option value="Automática" ${valvula.tipo === 'Automática' ? 'selected' : ''}>Automática</option>
                                <option value="Electroválvula" ${valvula.tipo === 'Electroválvula' ? 'selected' : ''}>Electroválvula</option>
                            </select>
                        </div>
                        <div class="control-row">
                            <div class="control-label">Diámetro:</div>
                            <select id="diametroValvula" onchange="actualizarValvula('${elementoId}', 'diametro', this.value)">
                                <option value="1\"" ${valvula.diametro === '1"' ? 'selected' : ''}>1"</option>
                                <option value="2\"" ${valvula.diametro === '2"' ? 'selected' : ''}>2"</option>
                                <option value="3\"" ${valvula.diametro === '3"' ? 'selected' : ''}>3"</option>
                                <option value="4\"" ${valvula.diametro === '4"' ? 'selected' : ''}>4"</option>
                            </select>
                        </div>
                        <div class="control-row">
                            <div class="control-label">Presión:</div>
                            <input type="number" id="presionValvula" value="${valvula.presion}" step="0.5" min="1" max="10" onchange="actualizarValvula('${elementoId}', 'presion', this.value)">
                            bar
                        </div>
                        <div style="margin-top: 10px; padding: 10px; background-color: #e8f4fd; border-radius: 5px;">
                            <strong>Caudal Total:</strong> ${valvula.caudalTotal} L/h (${(valvula.caudalTotal / 3600).toFixed(2)} L/s)
                        </div>
                        <button onclick="eliminarElemento('${elementoId}', 'valvula')" style="margin-top: 10px; padding: 8px 15px; background-color: #ff6b6b; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">
                            <i class="fas fa-trash"></i> Eliminar Válvula
                        </button>
                    `;
                }
            } else if (tipo === 'cabezal' && elementoId) {
                const cabezal = cabezales.find(c => c.id === parseInt(elementoId));
                if (cabezal) {
                    configDiv.innerHTML = `
                        <h4>Configuración del Cabezal</h4>
                        <div class="control-row">
                            <div class="control-label">Caudal bomba:</div>
                            <input type="number" id="caudalBomba" value="${cabezal.caudalBomba}" step="5" min="1" max="1000" onchange="actualizarCabezal('${elementoId}', 'caudalBomba', this.value)">
                            L/s
                        </div>
                        <div class="control-row">
                            <div class="control-label">Diámetro succión:</div>
                            <select id="diametroSuccion" onchange="actualizarCabezal('${elementoId}', 'diametroSuccion', this.value)">
                                <option value="2\"" ${cabezal.diametroSuccion === '2"' ? 'selected' : ''}>2"</option>
                                <option value="3\"" ${cabezal.diametroSuccion === '3"' ? 'selected' : ''}>3"</option>
                                <option value="4\"" ${cabezal.diametroSuccion === '4"' ? 'selected' : ''}>4"</option>
                                <option value="6\"" ${cabezal.diametroSuccion === '6"' ? 'selected' : ''}>6"</option>
                                <option value="8\"" ${cabezal.diametroSuccion === '8"' ? 'selected' : ''}>8"</option>
                            </select>
                        </div>
                        <div class="control-row">
                            <div class="control-label">Diámetro descarga:</div>
                            <select id="diametroDescarga" onchange="actualizarCabezal('${elementoId}', 'diametroDescarga', this.value)">
                                <option value="2\"" ${cabezal.diametroDescarga === '2"' ? 'selected' : ''}>2"</option>
                                <option value="3\"" ${cabezal.diametroDescarga === '3"' ? 'selected' : ''}>3"</option>
                                <option value="4\"" ${cabezal.diametroDescarga === '4"' ? 'selected' : ''}>4"</option>
                                <option value="6\"" ${cabezal.diametroDescarga === '6"' ? 'selected' : ''}>6"</option>
                            </select>
                        </div>
                        <div class="control-row">
                            <div class="control-label">N° filtros:</div>
                            <input type="number" id="numFiltros" value="${cabezal.numeroFiltros}" min="1" max="10" onchange="actualizarCabezal('${elementoId}', 'numeroFiltros', this.value)">
                        </div>
                        <div class="control-row">
                            <div class="control-label">Tipo filtros:</div>
                            <select id="tipoFiltros" onchange="actualizarCabezal('${elementoId}', 'tipoFiltros', this.value)">
                                <option value="Anillas" ${cabezal.tipoFiltros === 'Anillas' ? 'selected' : ''}>Anillas</option>
                                <option value="Arena" ${cabezal.tipoFiltros === 'Arena' ? 'selected' : ''}>Arena</option>
                                <option value="Malla" ${cabezal.tipoFiltros === 'Malla' ? 'selected' : ''}>Malla</option>
                                <option value="Hidrociclón" ${cabezal.tipoFiltros === 'Hidrociclón' ? 'selected' : ''}>Hidrociclón</option>
                            </select>
                        </div>
                        <div class="control-row">
                            <div class="control-label">Notas:</div>
                            <textarea id="notasCabezal" rows="3" style="width: 100%; margin-top: 5px;" onchange="actualizarCabezal('${elementoId}', 'notas', this.value)">${cabezal.notas}</textarea>
                        </div>
                        <button onclick="eliminarElemento('${elementoId}', 'cabezal')" style="margin-top: 10px; padding: 8px 15px; background-color: #ff6b6b; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">
                            <i class="fas fa-trash"></i> Eliminar Cabezal
                        </button>
                    `;
                }
            } else {
                let contenido = '';
                
                switch(tipo) {
                    case 'cabezal':
                        contenido = `
                            <h4>Configuración del Cabezal</h4>
                            <p>Haz clic en un cabezal existente en el mapa para editarlo, o coloca uno nuevo.</p>
                            <div class="control-row">
                                <div class="control-label">Caudal bomba:</div>
                                <input type="number" id="caudalBomba" value="50" step="5" min="1" max="1000"> L/s
                            </div>
                            <div class="control-row">
                                <div class="control-label">Diámetro succión:</div>
                                <select id="diametroSuccion">
                                    <option value="2\"" selected>2"</option>
                                    <option value="3"">3"</option>
                                    <option value="4"">4"</option>
                                    <option value="6"">6"</option>
                                    <option value="8"">8"</option>
                                </select>
                            </div>
                            <div class="control-row">
                                <div class="control-label">Diámetro descarga:</div>
                                <select id="diametroDescarga">
                                    <option value="2\"">2"</option>
                                    <option value="3\"" selected>3"</option>
                                    <option value="4\"">4"</option>
                                    <option value="6\"">6"</option>
                                </select>
                            </div>
                        `;
                        break;
                        
                    case 'valvula':
                        const nombreValvula = generarNombreValvula();
                        contenido = `
                            <h4>Configuración de Válvula</h4>
                            <p>Haz clic en una válvula existente en el mapa para editarla, o coloca una nueva.</p>
                            <div class="control-row">
                                <div class="control-label">Nombre:</div>
                                <input type="text" id="nombreValvula" value="${nombreValvula}">
                            </div>
                            <div class="control-row">
                                <div class="control-label">Caudal emisor:</div>
                                <input type="number" id="caudalEmisorValvula" value="4" step="0.5" min="1" max="100"> L/h
                            </div>
                            <div class="control-row">
                                <div class="control-label">N° emisores:</div>
                                <input type="number" id="numEmisoresValvula" value="100" min="1" max="10000">
                            </div>
                        `;
                        break;
                        
                    default:
                        contenido = `<p>Selecciona un elemento en el mapa o coloca uno nuevo para configurarlo</p>`;
                }
                
                configDiv.innerHTML = contenido;
            }
        }
        
        function actualizarValvula(elementoId, campo, valor) {
            const valvula = valvulas.find(v => v.id === parseInt(elementoId));
            if (valvula) {
                valvula[campo] = valor;
                
                if (campo === 'caudalEmisor' || campo === 'numeroEmisores') {
                    valvula.caudalTotal = valvula.caudalEmisor * valvula.numeroEmisores;
                }
                
                const elementoGrafico = elementosGraficos.find(e => e.id === parseInt(elementoId));
                if (elementoGrafico && elementoGrafico.layer) {
                    elementoGrafico.layer.bindPopup(`<b>VÁLVULA ${valvula.nombre}</b><br>Caudal: ${valvula.caudalTotal} L/h<br>Tipo: ${valvula.tipo}<br>Arrastra para mover`);
                }
                
                // Actualizar la configuración si está seleccionada
                if (elementoSeleccionado && elementoSeleccionado.id === parseInt(elementoId)) {
                    actualizarConfiguracionElemento('valvula', elementoId);
                }
                
                actualizarResultados();
            }
        }
        
        function actualizarCabezal(elementoId, campo, valor) {
            const cabezal = cabezales.find(c => c.id === parseInt(elementoId));
            if (cabezal) {
                cabezal[campo] = valor;
                
                const elementoGrafico = elementosGraficos.find(e => e.id === parseInt(elementoId));
                if (elementoGrafico && elementoGrafico.layer) {
                    elementoGrafico.layer.bindPopup(`<b>CABEZAL PRINCIPAL</b><br>Caudal: ${cabezal.caudalBomba} L/s<br>Filtros: ${cabezal.numeroFiltros} ${cabezal.tipoFiltros}<br>Arrastra para mover`);
                }
                
                // Actualizar la configuración si está seleccionada
                if (elementoSeleccionado && elementoSeleccionado.id === parseInt(elementoId)) {
                    actualizarConfiguracionElemento('cabezal', elementoId);
                }
                
                actualizarResultados();
            }
        }
        
        function iniciarModoElemento(tipoElemento) {
            // Desactivar otros modos
            if (currentDrawMode) {
                currentDrawMode.disable();
                currentDrawMode = null;
            }
            
            if (tuberiaActual) {
                tuberiaActual = null;
                puntoInicioTuberia = null;
                
                document.querySelectorAll('.tuberia-btn').forEach(btn => {
                    btn.classList.remove('activo');
                });
                
                document.getElementById('instruccionesPrincipal').style.display = 'none';
                document.getElementById('instruccionesSecundaria').style.display = 'none';
                document.getElementById('instruccionesRegante').style.display = 'none';
            }
            
            if (modoConexion) {
                modoConexion = false;
                tuberiaConexionTipo = null;
                puntoOrigenConexion = null;
                
                document.querySelectorAll('.tuberia-btn').forEach(btn => {
                    btn.classList.remove('modo-conexion-activo');
                });
            }
            
            // Quitar clase active de todos los botones de elemento
            document.querySelectorAll('.elemento-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Agregar clase active al botón clickeado
            const elementoBtn = document.querySelector(`.elemento-btn[data-elemento="${tipoElemento}"]`);
            if (elementoBtn) {
                elementoBtn.classList.add('active');
            }
            
            modoAgregarElemento = tipoElemento;
            document.getElementById('instruccionesElementos').style.display = 'block';
            mostrarMensaje(`Modo elemento activado. Haz clic en el mapa para colocar el ${tipoElemento}.`);
            
            // Actualizar configuración del elemento
            actualizarConfiguracionElemento(tipoElemento);
        }
        
        // ============================================
        // FUNCIONES DE TUBERÍAS - MEJORADAS PARA POLILÍNEAS
        // ============================================
        
        function iniciarModoTuberia(tipoTuberia) {
            if (currentDrawMode) {
                currentDrawMode.disable();
                currentDrawMode = null;
            }
            
            modoConexion = false;
            tuberiaConexionTipo = null;
            puntoOrigenConexion = null;
            
            // Quitar cualquier modo de elemento activo
            modoAgregarElemento = null;
            document.getElementById('instruccionesElementos').style.display = 'none';
            document.querySelectorAll('.elemento-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Limpiar el estado de conexión visualmente
            document.querySelectorAll('.tuberia-btn').forEach(btn => {
                btn.classList.remove('modo-conexion-activo');
                btn.classList.remove('activo');
            });
            
            const botonId = tipoTuberia === 'principal' ? 'btnTuberiaPrincipal' : 
                           tipoTuberia === 'secundaria' ? 'btnTuberiaSecundaria' : 'btnTuberiaRegante';
            document.getElementById(botonId).classList.add('activo');
            
            const instruccionesId = tipoTuberia === 'principal' ? 'instruccionesPrincipal' : 
                                   tipoTuberia === 'secundaria' ? 'instruccionesSecundaria' : 'instruccionesRegante';
            document.getElementById(instruccionesId).style.display = 'block';
            
            const diametroSelectId = tipoTuberia === 'principal' ? 'diametroPrincipal' : 
                                     tipoTuberia === 'secundaria' ? 'diametroSecundaria' : 'diametroRegante';
            const diametro = document.getElementById(diametroSelectId).value;
            
            const tipoSelectId = tipoTuberia === 'principal' ? 'tipoPrincipal' : 
                                 tipoTuberia === 'secundaria' ? 'tipoSecundaria' : 'tipoRegante';
            const tipoMaterial = document.getElementById(tipoSelectId).value;
            
            tuberiaActual = {
                tipo: tipoTuberia,
                puntos: [],
                color: getColorTuberia(tipoTuberia),
                grosor: getGrosorTuberia(tipoTuberia, diametro),
                diametro: diametro,
                tipoMaterial: tipoMaterial,
                id: Date.now(),
                conexiones: [],
                esPolilinea: false
            };
            
            mostrarMensaje(`Modo dibujo tubería ${tipoTuberia} (${diametro}"). Haz clic en el mapa para establecer puntos. Doble clic para finalizar.`);
            
            // Configurar eventos específicos para el dibujo de tuberías
            configurarEventosDibujoTuberia(tipoTuberia, diametro, tipoMaterial);
        }
        
        function configurarEventosDibujoTuberia(tipoTuberia, diametro, tipoMaterial) {
            // Remover eventos anteriores
            map.off('click');
            map.off('dblclick');
            
            let puntoInicio = null;
            let puntosIntermedios = [];
            
            map.on('click', function(e) {
                if (!puntoInicio) {
                    puntoInicio = e.latlng;
                    tuberiaActual.puntos.push(puntoInicio);
                    
                    const marcadorInicio = crearMarcadorTuberia(puntoInicio, 'inicio', tipoTuberia, diametro);
                    marcadorInicio.addTo(map);
                    tuberiaActual.marcadorInicio = marcadorInicio;
                    
                    puntosTuberias.push({
                        tipo: tipoTuberia,
                        latlng: puntoInicio,
                        tuberiaId: tuberiaActual.id,
                        esInicio: true
                    });
                    
                    mostrarMensaje('Punto de inicio establecido. Haz clic para agregar más puntos o doble clic para finalizar.');
                } else {
                    puntosIntermedios.push(e.latlng);
                    tuberiaActual.puntos.push(e.latlng);
                    
                    const marcadorIntermedio = crearMarcadorTuberia(e.latlng, 'intermedio', tipoTuberia, diametro);
                    marcadorIntermedio.addTo(map);
                    
                    if (!tuberiaActual.marcadoresIntermedios) tuberiaActual.marcadoresIntermedios = [];
                    tuberiaActual.marcadoresIntermedios.push(marcadorIntermedio);
                    
                    puntosTuberias.push({
                        tipo: tipoTuberia,
                        latlng: e.latlng,
                        tuberiaId: tuberiaActual.id,
                        esInicio: false
                    });
                    
                    mostrarMensaje('Punto intermedio agregado. Haz clic para agregar más puntos o doble clic para finalizar.');
                }
                
                // Si ya hay al menos 2 puntos, dibujar la línea
                if (tuberiaActual.puntos.length >= 2) {
                    if (tuberiaActual.linea) {
                        map.removeLayer(tuberiaActual.linea);
                    }
                    
                    const linea = dibujarPolilineaTuberia(tuberiaActual.puntos, tipoTuberia, diametro);
                    tuberiaActual.linea = linea;
                }
            });
            
            map.on('dblclick', function(e) {
                if (tuberiaActual.puntos.length < 2) {
                    mostrarMensaje('Se necesitan al menos 2 puntos para crear una tubería. Agrega otro punto.');
                    return;
                }
                
                // Finalizar la tubería
                tuberiaActual.esPolilinea = tuberiaActual.puntos.length > 2;
                
                if (e.latlng && !puntosIntermedios.includes(e.latlng) && e.latlng !== puntoInicio) {
                    tuberiaActual.puntos.push(e.latlng);
                    const marcadorFin = crearMarcadorTuberia(e.latlng, 'fin', tipoTuberia, diametro);
                    marcadorFin.addTo(map);
                    tuberiaActual.marcadorFin = marcadorFin;
                    
                    puntosTuberias.push({
                        tipo: tipoTuberia,
                        latlng: e.latlng,
                        tuberiaId: tuberiaActual.id,
                        esInicio: false
                    });
                }
                
                // Calcular longitud total
                tuberiaActual.longitud = calcularLongitudPolilineaDesdePuntos(tuberiaActual.puntos);
                
                // Agregar etiqueta de longitud
                const centro = calcularCentroPolilinea(tuberiaActual.puntos);
                const etiqueta = L.marker(centro, {
                    icon: L.divIcon({
                        className: 'tuberia-label',
                        html: `<div style="background: white; padding: 2px 5px; border: 1px solid #ccc; border-radius: 3px; font-size: 9px; font-weight: bold;">
                               ${tuberiaActual.longitud.toFixed(1)}m - ${diametro}"</div>`,
                        iconSize: [80, 20],
                        iconAnchor: [40, 10]
                    })
                }).addTo(map);
                
                tuberiaActual.etiquetaLongitud = etiqueta;
                
                // Agregar popup con botones
                const popupContent = `
                    <div style="text-align: center;">
                        <b>Tubería ${tipoTuberia} (${diametro}")</b><br>
                        Longitud: ${tuberiaActual.longitud.toFixed(2)} m<br>
                        Puntos: ${tuberiaActual.puntos.length}<br>
                        Material: ${tipoMaterial}<br>
                        <button onclick="eliminarTuberia('${tuberiaActual.id}')" 
                                style="margin-top: 5px; padding: 3px 8px; background-color: #ff6b6b; color: white; border: none; border-radius: 3px; font-size: 0.8rem; cursor: pointer;">
                            <i class="fas fa-trash"></i> Eliminar Tubería
                        </button>
                        <button onclick="editarTuberia('${tuberiaActual.id}')" 
                                style="margin-top: 5px; margin-left: 5px; padding: 3px 8px; background-color: #4ecdc4; color: white; border: none; border-radius: 3px; font-size: 0.8rem; cursor: pointer;">
                            <i class="fas fa-edit"></i> Editar Diámetro
                        </button>
                    </div>
                `;
                
                tuberiaActual.linea.bindPopup(popupContent);
                
                // Guardar la tubería
                tuberias.push({...tuberiaActual});
                
                actualizarResumenTuberias();
                actualizarResultados();
                
                // Restaurar eventos del mapa
                restaurarEventoClickMapa();
                
                // Limpiar tubería actual
                tuberiaActual = null;
                puntoInicio = null;
                puntosIntermedios = [];
                
                // Limpiar UI
                document.getElementById(instruccionesId).style.display = 'none';
                document.getElementById(botonId).classList.remove('activo');
                
                mostrarMensaje(`Tubería ${tipoTuberia} (${diametro}") creada. Longitud: ${tuberiaActual ? tuberiaActual.longitud.toFixed(1) : '0'} metros`);
            });
        }
        
        function calcularLongitudPolilineaDesdePuntos(puntos) {
            let longitud = 0;
            for (let i = 0; i < puntos.length - 1; i++) {
                longitud += puntos[i].distanceTo(puntos[i + 1]);
            }
            return longitud;
        }
        
        function calcularCentroPolilinea(puntos) {
            if (puntos.length === 0) return L.latLng(0, 0);
            if (puntos.length === 1) return puntos[0];
            
            const latSum = puntos.reduce((sum, punto) => sum + punto.lat, 0);
            const lngSum = puntos.reduce((sum, punto) => sum + punto.lng, 0);
            
            return L.latLng(latSum / puntos.length, lngSum / puntos.length);
        }
        
        function dibujarPolilineaTuberia(puntos, tipoTuberia, diametro) {
            const color = getColorTuberia(tipoTuberia);
            const grosor = getGrosorTuberia(tipoTuberia, diametro);
            
            const polilinea = L.polyline(puntos, {
                color: color,
                weight: grosor,
                opacity: 0.8,
                lineCap: 'round',
                lineJoin: 'round'
            }).addTo(map);
            
            // Hacer editable
            polilinea.editing.enable();
            
            // Evento para actualizar cuando se edita
            polilinea.on('edit', function(e) {
                const nuevosPuntos = e.target.getLatLngs();
                const tuberia = tuberias.find(t => t.linea === polilinea);
                
                if (tuberia) {
                    tuberia.puntos = nuevosPuntos;
                    tuberia.longitud = calcularLongitudPolilineaDesdePuntos(nuevosPuntos);
                    
                    // Actualizar etiqueta de longitud
                    if (tuberia.etiquetaLongitud) {
                        const centro = calcularCentroPolilinea(nuevosPuntos);
                        tuberia.etiquetaLongitud.setLatLng(centro);
                        tuberia.etiquetaLongitud.setIcon(L.divIcon({
                            className: 'tuberia-label',
                            html: `<div style="background: white; padding: 2px 5px; border: 1px solid #ccc; border-radius: 3px; font-size: 9px; font-weight: bold;">
                                   ${tuberia.longitud.toFixed(1)}m - ${tuberia.diametro}"</div>`,
                            iconSize: [80, 20],
                            iconAnchor: [40, 10]
                        }));
                    }
                    
                    actualizarResumenTuberias();
                    actualizarResultados();
                }
            });
            
            return polilinea;
        }
        
        function restaurarEventoClickMapa() {
            // Remover todos los eventos click del mapa
            map.off('click');
            map.off('dblclick');
            
            // Restaurar el evento click original
            map.on('click', function(e) {
                if (modoAgregarElemento) {
                    agregarElementoGrafico(e.latlng, modoAgregarElemento);
                    modoAgregarElemento = null;
                    document.getElementById('instruccionesElementos').style.display = 'none';
                    
                    // Quitar clase active del botón
                    document.querySelectorAll('.elemento-btn').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    
                    mostrarMensaje('Elemento agregado. Selecciona otro para agregar más.');
                } else {
                    // Deseleccionar elemento si se hace clic en el mapa vacío
                    if (!e.originalEvent.ctrlKey) {
                        deseleccionarElemento();
                    }
                }
            });
        }
        
        function crearMarcadorTuberia(latlng, tipo, tipoTuberia, diametro) {
            const color = getColorTuberia(tipoTuberia);
            const tamanos = {
                'principal': 18,
                'secundaria': 15,
                'regante': 12
            };
            
            const tamano = tamanos[tipoTuberia];
            const tipoIcono = tipo === 'inicio' ? '🚀' : tipo === 'fin' ? '🏁' : '●';
            
            const marcador = L.marker(latlng, {
                icon: L.divIcon({
                    className: 'tuberia-punto',
                    html: `<div style="background: ${color}; width: ${tamano}px; height: ${tamano}px; 
                           border-radius: 50%; border: 2px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.5); 
                           cursor: pointer; display: flex; align-items: center; justify-content: center; color: white; font-size: 8px;" 
                           title="${tipoTuberia} ${diametro}">${tipoIcono}</div>`,
                    iconSize: [tamano, tamano],
                    iconAnchor: [tamano/2, tamano/2]
                })
            });
            
            marcador.draggable = true;
            marcador.on('dragend', function(e) {
                const nuevoLatLng = e.target.getLatLng();
                
                const puntoIndex = puntosTuberias.findIndex(p => 
                    Math.abs(p.latlng.lat - latlng.lat) < 0.00001 && 
                    Math.abs(p.latlng.lng - latlng.lng) < 0.00001
                );
                
                if (puntoIndex !== -1) {
                    puntosTuberias[puntoIndex].latlng = nuevoLatLng;
                }
                
                actualizarTuberiasConPunto(latlng, nuevoLatLng);
            });
            
            return marcador;
        }
        
        function actualizarTuberiasConPunto(viejoLatLng, nuevoLatLng) {
            tuberias.forEach(tuberia => {
                // Actualizar puntos en la tubería
                const puntoIndex = tuberia.puntos.findIndex(p => 
                    Math.abs(p.lat - viejoLatLng.lat) < 0.00001 && 
                    Math.abs(p.lng - viejoLatLng.lng) < 0.00001
                );
                
                if (puntoIndex !== -1) {
                    tuberia.puntos[puntoIndex] = nuevoLatLng;
                    
                    // Actualizar línea en el mapa
                    if (tuberia.linea) {
                        tuberia.linea.setLatLngs(tuberia.puntos);
                    }
                    
                    // Recalcular longitud
                    tuberia.longitud = calcularLongitudPolilineaDesdePuntos(tuberia.puntos);
                    
                    // Actualizar etiqueta de longitud
                    if (tuberia.etiquetaLongitud) {
                        const centro = calcularCentroPolilinea(tuberia.puntos);
                        tuberia.etiquetaLongitud.setLatLng(centro);
                        tuberia.etiquetaLongitud.setIcon(L.divIcon({
                            className: 'tuberia-label',
                            html: `<div style="background: white; padding: 2px 5px; border: 1px solid #ccc; border-radius: 3px; font-size: 9px; font-weight: bold;">
                                   ${tuberia.longitud.toFixed(1)}m - ${tuberia.diametro}"</div>`,
                            iconSize: [80, 20],
                            iconAnchor: [40, 10]
                        }));
                    }
                }
            });
            
            actualizarResumenTuberias();
            actualizarResultados();
        }
        
        // ============================================
        // FUNCIONES DE CONEXIÓN
        // ============================================
        
        function iniciarModoConexion(tipoTuberia) {
            if (currentDrawMode) {
                currentDrawMode.disable();
                currentDrawMode = null;
            }
            
            if (tuberiaActual) {
                tuberiaActual = null;
            }
            
            document.querySelectorAll('.tuberia-btn').forEach(btn => {
                btn.classList.remove('activo');
            });
            
            const botonId = tipoTuberia === 'principal' ? 'btnConectarPrincipal' : 
                           tipoTuberia === 'secundaria' ? 'btnConectarSecundaria' : 'btnConectarRegante';
            document.getElementById(botonId).classList.add('modo-conexion-activo');
            
            modoConexion = true;
            tuberiaConexionTipo = tipoTuberia;
            puntoOrigenConexion = null;
            
            const diametroSelectId = tipoTuberia === 'principal' ? 'diametroPrincipal' : 
                                     tipoTuberia === 'secundaria' ? 'diametroSecundaria' : 'diametroRegante';
            const diametro = document.getElementById(diametroSelectId).value;
            
            const tipoSelectId = tipoTuberia === 'principal' ? 'tipoPrincipal' : 
                                 tipoTuberia === 'secundaria' ? 'tipoSecundaria' : 'tipoRegante';
            const tipoMaterial = document.getElementById(tipoSelectId).value;
            
            mostrarMensaje(`Modo conexión ${tipoTuberia} (${diametro}"). Haz clic en un punto de tubería para iniciar la conexión.`);
            
            map.off('click');
            map.on('click', function(e) {
                manejarClicConexion(e.latlng, tipoTuberia, diametro, tipoMaterial);
            });
        }
        
        function manejarClicConexion(latlng, tipoTuberia, diametro, tipoMaterial) {
            let puntoCercano = null;
            let distanciaMinima = Infinity;
            
            puntosTuberias.forEach(punto => {
                const distancia = latlng.distanceTo(punto.latlng);
                if (distancia < 10) {
                    if (distancia < distanciaMinima) {
                        distanciaMinima = distancia;
                        puntoCercano = punto;
                    }
                }
            });
            
            if (!puntoCercano) {
                mostrarMensaje('No hay un punto de tubería cerca. Haz clic cerca de un punto existente.');
                return;
            }
            
            if (!puntoOrigenConexion) {
                puntoOrigenConexion = {
                    punto: puntoCercano,
                    latlng: puntoCercano.latlng
                };
                
                resaltarPunto(puntoCercano.latlng);
                mostrarMensaje('Punto origen seleccionado. Ahora haz clic en otro punto para conectar.');
            } else {
                if (puntoCercano.latlng.lat === puntoOrigenConexion.latlng.lat && 
                    puntoCercano.latlng.lng === puntoOrigenConexion.latlng.lng) {
                    mostrarMensaje('No puedes conectar un punto consigo mismo. Selecciona otro punto.');
                    return;
                }
                
                const nuevaTuberia = {
                    tipo: tipoTuberia,
                    puntos: [puntoOrigenConexion.latlng, puntoCercano.latlng],
                    color: getColorTuberia(tipoTuberia),
                    grosor: getGrosorTuberia(tipoTuberia, diametro),
                    diametro: diametro,
                    tipoMaterial: tipoMaterial,
                    id: Date.now(),
                    conexiones: [
                        {
                            tuberiaId: puntoOrigenConexion.punto.tuberiaId,
                            punto: puntoOrigenConexion.punto.esInicio ? 'inicio' : 'fin',
                            latlng: puntoOrigenConexion.latlng
                        },
                        {
                            tuberiaId: puntoCercano.tuberiaId,
                            punto: puntoCercano.esInicio ? 'inicio' : 'fin',
                            latlng: puntoCercano.latlng
                        }
                    ],
                    esConexion: true,
                    esPolilinea: false
                };
                
                const linea = dibujarPolilineaTuberia(nuevaTuberia.puntos, tipoTuberia, diametro);
                nuevaTuberia.linea = linea;
                
                nuevaTuberia.longitud = nuevaTuberia.puntos[0].distanceTo(nuevaTuberia.puntos[1]);
                
                const centro = calcularCentroPolilinea(nuevaTuberia.puntos);
                const etiqueta = L.marker(centro, {
                    icon: L.divIcon({
                        className: 'tuberia-label',
                        html: `<div style="background: white; padding: 2px 5px; border: 1px solid #ccc; border-radius: 3px; font-size: 9px; font-weight: bold;">
                               ${nuevaTuberia.longitud.toFixed(1)}m - ${diametro}"</div>`,
                        iconSize: [80, 20],
                        iconAnchor: [40, 10]
                    })
                }).addTo(map);
                
                nuevaTuberia.etiquetaLongitud = etiqueta;
                
                // Agregar popup con botones de eliminación/edición
                const popupContent = `
                    <div style="text-align: center;">
                        <b>Conexión ${tipoTuberia} (${diametro}")</b><br>
                        Longitud: ${nuevaTuberia.longitud.toFixed(2)} m<br>
                        <button onclick="eliminarTuberia('${nuevaTuberia.id}')" 
                                style="margin-top: 5px; padding: 3px 8px; background-color: #ff6b6b; color: white; border: none; border-radius: 3px; font-size: 0.8rem; cursor: pointer;">
                            <i class="fas fa-trash"></i> Eliminar Conexión
                        </button>
                        <button onclick="editarTuberia('${nuevaTuberia.id}')" 
                                style="margin-top: 5px; margin-left: 5px; padding: 3px 8px; background-color: #4ecdc4; color: white; border: none; border-radius: 3px; font-size: 0.8rem; cursor: pointer;">
                            <i class="fas fa-edit"></i> Editar Diámetro
                        </button>
                    </div>
                `;
                
                linea.bindPopup(popupContent);
                
                tuberias.push(nuevaTuberia);
                
                const tuberiaOrigen = tuberias.find(t => t.id === puntoOrigenConexion.punto.tuberiaId);
                const tuberiaDestino = tuberias.find(t => t.id === puntoCercano.tuberiaId);
                
                if (tuberiaOrigen) {
                    if (!tuberiaOrigen.conexiones) tuberiaOrigen.conexiones = [];
                    tuberiaOrigen.conexiones.push({
                        tuberiaId: nuevaTuberia.id,
                        punto: 'conexion',
                        latlng: puntoOrigenConexion.latlng
                    });
                }
                
                if (tuberiaDestino) {
                    if (!tuberiaDestino.conexiones) tuberiaDestino.conexiones = [];
                    tuberiaDestino.conexiones.push({
                        tuberiaId: nuevaTuberia.id,
                        punto: 'conexion',
                        latlng: puntoCercano.latlng
                    });
                }
                
                actualizarResumenTuberias();
                actualizarResultados();
                
                modoConexion = false;
                tuberiaConexionTipo = null;
                puntoOrigenConexion = null;
                
                const botonId = tipoTuberia === 'principal' ? 'btnConectarPrincipal' : 
                               tipoTuberia === 'secundaria' ? 'btnConectarSecundaria' : 'btnConectarRegante';
                document.getElementById(botonId).classList.remove('modo-conexion-activo');
                
                map.off('click');
                quitarResaltadoPuntos();
                restaurarEventoClickMapa();
                
                mostrarMensaje(`Conexión establecida entre tuberías. Longitud: ${nuevaTuberia.longitud.toFixed(1)} metros`);
            }
        }
        
        function resaltarPunto(latlng) {
            map.eachLayer(layer => {
                if (layer instanceof L.Marker) {
                    const markerLatLng = layer.getLatLng();
                    if (markerLatLng && 
                        Math.abs(markerLatLng.lat - latlng.lat) < 0.00001 && 
                        Math.abs(markerLatLng.lng - latlng.lng) < 0.00001) {
                        const icon = layer.getElement();
                        if (icon) {
                            icon.classList.add('punto-activo');
                        }
                    }
                }
            });
        }
        
        function quitarResaltadoPuntos() {
            map.eachLayer(layer => {
                if (layer instanceof L.Marker) {
                    const icon = layer.getElement();
                    if (icon) {
                        icon.classList.remove('punto-activo');
                    }
                }
            });
        }
        
        // ============================================
        // FUNCIONES DE TUBERÍAS - ELIMINAR Y EDITAR
        // ============================================
        
        function eliminarTuberia(tuberiaId) {
            const tuberiaIndex = tuberias.findIndex(t => t.id === parseInt(tuberiaId));
            if (tuberiaIndex === -1) return;
            
            const tuberia = tuberias[tuberiaIndex];
            
            if (!confirm(`¿Eliminar tubería ${tuberia.tipo} (${tuberia.diametro}")?`)) return;
            
            // Remover elementos del mapa
            if (tuberia.marcadorInicio) map.removeLayer(tuberia.marcadorInicio);
            if (tuberia.marcadorFin) map.removeLayer(tuberia.marcadorFin);
            if (tuberia.marcadoresIntermedios) {
                tuberia.marcadoresIntermedios.forEach(marcador => {
                    map.removeLayer(marcador);
                });
            }
            if (tuberia.linea) {
                map.removeLayer(tuberia.linea);
            }
            if (tuberia.etiquetaLongitud) map.removeLayer(tuberia.etiquetaLongitud);
            
            // Remover puntos asociados
            puntosTuberias = puntosTuberias.filter(p => p.tuberiaId !== tuberia.id);
            
            // Remover de tuberías
            tuberias.splice(tuberiaIndex, 1);
            
            actualizarResumenTuberias();
            actualizarResultados();
            
            mostrarMensaje(`Tubería eliminada`);
        }
        
        function editarTuberia(tuberiaId) {
            const tuberiaIndex = tuberias.findIndex(t => t.id === parseInt(tuberiaId));
            if (tuberiaIndex === -1) return;
            
            const tuberia = tuberias[tuberiaIndex];
            
            // Mostrar diálogos disponibles según tipo
            let opcionesDiámetro = '';
            if (tuberia.tipo === 'principal') {
                const diametros = ['2', '3', '4', '6', '8', '10', '12', '14', '16', '18', '20'];
                diametros.forEach(d => {
                    opcionesDiámetro += `<option value="${d}" ${tuberia.diametro === d ? 'selected' : ''}>${d}"</option>`;
                });
            } else if (tuberia.tipo === 'secundaria') {
                const diametros = ['1', '1.5', '2', '3', '4'];
                diametros.forEach(d => {
                    opcionesDiámetro += `<option value="${d}" ${tuberia.diametro === d ? 'selected' : ''}>${d}"</option>`;
                });
            } else {
                const diametros = ['0.5', '0.75', '1'];
                diametros.forEach(d => {
                    opcionesDiámetro += `<option value="${d}" ${tuberia.diametro === d ? 'selected' : ''}>${d}"</option>`;
                });
            }
            
            // Crear diálogo personalizado
            const dialogHtml = `
                <div id="dialogEditarTuberia" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 20px rgba(0,0,0,0.2); z-index: 10000; min-width: 300px;">
                    <h3 style="margin-top: 0;">Editar tubería ${tuberia.tipo}</h3>
                    <p><strong>Longitud actual:</strong> ${tuberia.longitud.toFixed(2)} m</p>
                    <p><strong>Puntos:</strong> ${tuberia.puntos.length}</p>
                    <p><strong>Diámetro actual:</strong> ${tuberia.diametro}"</p>
                    <div style="margin: 15px 0;">
                        <label for="nuevoDiametro" style="display: block; margin-bottom: 5px;">Nuevo diámetro:</label>
                        <select id="nuevoDiametro" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            ${opcionesDiámetro}
                        </select>
                    </div>
                    <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                        <button onclick="document.getElementById('dialogEditarTuberia').remove(); document.getElementById('overlayEditarTuberia').remove();" 
                                style="padding: 8px 15px; background: #f0f0f0; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;">
                            Cancelar
                        </button>
                        <button onclick="confirmarEdicionTuberia('${tuberiaId}')" 
                                style="padding: 8px 15px; background: #00a553; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            Aplicar
                        </button>
                    </div>
                </div>
            `;
            
            // Remover diálogo anterior si existe
            const dialogAnterior = document.getElementById('dialogEditarTuberia');
            if (dialogAnterior) dialogAnterior.remove();
            
            // Agregar nuevo diálogo
            const dialogDiv = document.createElement('div');
            dialogDiv.innerHTML = dialogHtml;
            document.body.appendChild(dialogDiv);
            
            // Agregar overlay
            const overlay = document.createElement('div');
            overlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999;';
            overlay.id = 'overlayEditarTuberia';
            document.body.appendChild(overlay);
        }
        
        function confirmarEdicionTuberia(tuberiaId) {
            const nuevoDiámetro = document.getElementById('nuevoDiametro').value;
            
            // Remover diálogo y overlay
            document.getElementById('dialogEditarTuberia').remove();
            document.getElementById('overlayEditarTuberia').remove();
            
            const tuberiaIndex = tuberias.findIndex(t => t.id === parseInt(tuberiaId));
            if (tuberiaIndex === -1) return;
            
            const tuberia = tuberias[tuberiaIndex];
            
            // Validar que el diámetro sea válido
            let diametrosValidos = [];
            if (tuberia.tipo === 'principal') {
                diametrosValidos = ['2', '3', '4', '6', '8', '10', '12', '14', '16', '18', '20'];
            } else if (tuberia.tipo === 'secundaria') {
                diametrosValidos = ['1', '1.5', '2', '3', '4'];
            } else {
                diametrosValidos = ['0.5', '0.75', '1'];
            }
            
            if (!diametrosValidos.includes(nuevoDiámetro)) {
                alert(`Diámetro no válido para tubería ${tuberia.tipo}. Debe ser uno de: ${diametrosValidos.join(', ')}"`);
                return;
            }
            
            // Actualizar tubería
            tuberia.diametro = nuevoDiámetro;
            tuberia.grosor = getGrosorTuberia(tuberia.tipo, nuevoDiámetro);
            
            // Actualizar línea en el mapa
            if (tuberia.linea) {
                tuberia.linea.setStyle({
                    weight: tuberia.grosor
                });
            }
            
            // Actualizar etiqueta principal si existe
            if (tuberia.etiquetaLongitud) {
                tuberia.etiquetaLongitud.setIcon(L.divIcon({
                    className: 'tuberia-label',
                    html: `<div style="background: white; padding: 2px 5px; border: 1px solid #ccc; border-radius: 3px; font-size: 9px; font-weight: bold;">
                           ${tuberia.longitud.toFixed(1)}m - ${nuevoDiámetro}"</div>`,
                    iconSize: [80, 20],
                    iconAnchor: [40, 10]
                }));
            }
            
            // Actualizar popup
            if (tuberia.linea) {
                const popupContent = `
                    <div style="text-align: center;">
                        <b>Tubería ${tuberia.tipo} (${nuevoDiámetro}")</b><br>
                        Longitud: ${tuberia.longitud.toFixed(2)} m<br>
                        Puntos: ${tuberia.puntos.length}<br>
                        Material: ${tuberia.tipoMaterial}<br>
                        <button onclick="eliminarTuberia('${tuberia.id}')" 
                                style="margin-top: 5px; padding: 3px 8px; background-color: #ff6b6b; color: white; border: none; border-radius: 3px; font-size: 0.8rem; cursor: pointer;">
                            <i class="fas fa-trash"></i> Eliminar Tubería
                        </button>
                        <button onclick="editarTuberia('${tuberia.id}')" 
                                style="margin-top: 5px; margin-left: 5px; padding: 3px 8px; background-color: #4ecdc4; color: white; border: none; border-radius: 3px; font-size: 0.8rem; cursor: pointer;">
                            <i class="fas fa-edit"></i> Editar Diámetro
                        </button>
                    </div>
                `;
                tuberia.linea.bindPopup(popupContent);
            }
            
            actualizarResumenTuberias();
            actualizarResultados();
            
            mostrarMensaje(`Diámetro actualizado a ${nuevoDiámetro}"`);
        }
        
        function actualizarResumenTuberias() {
            const resumen = {};
            
            tuberias.forEach(t => {
                const key = `${t.tipo}_${t.diametro}`;
                if (!resumen[key]) {
                    resumen[key] = {
                        tipo: t.tipo,
                        diametro: t.diametro,
                        longitudTotal: 0,
                        tipoMaterial: t.tipoMaterial,
                        conexiones: 0,
                        cantidad: 0,
                        esPolilinea: t.esPolilinea || false
                    };
                }
                resumen[key].longitudTotal += t.longitud || 0;
                resumen[key].conexiones += t.conexiones ? t.conexiones.length : 0;
                resumen[key].cantidad += 1;
                if (t.esPolilinea) resumen[key].esPolilinea = true;
            });
            
            let html = '<h4>Resumen de Tuberías por Diámetro</h4>';
            
            const totalesPorTipo = {};
            
            Object.keys(resumen).forEach(key => {
                const item = resumen[key];
                if (!totalesPorTipo[item.tipo]) {
                    totalesPorTipo[item.tipo] = {
                        longitud: 0,
                        cantidad: 0
                    };
                }
                totalesPorTipo[item.tipo].longitud += item.longitudTotal;
                totalesPorTipo[item.tipo].cantidad += item.cantidad;
            });
            
            ['principal', 'secundaria', 'regante'].forEach(tipo => {
                const itemsTipo = Object.values(resumen).filter(item => item.tipo === tipo);
                if (itemsTipo.length > 0) {
                    html += `<div style="margin-bottom: 10px;">`;
                    html += `<strong>${tipo.charAt(0).toUpperCase() + tipo.slice(1)}:</strong>`;
                    
                    itemsTipo.forEach(item => {
                        const tipoLinea = item.esPolilinea ? 'Polilínea' : 'Línea simple';
                        html += `<div class="resumen-item">
                            <span>${item.diametro}" (${item.tipoMaterial} - ${tipoLinea}):</span>
                            <span>${item.longitudTotal.toFixed(2)} m (${item.cantidad})</span>
                        </div>`;
                    });
                    
                    html += `<div class="resumen-item" style="font-weight: bold;">
                        <span>Total ${tipo}:</span>
                        <span>${totalesPorTipo[tipo]?.longitud.toFixed(2) || '0.00'} m (${totalesPorTipo[tipo]?.cantidad || 0})</span>
                    </div>`;
                    html += `</div>`;
                }
            });
            
            const totalGeneral = Object.values(totalesPorTipo).reduce((sum, val) => sum + val.longitud, 0);
            const totalCantidad = Object.values(totalesPorTipo).reduce((sum, val) => sum + val.cantidad, 0);
            
            html += `<div class="resumen-item" style="font-weight: bold; border-top: 1px solid #ddd; padding-top: 8px;">
                <span>Total General:</span>
                <span>${totalGeneral.toFixed(2)} m (${totalCantidad} tuberías)</span>
            </div>`;
            
            document.getElementById('resumenTuberiasDetallado').innerHTML = html;
        }
        
        // ============================================
        // FUNCIONES DE RESULTADOS
        // ============================================
        
        function actualizarResultados() {
            const resultadosDiv = document.getElementById('resultadosCalculos');
            
            if (tuberias.length === 0 && valvulas.length === 0 && cabezales.length === 0) {
                resultadosDiv.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No hay elementos en el diseño. Agrega tuberías y elementos para ver los resultados.</p>';
                return;
            }
            
            let html = '';
            
            html += '<div class="resultado-seccion">';
            html += '<h4 class="resultado-titulo">Información General</h4>';
            html += '<table class="resultado-tabla">';
            html += '<tr><th>Área Total</th><td>' + (areaTotal > 0 ? areaTotal.toFixed(2) + ' m² (' + (areaTotal / 10000).toFixed(2) + ' ha)' : 'No definida') + '</td></tr>';
            html += '<tr><th>Fecha de Diseño</th><td>' + new Date().toLocaleDateString() + '</td></tr>';
            html += '<tr><th>Total Tuberías</th><td>' + tuberias.length + '</td></tr>';
            html += '<tr><th>Total Elementos</th><td>' + elementosGraficos.length + '</td></tr>';
            html += '</table>';
            html += '</div>';
            
            if (tuberias.length > 0) {
                html += '<div class="resultado-seccion">';
                html += '<h4 class="resultado-titulo">Tuberías por Diámetro</h4>';
                html += '<table class="resultado-tabla">';
                html += '<tr><th>Tipo</th><th>Diámetro</th><th>Material</th><th>Longitud (m)</th><th>Cantidad</th><th>Conexiones</th></tr>';
                
                const resumen = {};
                
                tuberias.forEach(t => {
                    const key = `${t.tipo}_${t.diametro}_${t.tipoMaterial}`;
                    if (!resumen[key]) {
                        resumen[key] = {
                            tipo: t.tipo,
                            diametro: t.diametro,
                            tipoMaterial: t.tipoMaterial,
                            longitudTotal: 0,
                            conexiones: 0,
                            cantidad: 0
                        };
                    }
                    resumen[key].longitudTotal += t.longitud || 0;
                    resumen[key].conexiones += t.conexiones ? t.conexiones.length : 0;
                    resumen[key].cantidad += 1;
                });
                
                let totalGeneral = 0;
                Object.values(resumen).forEach(item => {
                    html += `<tr>
                        <td>${item.tipo.charAt(0).toUpperCase() + item.tipo.slice(1)}</td>
                        <td>${item.diametro}"</td>
                        <td>${item.tipoMaterial}</td>
                        <td>${item.longitudTotal.toFixed(2)}</td>
                        <td>${item.cantidad}</td>
                        <td>${item.conexiones}</td>
                    </tr>`;
                    totalGeneral += item.longitudTotal;
                });
                
                html += `<tr style="font-weight: bold; background-color: #f0f0f0;">
                    <td colspan="3">TOTAL GENERAL</td>
                    <td>${totalGeneral.toFixed(2)} m</td>
                    <td>${tuberias.length}</td>
                    <td>${tuberias.reduce((sum, t) => sum + (t.conexiones ? t.conexiones.length : 0), 0)}</td>
                </tr>`;
                
                html += '</table>';
                html += '</div>';
            }
            
            if (valvulas.length > 0) {
                html += '<div class="resultado-seccion">';
                html += '<h4 class="resultado-titulo">Válvulas de Control</h4>';
                html += '<table class="resultado-tabla">';
                html += '<tr><th>Nombre</th><th>Tipo</th><th>Diámetro</th><th>Presión (bar)</th><th>Emisores</th><th>Caudal Emisor (L/h)</th><th>Caudal Total (L/h)</th></tr>';
                
                let caudalTotalSistema = 0;
                valvulas.forEach(valvula => {
                    html += `<tr>
                        <td>${valvula.nombre}</td>
                        <td>${valvula.tipo}</td>
                        <td>${valvula.diametro}</td>
                        <td>${valvula.presion}</td>
                        <td>${valvula.numeroEmisores}</td>
                        <td>${valvula.caudalEmisor}</td>
                        <td>${valvula.caudalTotal}</td>
                    </tr>`;
                    caudalTotalSistema += valvula.caudalTotal;
                });
                
                html += `<tr style="font-weight: bold; background-color: #f0f0f0;">
                    <td colspan="6">CAUDAL TOTAL DEL SISTEMA</td>
                    <td>${caudalTotalSistema.toFixed(2)} L/h (${(caudalTotalSistema / 3600).toFixed(2)} L/s)</td>
                </tr>`;
                
                html += '</table>';
                html += '</div>';
            }
            
            if (cabezales.length > 0) {
                html += '<div class="resultado-seccion">';
                html += '<h4 class="resultado-titulo">Cabezal de Bombeo y Filtración</h4>';
                
                cabezales.forEach(cabezal => {
                    html += '<table class="resultado-tabla" style="margin-bottom: 15px;">';
                    html += `<tr><th colspan="2" style="text-align: center;">CABEZAL PRINCIPAL</th></tr>`;
                    html += `<tr><td>Caudal de Bomba</td><td>${cabezal.caudalBomba} L/s</td></tr>`;
                    html += `<tr><td>Diámetro Succión</td><td>${cabezal.diametroSuccion}</td></tr>`;
                    html += `<tr><td>Diámetro Descarga</td><td>${cabezal.diametroDescarga}</td></tr>`;
                    html += `<tr><td>Número de Filtros</td><td>${cabezal.numeroFiltros}</td></tr>`;
                    html += `<tr><td>Tipo de Filtros</td><td>${cabezal.tipoFiltros}</td></tr>`;
                    if (cabezal.notas) {
                        html += `<tr><td>Notas</td><td>${cabezal.notas}</td></tr>`;
                    }
                    html += '</table>';
                });
                
                html += '</div>';
            }
            
            if (valvulas.length > 0) {
                html += '<div class="resultado-seccion">';
                html += '<h4 class="resultado-titulo">Resumen Hidráulico</h4>';
                html += '<table class="resultado-tabla">';
                html += '<tr><th>Parámetro</th><th>Valor</th><th>Observaciones</th></tr>';
                
                const caudalTotalSistema = valvulas.reduce((sum, v) => sum + v.caudalTotal, 0);
                const caudalLps = caudalTotalSistema / 3600;
                
                html += `<tr>
                    <td>Caudal Total Requerido</td>
                    <td>${caudalTotalSistema.toFixed(2)} L/h (${caudalLps.toFixed(2)} L/s)</td>
                    <td>Suma de todas las válvulas</td>
                </tr>`;
                
                if (cabezales.length > 0) {
                    const cabezalPrincipal = cabezales[0];
                    const caudalCabezal = cabezalPrincipal.caudalBomba * 1000;
                    const diferencia = caudalCabezal - caudalTotalSistema;
                    const porcentaje = (diferencia / caudalCabezal) * 100;
                    
                    html += `<tr>
                        <td>Caudal Disponible (Cabezal)</td>
                        <td>${(cabezalPrincipal.caudalBomba * 1000).toFixed(2)} L/h (${cabezalPrincipal.caudalBomba} L/s)</td>
                        <td>Capacidad del sistema de bombeo</td>
                    </tr>`;
                    
                    html += `<tr>
                        <td>Diferencia</td>
                        <td>${diferencia.toFixed(2)} L/h (${(diferencia / 3600).toFixed(2)} L/s)</td>
                        <td>${diferencia >= 0 ? 'Sobrecapacidad: ' + porcentaje.toFixed(1) + '%' : 'Deficit: ' + Math.abs(porcentaje).toFixed(1) + '%'}</td>
                    </tr>`;
                }
                
                if (areaTotal > 0 && caudalTotalSistema > 0) {
                    const laminaPorHora = caudalTotalSistema / (areaTotal * 1000);
                    const horasPara10mm = 10 / laminaPorHora;
                    
                    html += `<tr>
                        <td>Lámina de Riego por Hora</td>
                        <td>${laminaPorHora.toFixed(3)} mm/h</td>
                        <td></td>
                    </tr>`;
                    html += `<tr>
                        <td>Tiempo para 10 mm de riego</td>
                        <td>${horasPara10mm.toFixed(1)} horas</td>
                        <td>Lámina estándar para muchos cultivos</td>
                    </tr>`;
                }
                
                html += '</table>';
                html += '</div>';
            }
            
            resultadosDiv.innerHTML = html;
        }
        
        // ============================================
        // FUNCIONES DE GESTIÓN DE DISEÑOS - MEJORADAS PARA POLILÍNEAS
        // ============================================
        
        function guardarDiseño(nombre = null) {
            if (!nombre) {
                nombre = prompt('Nombre del diseño:', `Diseño_${new Date().toLocaleDateString()}`);
                if (!nombre) return;
            }
            
            // Obtener polígonos del terreno
            const poligonosTerreno = [];
            drawnItems.eachLayer(function(layer) {
                if (layer instanceof L.Polygon) {
                    const latlngs = layer.getLatLngs()[0];
                    poligonosTerreno.push({
                        latlngs: latlngs.map(latlng => [latlng.lat, latlng.lng]),
                        color: layer.options.color,
                        fillColor: layer.options.fillColor,
                        fillOpacity: layer.options.fillOpacity,
                        weight: layer.options.weight
                    });
                }
            });
            
            // Crear representación vectorial para el diseño
            let imagenDiseñoDataUrl = null;
            try {
                // Crear una captura simplificada para guardar con el diseño
                const tempCanvas = document.createElement('canvas');
                const tempCtx = tempCanvas.getContext('2d');
                tempCanvas.width = 400;
                tempCanvas.height = 300;
                
                // Fondo simple
                tempCtx.fillStyle = 'white';
                tempCtx.fillRect(0, 0, 400, 300);
                
                // Información básica
                tempCtx.fillStyle = '#333';
                tempCtx.font = 'bold 16px Arial';
                tempCtx.textAlign = 'center';
                tempCtx.fillText('DISEÑO DE RIEGO', 200, 30);
                tempCtx.fillText(nombre, 200, 55);
                
                tempCtx.font = '12px Arial';
                tempCtx.textAlign = 'left';
                let infoY = 90;
                
                tempCtx.fillText(`• Área: ${areaTotal > 0 ? areaTotal.toFixed(0) + ' m²' : 'No definida'}`, 40, infoY);
                infoY += 25;
                tempCtx.fillText(`• Tuberías: ${tuberias.length}`, 40, infoY);
                infoY += 25;
                tempCtx.fillText(`• Válvulas: ${valvulas.length}`, 40, infoY);
                infoY += 25;
                
                // Lista de válvulas
                if (valvulas.length > 0) {
                    tempCtx.fillText('Válvulas:', 40, infoY);
                    infoY += 20;
                    tempCtx.font = '10px Arial';
                    
                    valvulas.slice(0, 4).forEach(valvula => {
                        tempCtx.fillText(`${valvula.nombre}: ${valvula.caudalTotal} L/h`, 60, infoY);
                        infoY += 15;
                    });
                    
                    if (valvulas.length > 4) {
                        tempCtx.fillText(`+ ${valvulas.length - 4} más...`, 60, infoY);
                    }
                }
                
                imagenDiseñoDataUrl = tempCanvas.toDataURL('image/jpeg', 0.8);
                
            } catch (error) {
                console.error('Error creando miniatura:', error);
            }
            
            const diseño = {
                id: Date.now(),
                nombre: nombre,
                fecha: new Date().toISOString(),
                area: areaTotal,
                terreno: poligonosTerreno,
                tuberias: tuberias.map(t => ({
                    id: t.id,
                    tipo: t.tipo,
                    puntos: t.puntos.map(p => [p.lat, p.lng]),
                    longitud: t.longitud,
                    color: t.color,
                    grosor: t.grosor,
                    diametro: t.diametro,
                    tipoMaterial: t.tipoMaterial,
                    conexiones: t.conexiones || [],
                    esConexion: t.esConexion || false,
                    esPolilinea: t.esPolilinea || false
                })),
                elementos: elementosGraficos.filter(e => e.type === 'elemento').map(e => ({
                    id: e.id,
                    tipo: e.tipo,
                    posicion: [e.posicion.lat, e.posicion.lng]
                })),
                valvulas: valvulas.map(v => ({
                    id: v.id,
                    nombre: v.nombre,
                    elementoId: v.elementoId,
                    posicion: v.posicion ? [v.posicion.lat, v.posicion.lng] : null,
                    caudalEmisor: v.caudalEmisor,
                    numeroEmisores: v.numeroEmisores,
                    tipo: v.tipo,
                    diametro: v.diametro,
                    presion: v.presion,
                    caudalTotal: v.caudalTotal
                })),
                cabezales: cabezales.map(c => ({
                    id: c.id,
                    elementoId: c.elementoId,
                    posicion: c.posicion ? [c.posicion.lat, c.posicion.lng] : null,
                    caudalBomba: c.caudalBomba,
                    diametroSuccion: c.diametroSuccion,
                    diametroDescarga: c.diametroDescarga,
                    numeroFiltros: c.numeroFiltros,
                    tipoFiltros: c.tipoFiltros,
                    notas: c.notas
                })),
                miniatura: imagenDiseñoDataUrl,
                metadata: {
                    version: '1.1',
                    software: 'Agrosistemas Diseñador CAD',
                    fechaExportacion: new Date().toISOString(),
                    totalElementos: tuberias.length + elementosGraficos.length + valvulas.length + cabezales.length,
                    soportePolilineas: true
                }
            };
            
            diseñosGuardados = JSON.parse(localStorage.getItem('diseñosRiego') || '[]');
            diseñosGuardados.push(diseño);
            localStorage.setItem('diseñosRiego', JSON.stringify(diseñosGuardados));
            
            mostrarMensaje(`Diseño "${nombre}" guardado correctamente`);
            actualizarGaleriaDiseños();
            
            return diseño;
        }
        
        function exportarDiseño() {
            const diseño = guardarDiseño('Exportado_' + Date.now());
            
            const dataStr = JSON.stringify(diseño, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `diseño_riego_${Date.now()}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            mostrarMensaje('Diseño exportado como JSON');
        }
        
        function importarDiseño(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const diseño = JSON.parse(e.target.result);
                    cargarDiseño(diseño);
                    mostrarMensaje(`Diseño "${diseño.nombre}" importado correctamente`);
                } catch (error) {
                    alert('Error al importar el diseño: ' + error.message);
                }
            };
            reader.readAsText(file);
        }
        
        function cargarDiseño(diseño) {
            limpiarDiseño();
            
            // Verificar versión del diseño
            const version = diseño.metadata?.version || '1.0';
            const soportePolilineas = diseño.metadata?.soportePolilineas || false;
            
            // Cargar terreno
            if (diseño.terreno && diseño.terreno.length > 0) {
                diseño.terreno.forEach(poligonoData => {
                    const poligono = L.polygon(poligonoData.latlngs.map(latlng => [latlng[0], latlng[1]]), {
                        color: poligonoData.color || '#008a45',
                        fillColor: poligonoData.fillColor || '#00a553',
                        fillOpacity: poligonoData.fillOpacity || 0.3,
                        weight: poligonoData.weight || 2
                    }).addTo(map);
                    
                    drawnItems.addLayer(poligono);
                    
                    // Calcular área
                    const area = L.GeometryUtil.geodesicArea(poligono.getLatLngs()[0]);
                    areaTotal += area;
                });
                
                if (areaTotal > 0) {
                    document.getElementById('areaDisplay').textContent = 
                        `Área: ${areaTotal.toFixed(2)} m² (${(areaTotal / 10000).toFixed(2)} ha)`;
                    ocultarControlesMapa();
                }
            }
            
            // Cargar tuberías (compatible con versiones antiguas y nuevas)
            if (diseño.tuberias) {
                diseño.tuberias.forEach(tData => {
                    // Manejar diferentes formatos de datos
                    let puntos = [];
                    
                    if (tData.puntos && Array.isArray(tData.puntos)) {
                        // Formato nuevo con array de puntos
                        puntos = tData.puntos.map(p => L.latLng(p[0], p[1]));
                    } else if (tData.puntoInicio && tData.puntoFin) {
                        // Formato antiguo con puntoInicio y puntoFin
                        puntos = [
                            L.latLng(tData.puntoInicio[0], tData.puntoInicio[1]),
                            L.latLng(tData.puntoFin[0], tData.puntoFin[1])
                        ];
                    } else {
                        console.warn('Formato de tubería no reconocido:', tData);
                        return;
                    }
                    
                    if (puntos.length < 2) {
                        console.warn('Tubería con menos de 2 puntos:', tData);
                        return;
                    }
                    
                    // Crear marcadores para cada punto
                    const marcadores = [];
                    puntos.forEach((punto, index) => {
                        const tipo = index === 0 ? 'inicio' : index === puntos.length - 1 ? 'fin' : 'intermedio';
                        const marcador = crearMarcadorTuberia(punto, tipo, tData.tipo, tData.diametro);
                        marcador.addTo(map);
                        marcadores.push(marcador);
                        
                        puntosTuberias.push({
                            tipo: tData.tipo,
                            latlng: punto,
                            tuberiaId: tData.id || Date.now() + Math.random(),
                            esInicio: index === 0
                        });
                    });
                    
                    const linea = dibujarPolilineaTuberia(puntos, tData.tipo, tData.diametro);
                    
                    const centro = calcularCentroPolilinea(puntos);
                    const etiqueta = L.marker(centro, {
                        icon: L.divIcon({
                            className: 'tuberia-label',
                            html: `<div style="background: white; padding: 2px 5px; border: 1px solid #ccc; border-radius: 3px; font-size: 9px; font-weight: bold;">
                                ${(tData.longitud || calcularLongitudPolilineaDesdePuntos(puntos)).toFixed(1)}m - ${tData.diametro}"</div>`,
                            iconSize: [80, 20],
                            iconAnchor: [40, 10]
                        })
                    }).addTo(map);
                    
                    const tuberia = {
                        id: tData.id || Date.now() + Math.random(),
                        tipo: tData.tipo,
                        puntos: puntos,
                        longitud: tData.longitud || calcularLongitudPolilineaDesdePuntos(puntos),
                        color: tData.color || getColorTuberia(tData.tipo),
                        grosor: tData.grosor || getGrosorTuberia(tData.tipo, tData.diametro),
                        diametro: tData.diametro,
                        tipoMaterial: tData.tipoMaterial || 'pvc',
                        conexiones: tData.conexiones || [],
                        esConexion: tData.esConexion || false,
                        esPolilinea: tData.esPolilinea || puntos.length > 2,
                        marcadorInicio: marcadores[0],
                        marcadorFin: marcadores[marcadores.length - 1],
                        marcadoresIntermedios: puntos.length > 2 ? marcadores.slice(1, -1) : [],
                        linea: linea,
                        etiquetaLongitud: etiqueta
                    };
                    
                    tuberias.push(tuberia);
                    
                    // Agregar popup
                    const popupContent = `
                        <div style="text-align: center;">
                            <b>Tubería ${tData.tipo} (${tData.diametro}")</b><br>
                            Longitud: ${tuberia.longitud.toFixed(2)} m<br>
                            Puntos: ${puntos.length}<br>
                            Material: ${tuberia.tipoMaterial}<br>
                            <button onclick="eliminarTuberia('${tuberia.id}')" 
                                    style="margin-top: 5px; padding: 3px 8px; background-color: #ff6b6b; color: white; border: none; border-radius: 3px; font-size: 0.8rem; cursor: pointer;">
                                <i class="fas fa-trash"></i> Eliminar Tubería
                            </button>
                            <button onclick="editarTuberia('${tuberia.id}')" 
                                    style="margin-top: 5px; margin-left: 5px; padding: 3px 8px; background-color: #4ecdc4; color: white; border: none; border-radius: 3px; font-size: 0.8rem; cursor: pointer;">
                                <i class="fas fa-edit"></i> Editar Diámetro
                            </button>
                        </div>
                    `;
                    
                    linea.bindPopup(popupContent);
                });
            }
            
            // Cargar elementos
            if (diseño.elementos) {
                diseño.elementos.forEach(eData => {
                    agregarElementoGrafico(L.latLng(eData.posicion[0], eData.posicion[1]), eData.tipo);
                });
            }
            
            // Cargar válvulas y cabezales
            if (diseño.valvulas) {
                valvulas = diseño.valvulas.map(v => ({
                    ...v,
                    posicion: v.posicion ? L.latLng(v.posicion[0], v.posicion[1]) : null
                }));
            }
            
            if (diseño.cabezales) {
                cabezales = diseño.cabezales.map(c => ({
                    ...c,
                    posicion: c.posicion ? L.latLng(c.posicion[0], c.posicion[1]) : null
                }));
            }
            
            actualizarResumenTuberias();
            actualizarResultados();
        }
        
        function limpiarDiseño() {
            // Deseleccionar elemento si hay uno seleccionado
            deseleccionarElemento();
            
            // Limpiar tuberías
            tuberias.forEach(t => {
                if (t.marcadorInicio) map.removeLayer(t.marcadorInicio);
                if (t.marcadorFin) map.removeLayer(t.marcadorFin);
                if (t.marcadoresIntermedios) {
                    t.marcadoresIntermedios.forEach(marcador => {
                        map.removeLayer(marcador);
                    });
                }
                if (t.linea) {
                    map.removeLayer(t.linea);
                }
                if (t.etiquetaLongitud) map.removeLayer(t.etiquetaLongitud);
            });
            tuberias = [];
            
            // Limpiar puntos
            puntosTuberias = [];
            
            // Limpiar elementos gráficos
            elementosGraficos.forEach(e => map.removeLayer(e.layer));
            elementosGraficos = [];
            
            // Limpiar arrays de válvulas y cabezales
            valvulas = [];
            cabezales = [];
            
            // Limpiar área
            drawnItems.clearLayers();
            areaTotal = 0;
            document.getElementById('areaDisplay').textContent = 'Área: 0 m²';
            
            // Resetear cálculos
            actualizarResumenTuberias();
            actualizarResultados();
            
            // Mostrar controles
            mostrarControlesMapa();
            
            // Resetear modo de dibujo
            modoDibujoTuberia = null;
            tuberiaActual = null;
            puntoInicioTuberia = null;
            modoAgregarElemento = null;
            
            // Resetear modo conexión
            modoConexion = false;
            tuberiaConexionTipo = null;
            puntoOrigenConexion = null;
            
            // Quitar clases activas
            document.querySelectorAll('.tuberia-btn').forEach(btn => {
                btn.classList.remove('activo');
                btn.classList.remove('modo-conexion-activo');
            });
            
            document.querySelectorAll('.elemento-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Ocultar instrucciones
            document.getElementById('instruccionesPrincipal').style.display = 'none';
            document.getElementById('instruccionesSecundaria').style.display = 'none';
            document.getElementById('instruccionesRegante').style.display = 'none';
            document.getElementById('instruccionesElementos').style.display = 'none';
            
            // Quitar resaltado de puntos
            quitarResaltadoPuntos();
            
            // Ocultar panel de información de segmentos
            const panelInfo = document.getElementById('panel-info-segmentos');
            if (panelInfo) {
                panelInfo.style.display = 'none';
            }
        }
        
        function actualizarGaleriaDiseños() {
            const galeriaDiv = document.getElementById('galeriaDiseños');
            diseñosGuardados = JSON.parse(localStorage.getItem('diseñosRiego') || '[]');
            
            if (diseñosGuardados.length === 0) {
                galeriaDiv.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No hay diseños guardados</p>';
                return;
            }
            
            diseñosGuardados.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
            
            let html = '<div class="diseños-lista">';
            
            diseñosGuardados.forEach((diseño, index) => {
                const fecha = new Date(diseño.fecha).toLocaleDateString();
                const hora = new Date(diseño.fecha).toLocaleTimeString();
                const polilineas = diseño.tuberias ? diseño.tuberias.filter(t => t.esPolilinea || t.puntos?.length > 2).length : 0;
                html += `
                    <div class="diseño-item" style="background: #f8f9fa; padding: 15px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #eee;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${diseño.nombre}</strong><br>
                                <small style="color: #666;">${fecha} ${hora} | Área: ${diseño.area ? diseño.area.toFixed(2) + ' m²' : 'No definida'}</small><br>
                                <small style="color: #666;">Tuberías: ${diseño.tuberias ? diseño.tuberias.length : 0} (${polilineas} polilíneas) | Elementos: ${diseño.elementos ? diseño.elementos.length : 0}</small>
                            </div>
                            <div>
                                <button class="mapa-btn" onclick="cargarDiseño(${JSON.stringify(diseño).replace(/"/g, '&quot;')})" 
                                        style="padding: 5px 10px; font-size: 0.8rem; margin-right: 5px;">
                                    <i class="fas fa-edit"></i> Abrir
                                </button>
                                <button class="mapa-btn secondary" onclick="eliminarDiseño(${index})" 
                                        style="padding: 5px 10px; font-size: 0.8rem;">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            galeriaDiv.innerHTML = html;
        }
        
        function eliminarDiseño(index) {
            if (confirm('¿Eliminar este diseño?')) {
                diseñosGuardados.splice(index, 1);
                localStorage.setItem('diseñosRiego', JSON.stringify(diseñosGuardados));
                actualizarGaleriaDiseños();
                mostrarMensaje('Diseño eliminado');
            }
        }
        
        // ============================================
        // FUNCIONES DE CONTROLES DEL MAPA
        // ============================================
        
        function ocultarControlesMapa() {
            const controls = document.getElementById('mapaControls');
            controls.style.display = 'none';
            document.getElementById('showControlsBtn').style.display = 'block';
            document.getElementById('hideControlsBtn').style.display = 'none';
        }
        
        function mostrarControlesMapa() {
            const controls = document.getElementById('mapaControls');
            controls.style.display = 'block';
            document.getElementById('showControlsBtn').style.display = 'none';
            document.getElementById('hideControlsBtn').style.display = 'none';
        }
        
        function buscarUbicacion() {
            const query = document.getElementById('location-search').value;
            if (!query.trim()) return;
            
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    if (data && data.length > 0) {
                        const result = data[0];
                        const lat = parseFloat(result.lat);
                        const lon = parseFloat(result.lon);
                        
                        map.setView([lat, lon], 15);
                        
                        L.marker([lat, lon])
                            .addTo(map)
                            .bindPopup(`<b>${result.display_name}</b>`)
                            .openPopup();
                    } else {
                        alert('Ubicación no encontrada');
                    }
                })
                .catch(error => {
                    console.error('Error en la búsqueda:', error);
                    alert('Error al buscar la ubicación');
                });
        }
        
        // ============================================
        // FUNCIONES DE CAPTURA DE PANTALLA
        // ============================================
        
        async function exportarPDF() {
            try {
                // Verificar librerías
                if (typeof window.jspdf === 'undefined') {
                    alert('Error: jsPDF no está cargado. Recarga la página.');
                    return;
                }
                
                mostrarMensaje('Generando PDF... Esto puede tomar unos segundos.', 3000);
                
                // Crear PDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                
                let currentY = 20;
                
                // Título principal
                doc.setFontSize(20);
                doc.setTextColor(0, 165, 83);
                doc.text('MEMORIA DE CÁLCULO - SISTEMA DE RIEGO', 105, currentY, { align: 'center' });
                
                doc.setFontSize(11);
                doc.setTextColor(0, 0, 0);
                doc.text('Agrosistemas - Diseñador CAD de Riego', 105, currentY + 8, { align: 'center' });
                doc.text('Fecha: ' + new Date().toLocaleDateString('es-MX'), 105, currentY + 15, { align: 'center' });
                
                currentY += 25;
                
                // SECCIÓN 1: INFORMACIÓN GENERAL
                doc.setFontSize(14);
                doc.setTextColor(23, 114, 175);
                doc.text('1. INFORMACIÓN GENERAL DEL PROYECTO', 20, currentY);
                currentY += 8;
                
                doc.setFontSize(11);
                doc.setTextColor(0, 0, 0);
                
                const infoItems = [
                    ['Área Total:', areaTotal > 0 ? `${areaTotal.toFixed(2)} m² (${(areaTotal / 10000).toFixed(3)} ha)` : 'No definida'],
                    ['Fecha de Diseño:', new Date().toLocaleDateString('es-MX')],
                    ['Número de Válvulas:', valvulas.length.toString()],
                    ['Longitud Total Tuberías:', `${tuberias.reduce((sum, t) => sum + (t.longitud || 0), 0).toFixed(2)} m`],
                    ['Número de Elementos:', elementosGraficos.length.toString()]
                ];
                
                infoItems.forEach((item, index) => {
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'bold');
                    doc.text(item[0], 25, currentY);
                    doc.setFont(undefined, 'normal');
                    doc.text(item[1], 70, currentY);
                    currentY += 7;
                });
                
                currentY += 5;
                
                // SECCIÓN 2: TUBERÍAS POR DIÁMETRO
                if (tuberias.length > 0) {
                    if (currentY > 200) {
                        doc.addPage();
                        currentY = 20;
                    }
                    
                    doc.setFontSize(14);
                    doc.setTextColor(23, 114, 175);
                    doc.text('2. RESUMEN DE TUBERÍAS POR DIÁMETRO', 20, currentY);
                    currentY += 10;
                    
                    // Agrupar tuberías
                    const resumenTuberias = {};
                    tuberias.forEach(tuberia => {
                        const key = `${tuberia.tipo}-${tuberia.diametro}-${tuberia.tipoMaterial}`;
                        if (!resumenTuberias[key]) {
                            resumenTuberias[key] = {
                                tipo: tuberia.tipo,
                                diametro: tuberia.diametro,
                                material: tuberia.tipoMaterial,
                                longitudTotal: 0,
                                cantidad: 0,
                                polilineas: 0
                            };
                        }
                        resumenTuberias[key].longitudTotal += tuberia.longitud || 0;
                        resumenTuberias[key].cantidad += 1;
                        if (tuberia.esPolilinea || tuberia.puntos.length > 2) {
                            resumenTuberias[key].polilineas += 1;
                        }
                    });
                    
                    // Crear tabla simplificada
                    const tablaTuberias = Object.values(resumenTuberias).map(item => [
                        item.tipo.charAt(0).toUpperCase() + item.tipo.slice(1),
                        `${item.diametro}"`,
                        item.material,
                        item.cantidad.toString(),
                        `${item.polilineas}`,
                        `${item.longitudTotal.toFixed(2)} m`
                    ]);
                    
                    const totalGeneral = tuberias.reduce((sum, t) => sum + (t.longitud || 0), 0);
                    const totalPolilineas = tuberias.filter(t => t.esPolilinea || t.puntos.length > 2).length;
                    
                    // Dibujar tabla manualmente
                    const startX = 25;
                    const colWidths = [25, 15, 30, 15, 15, 25];
                    
                    // Encabezados
                    doc.setFontSize(9);
                    doc.setFont(undefined, 'bold');
                    doc.text('Tipo', startX, currentY);
                    doc.text('Diám.', startX + colWidths[0], currentY);
                    doc.text('Material', startX + colWidths[0] + colWidths[1], currentY);
                    doc.text('Cant.', startX + colWidths[0] + colWidths[1] + colWidths[2], currentY);
                    doc.text('Polil.', startX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3], currentY);
                    doc.text('Longitud', startX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4], currentY);
                    
                    currentY += 7;
                    
                    // Línea
                    doc.setDrawColor(200, 200, 200);
                    doc.setLineWidth(0.2);
                    doc.line(startX, currentY, startX + 120, currentY);
                    currentY += 5;
                    
                    // Datos
                    doc.setFontSize(8);
                    doc.setFont(undefined, 'normal');
                    
                    tablaTuberias.forEach((fila, index) => {
                        doc.text(fila[0], startX, currentY);
                        doc.text(fila[1], startX + colWidths[0], currentY);
                        doc.text(fila[2], startX + colWidths[0] + colWidths[1], currentY);
                        doc.text(fila[3], startX + colWidths[0] + colWidths[1] + colWidths[2], currentY);
                        doc.text(fila[4], startX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3], currentY);
                        doc.text(fila[5], startX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4], currentY);
                        currentY += 6;
                    });
                    
                    // Línea final
                    doc.setDrawColor(200, 200, 200);
                    doc.setLineWidth(0.2);
                    doc.line(startX, currentY, startX + 120, currentY);
                    currentY += 5;
                    
                    // Total
                    doc.setFontSize(9);
                    doc.setFont(undefined, 'bold');
                    doc.text('TOTAL GENERAL:', startX, currentY);
                    doc.text(`${totalGeneral.toFixed(2)} m (${totalPolilineas} polilíneas)`, startX + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4], currentY);
                    
                    currentY += 10;
                }
                
                // SECCIÓN 3: VÁLVULAS DE CONTROL
                if (valvulas.length > 0) {
                    if (currentY > 200) {
                        doc.addPage();
                        currentY = 20;
                    }
                    
                    doc.setFontSize(14);
                    doc.setTextColor(23, 114, 175);
                    doc.text('3. VÁLVULAS DE CONTROL DEL SISTEMA', 20, currentY);
                    currentY += 10;
                    
                    const caudalTotalSistema = valvulas.reduce((sum, v) => sum + v.caudalTotal, 0);
                    
                    // Tabla simplificada
                    const startX = 25;
                    
                    // Encabezados
                    doc.setFontSize(9);
                    doc.setFont(undefined, 'bold');
                    doc.text('Nombre', startX, currentY);
                    doc.text('Tipo', startX + 25, currentY);
                    doc.text('Diám.', startX + 50, currentY);
                    doc.text('Presión', startX + 70, currentY);
                    doc.text('Emisores', startX + 90, currentY);
                    doc.text('Caudal', startX + 110, currentY);
                    
                    currentY += 6;
                    
                    // Línea
                    doc.setDrawColor(200, 200, 200);
                    doc.setLineWidth(0.2);
                    doc.line(startX, currentY, startX + 140, currentY);
                    currentY += 5;
                    
                    // Datos
                    doc.setFontSize(8);
                    doc.setFont(undefined, 'normal');
                    
                    valvulas.forEach(valvula => {
                        doc.text(valvula.nombre, startX, currentY);
                        doc.text(valvula.tipo.substring(0, 8), startX + 25, currentY);
                        doc.text(valvula.diametro, startX + 50, currentY);
                        doc.text(`${valvula.presion} bar`, startX + 70, currentY);
                        doc.text(valvula.numeroEmisores.toString(), startX + 90, currentY);
                        doc.text(`${valvula.caudalTotal} L/h`, startX + 110, currentY);
                        currentY += 5;
                    });
                    
                    currentY += 3;
                    
                    // Total
                    doc.setFontSize(9);
                    doc.setFont(undefined, 'bold');
                    doc.text('CAUDAL TOTAL DEL SISTEMA:', startX, currentY);
                    doc.text(`${caudalTotalSistema.toFixed(2)} L/h (${(caudalTotalSistema / 3600).toFixed(2)} L/s)`, startX + 80, currentY);
                    
                    currentY += 10;
                }
                
                // SECCIÓN 4: OBSERVACIONES
                if (currentY > 200) {
                    doc.addPage();
                    currentY = 20;
                }
                
                doc.setFontSize(14);
                doc.setTextColor(23, 114, 175);
                doc.text('4. OBSERVACIONES Y APROBACIONES', 20, currentY);
                currentY += 15;
                
                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                doc.text('Observaciones:', 25, currentY);
                currentY += 15;
                
                doc.setLineWidth(0.5);
                doc.line(25, currentY, 185, currentY);
                currentY += 20;
                doc.line(25, currentY, 185, currentY);
                currentY += 10;
                
                // Firmas
                doc.text('________________________________________', 105, currentY, { align: 'center' });
                currentY += 7;
                doc.text('Ing. Diseñador', 105, currentY, { align: 'center' });
                currentY += 20;
                
                doc.text('________________________________________', 105, currentY, { align: 'center' });
                currentY += 7;
                doc.text('Cliente / Responsable', 105, currentY, { align: 'center' });
                currentY += 20;
                
                doc.text('________________________________________', 105, currentY, { align: 'center' });
                currentY += 7;
                doc.text('Fecha de Aprobación', 105, currentY, { align: 'center' });
                
                // Pie de página
                const totalPages = doc.internal.getNumberOfPages();
                for (let i = 1; i <= totalPages; i++) {
                    doc.setPage(i);
                    
                    doc.setFontSize(8);
                    doc.setTextColor(100, 100, 100);
                    doc.text(`Página ${i} de ${totalPages}`, 20, 285);
                    doc.text('Agrosistemas - Diseñador CAD de Riego', 105, 285, { align: 'center' });
                    doc.text('Los Mochis, Sinaloa, México | Tel: 668 123 4567', 105, 290, { align: 'center' });
                }
                
                // Guardar PDF
                const fechaHora = new Date().toISOString().slice(0, 19).replace(/[:T]/g, '-');
                const nombreArchivo = `Memoria_Calculo_Riego_${fechaHora}.pdf`;
                
                // Mostrar mensaje final
                mostrarMensaje(`PDF generado exitosamente: ${nombreArchivo}`, 5000);
                
                // Descargar el PDF
                doc.save(nombreArchivo);
                
            } catch (error) {
                console.error('Error en exportarPDF:', error);
                alert(`Error al generar el PDF: ${error.message}\n\nPor favor, intente nuevamente.`);
            }
        }
        
        async function capturarDiseñoActual() {
            try {
                mostrarMensaje('Preparando captura del diseño...', 2000);
                
                // Deshabilitar botón temporalmente
                const btn = document.querySelector('[onclick="capturarDiseñoActual()"]');
                const originalText = btn ? btn.innerHTML : '';
                if (btn) {
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Capturando...';
                    btn.disabled = true;
                }
                
                // Método mejorado: crear representación vectorial del diseño
                capturaMapaDataUrl = await crearRepresentacionVectorial();
                
                if (!capturaMapaDataUrl) {
                    throw new Error('No se pudo generar la representación del diseño');
                }
                
                capturaTomada = true;
                
                // Actualizar estado
                actualizarEstadoCaptura(true, '¡Diseño preparado para PDF!');
                
                mostrarMensaje('Representación del diseño creada correctamente. Ahora puedes exportar el PDF.', 3000);
                
                return capturaMapaDataUrl;
                
            } catch (error) {
                console.error('Error capturando diseño:', error);
                actualizarEstadoCaptura(false, `Error: ${error.message}`);
                mostrarMensaje(`Error: ${error.message}`, 5000);
                throw error;
            } finally {
                // Restaurar botón
                const btn = document.querySelector('[onclick="capturarDiseñoActual()"]');
                if (btn) {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            }
        }
        
        async function crearRepresentacionVectorial() {
            return new Promise((resolve, reject) => {
                try {
                    // Crear canvas con dimensiones fijas para consistencia
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // Tamaño A4 en píxeles (a 96 DPI)
                    const ancho = 800;
                    const alto = 600;
                    canvas.width = ancho;
                    canvas.height = alto;
                    
                    // Fondo blanco
                    ctx.fillStyle = 'white';
                    ctx.fillRect(0, 0, ancho, alto);
                    
                    // Encabezado
                    ctx.fillStyle = '#333';
                    ctx.font = 'bold 24px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText('DISEÑO DE SISTEMA DE RIEGO', ancho / 2, 40);
                    
                    ctx.font = '16px Arial';
                    ctx.fillText('Agrosistemas - Diseñador CAD', ancho / 2, 70);
                    ctx.fillText('Fecha: ' + new Date().toLocaleDateString('es-MX'), ancho / 2, 90);
                    
                    // Marco para el diseño
                    const marcoX = 50;
                    const marcoY = 120;
                    const marcoAncho = ancho - 100;
                    const marcoAlto = alto - 200;
                    
                    ctx.strokeStyle = '#ccc';
                    ctx.lineWidth = 1;
                    ctx.strokeRect(marcoX, marcoY, marcoAncho, marcoAlto);
                    
                    // Calcular escala para representar el diseño
                    let todosLosPuntos = [];
                    
                    // Recolectar todos los puntos del diseño
                    tuberias.forEach(t => {
                        t.puntos.forEach(p => todosLosPuntos.push(p));
                    });
                    
                    elementosGraficos.forEach(e => {
                        todosLosPuntos.push(e.posicion);
                    });
                    
                    drawnItems.eachLayer(layer => {
                        if (layer instanceof L.Polygon) {
                            const latlngs = layer.getLatLngs()[0];
                            latlngs.forEach(latlng => todosLosPuntos.push(latlng));
                        }
                    });
                    
                    // Calcular límites
                    if (todosLosPuntos.length === 0) {
                        // Si no hay puntos, crear representación mínima
                        crearRepresentacionMinima(ctx, marcoX, marcoY, marcoAncho, marcoAlto);
                        const dataUrl = canvas.toDataURL('image/jpeg', 0.9);
                        resolve(dataUrl);
                        return;
                    }
                    
                    let minLat = Infinity, maxLat = -Infinity;
                    let minLng = Infinity, maxLng = -Infinity;
                    
                    todosLosPuntos.forEach(point => {
                        minLat = Math.min(minLat, point.lat);
                        maxLat = Math.max(maxLat, point.lat);
                        minLng = Math.min(minLng, point.lng);
                        maxLng = Math.max(maxLng, point.lng);
                    });
                    
                    // Añadir margen
                    const latRange = maxLat - minLat;
                    const lngRange = maxLng - minLng;
                    const margin = 0.1; // 10% de margen
                    
                    minLat -= latRange * margin;
                    maxLat += latRange * margin;
                    minLng -= lngRange * margin;
                    maxLng += lngRange * margin;
                    
                    // Función para convertir coordenadas geográficas a coordenadas del canvas
                    const toCanvasCoords = (lat, lng) => {
                        const x = marcoX + ((lng - minLng) / (maxLng - minLng)) * marcoAncho;
                        const y = marcoY + marcoAlto - ((lat - minLat) / (maxLat - minLat)) * marcoAlto;
                        return { x, y };
                    };
                    
                    // Dibujar polígonos del terreno
                    drawnItems.eachLayer(layer => {
                        if (layer instanceof L.Polygon) {
                            const latlngs = layer.getLatLngs()[0];
                            ctx.beginPath();
                            
                            latlngs.forEach((latlng, index) => {
                                const coords = toCanvasCoords(latlng.lat, latlng.lng);
                                if (index === 0) {
                                    ctx.moveTo(coords.x, coords.y);
                                } else {
                                    ctx.lineTo(coords.x, coords.y);
                                }
                            });
                            
                            ctx.closePath();
                            ctx.fillStyle = 'rgba(0, 165, 83, 0.2)';
                            ctx.fill();
                            ctx.strokeStyle = '#008a45';
                            ctx.lineWidth = 2;
                            ctx.stroke();
                        }
                    });
                    
                    // Dibujar tuberías (incluyendo polilíneas)
                    tuberias.forEach(t => {
                        if (t.puntos && t.puntos.length >= 2) {
                            // Dibujar cada segmento de la polilínea
                            for (let i = 0; i < t.puntos.length - 1; i++) {
                                const start = toCanvasCoords(t.puntos[i].lat, t.puntos[i].lng);
                                const end = toCanvasCoords(t.puntos[i + 1].lat, t.puntos[i + 1].lng);
                                
                                ctx.beginPath();
                                ctx.moveTo(start.x, start.y);
                                ctx.lineTo(end.x, end.y);
                                
                                // Configurar estilo según tipo de tubería
                                let color, grosor;
                                if (t.tipo === 'principal') {
                                    color = '#ff6b6b';
                                    grosor = t.grosor || 6;
                                } else if (t.tipo === 'secundaria') {
                                    color = '#4ecdc4';
                                    grosor = t.grosor || 4;
                                } else {
                                    color = '#45b7d1';
                                    grosor = t.grosor || 3;
                                }
                                
                                ctx.strokeStyle = color;
                                ctx.lineWidth = grosor;
                                ctx.lineCap = 'round';
                                ctx.stroke();
                            }
                            
                            // Etiqueta para tuberías largas o polilíneas
                            if (t.puntos.length > 2 || t.longitud > 50) {
                                const centro = calcularCentroPolilinea(t.puntos);
                                const coordsCentro = toCanvasCoords(centro.lat, centro.lng);
                                
                                ctx.fillStyle = 'white';
                                ctx.fillRect(coordsCentro.x - 35, coordsCentro.y - 12, 70, 24);
                                
                                ctx.fillStyle = '#333';
                                ctx.font = 'bold 10px Arial';
                                ctx.textAlign = 'center';
                                
                                let textoEtiqueta = `${t.longitud ? t.longitud.toFixed(1) + 'm' : ''}`;
                                if (t.diametro) {
                                    textoEtiqueta += ` ${t.diametro}"`;
                                }
                                if (t.esPolilinea || t.puntos.length > 2) {
                                    textoEtiqueta += `\n(${t.puntos.length} puntos)`;
                                }
                                
                                const lineas = textoEtiqueta.split('\n');
                                lineas.forEach((linea, index) => {
                                    ctx.fillText(linea, coordsCentro.x, coordsCentro.y + (index * 10) - 3);
                                });
                            }
                        }
                    });
                    
                    // Dibujar elementos
                    elementosGraficos.forEach(e => {
                        const coords = toCanvasCoords(e.posicion.lat, e.posicion.lng);
                        
                        // Color según tipo de elemento
                        let color, icono;
                        switch(e.tipo) {
                            case 'cabezal':
                                color = '#1772af';
                                icono = '⚙️';
                                break;
                            case 'valvula':
                                color = '#ff6b6b';
                                icono = '⚡';
                                break;
                            case 'tomagua':
                                color = '#00a553';
                                icono = '💧';
                                break;
                            case 'filtro':
                                color = '#4ecdc4';
                                icono = '🔍';
                                break;
                            case 'purgaterminal':
                                color = '#ff9f43';
                                icono = '🚰';
                                break;
                            default:
                                color = '#666';
                                icono = '📍';
                        }
                        
                        // Dibujar círculo del elemento
                        ctx.beginPath();
                        ctx.arc(coords.x, coords.y, 12, 0, Math.PI * 2);
                        ctx.fillStyle = color;
                        ctx.fill();
                        ctx.strokeStyle = 'white';
                        ctx.lineWidth = 2;
                        ctx.stroke();
                        
                        // Dibujar icono (texto emoji)
                        ctx.fillStyle = 'white';
                        ctx.font = '14px Arial';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillText(icono, coords.x, coords.y);
                        
                        // Etiqueta del elemento
                        ctx.fillStyle = '#333';
                        ctx.font = 'bold 11px Arial';
                        
                        let textoEtiqueta = e.tipo.toUpperCase();
                        
                        // Si es válvula, mostrar nombre
                        if (e.tipo === 'valvula') {
                            const valvula = valvulas.find(v => v.elementoId === e.id);
                            if (valvula) {
                                textoEtiqueta = `VÁLV ${valvula.nombre}`;
                                
                                // Mostrar información adicional de válvula
                                ctx.font = '9px Arial';
                                ctx.fillText(`${valvula.caudalTotal} L/h`, coords.x, coords.y + 25);
                                ctx.font = 'bold 11px Arial';
                            }
                        }
                        
                        ctx.fillText(textoEtiqueta, coords.x, coords.y + 40);
                    });
                    
                    // Leyenda mejorada
                    dibujarLeyendaMejorada(ctx, ancho, alto, valvulas);
                    
                    // Convertir a data URL
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.9);
                    capturaCanvas = canvas;
                    
                    resolve(dataUrl);
                    
                } catch (error) {
                    console.error('Error en crearRepresentacionVectorial:', error);
                    // Fallback a representación simple
                    const fallbackUrl = crearRepresentacionMinimaFallback();
                    resolve(fallbackUrl);
                }
            });
        }
        
        function dibujarLeyendaMejorada(ctx, ancho, alto, valvulas) {
            const leyendaX = ancho - 220;
            const leyendaY = 120;
            const leyendaAncho = 200;
            
            ctx.fillStyle = 'rgba(255, 255, 255, 0.95)';
            ctx.fillRect(leyendaX, leyendaY, leyendaAncho, 250);
            
            ctx.strokeStyle = '#ccc';
            ctx.lineWidth = 1;
            ctx.strokeRect(leyendaX, leyendaY, leyendaAncho, 250);
            
            ctx.fillStyle = '#333';
            ctx.font = 'bold 14px Arial';
            ctx.textAlign = 'left';
            ctx.fillText('LEYENDA DEL DISEÑO', leyendaX + 10, leyendaY + 25);
            
            let y = leyendaY + 45;
            
            // Tubería principal
            ctx.beginPath();
            ctx.moveTo(leyendaX + 10, y);
            ctx.lineTo(leyendaX + 40, y);
            ctx.strokeStyle = '#ff6b6b';
            ctx.lineWidth = 6;
            ctx.stroke();
            ctx.fillStyle = '#333';
            ctx.font = '11px Arial';
            ctx.fillText('Tubería Principal', leyendaX + 50, y + 4);
            y += 25;
            
            // Tubería secundaria
            ctx.beginPath();
            ctx.moveTo(leyendaX + 10, y);
            ctx.lineTo(leyendaX + 40, y);
            ctx.strokeStyle = '#4ecdc4';
            ctx.lineWidth = 4;
            ctx.stroke();
            ctx.fillText('Tubería Secundaria', leyendaX + 50, y + 4);
            y += 25;
            
            // Tubería regante
            ctx.beginPath();
            ctx.moveTo(leyendaX + 10, y);
            ctx.lineTo(leyendaX + 40, y);
            ctx.strokeStyle = '#45b7d1';
            ctx.lineWidth = 3;
            ctx.stroke();
            ctx.fillText('Tubería Regante', leyendaX + 50, y + 4);
            y += 35;
            
            // Elementos
            const elementos = [
                {color: '#1772af', texto: 'Cabezal', icono: '⚙️'},
                {color: '#ff6b6b', texto: 'Válvula', icono: '⚡'},
                {color: '#00a553', texto: 'Toma de agua', icono: '💧'},
                {color: '#4ecdc4', texto: 'Filtro', icono: '🔍'},
                {color: '#ff9f43', texto: 'Purgas/Terminales', icono: '🚰'}
            ];
            
            elementos.forEach(elem => {
                ctx.beginPath();
                ctx.arc(leyendaX + 15, y, 6, 0, Math.PI * 2);
                ctx.fillStyle = elem.color;
                ctx.fill();
                ctx.strokeStyle = 'white';
                ctx.lineWidth = 1;
                ctx.stroke();
                
                // Icono
                ctx.fillStyle = 'white';
                ctx.font = '10px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(elem.icono, leyendaX + 15, y);
                
                // Texto
                ctx.fillStyle = '#333';
                ctx.textAlign = 'left';
                ctx.font = '10px Arial';
                ctx.fillText(elem.texto, leyendaX + 30, y + 4);
                y += 20;
            });
            
            y += 5;
            
            // Lista de válvulas si existen
            if (valvulas && valvulas.length > 0) {
                ctx.fillStyle = '#1772af';
                ctx.font = 'bold 11px Arial';
                ctx.fillText('VÁLVULAS:', leyendaX + 10, y);
                y += 15;
                
                ctx.fillStyle = '#666';
                ctx.font = '9px Arial';
                
                valvulas.forEach(valvula => {
                    // Mostrar solo las primeras 3 válvulas para no saturar
                    if (y < leyendaY + 220) {
                        ctx.fillText(`• ${valvula.nombre}: ${valvula.caudalTotal} L/h`, leyendaX + 15, y);
                        y += 12;
                    }
                });
                
                if (valvulas.length > 3) {
                    ctx.fillText(`+ ${valvulas.length - 3} más...`, leyendaX + 15, y);
                }
            }
        }
        
        function crearRepresentacionMinima(ctx, marcoX, marcoY, marcoAncho, marcoAlto) {
            ctx.fillStyle = '#f8f9fa';
            ctx.fillRect(marcoX, marcoY, marcoAncho, marcoAlto);
            
            ctx.fillStyle = '#666';
            ctx.font = 'italic 16px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('No hay elementos en el diseño actual', marcoX + marcoAncho / 2, marcoY + marcoAlto / 2);
            
            ctx.fillText('Agrega tuberías y elementos desde el panel de diseño', marcoX + marcoAncho / 2, marcoY + marcoAlto / 2 + 30);
        }
        
        function crearRepresentacionMinimaFallback() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = 800;
            canvas.height = 600;
            
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            ctx.fillStyle = '#333';
            ctx.font = 'bold 20px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('INFORMACIÓN DEL DISEÑO', canvas.width / 2, 50);
            
            ctx.font = '14px Arial';
            let y = 100;
            
            // Información general
            const info = [
                `Área total: ${areaTotal > 0 ? areaTotal.toFixed(2) + ' m²' : 'No definida'}`,
                `Tuberías: ${tuberias.length} (${tuberias.filter(t => t.esPolilinea || t.puntos.length > 2).length} polilíneas)`,
                `Válvulas: ${valvulas.length}`,
                `Elementos: ${elementosGraficos.length}`,
                `Fecha: ${new Date().toLocaleDateString()}`
            ];
            
            info.forEach(texto => {
                ctx.textAlign = 'left';
                ctx.fillText('• ' + texto, 100, y);
                y += 30;
            });
            
            // Lista de válvulas si existen
            if (valvulas.length > 0) {
                y += 20;
                ctx.font = 'bold 16px Arial';
                ctx.fillText('Válvulas del Sistema:', 100, y);
                y += 25;
                
                ctx.font = '12px Arial';
                let columnaY = y;
                valvulas.forEach((valvula, index) => {
                    if (index < 8) { // Mostrar hasta 8 válvulas
                        ctx.fillText(`${valvula.nombre}: ${valvula.caudalTotal} L/h (${valvula.tipo})`, 
                                    100 + (index % 2) * 300, 
                                    columnaY + Math.floor(index / 2) * 20);
                    }
                });
                
                if (valvulas.length > 8) {
                    ctx.fillText(`... y ${valvulas.length - 8} más`, 100, columnaY + 100);
                }
            }
            
            // Nota
            ctx.textAlign = 'center';
            ctx.font = 'italic 12px Arial';
            ctx.fillStyle = '#666';
            ctx.fillText('Para ver el diseño completo interactivo, accede a la aplicación web.', canvas.width / 2, 550);
            ctx.fillText('Esta imagen contiene la información esencial del diseño.', canvas.width / 2, 570);
            
            // Convertir a data URL
            const dataUrl = canvas.toDataURL('image/jpeg', 0.9);
            capturaCanvas = canvas;
            
            return dataUrl;
        }
        
        function actualizarEstadoCaptura(exito, mensaje) {
            const statusDiv = document.getElementById('capturaStatus');
            if (!statusDiv) return;
            
            if (exito) {
                statusDiv.innerHTML = `
                    <div style="background: #e8f5e9; padding: 10px; border-radius: 5px; border-left: 4px solid #00a553;">
                        <strong><i class="fas fa-check-circle" style="color: #00a553;"></i> ${mensaje}</strong>
                        <br>
                        <small>Ahora puedes exportar el PDF con el diseño.</small>
                    </div>
                `;
            } else {
                statusDiv.innerHTML = `
                    <div style="background: #ffeaea; padding: 10px; border-radius: 5px; border-left: 4px solid #ff6b6b;">
                        <strong><i class="fas fa-exclamation-circle" style="color: #ff6b6b;"></i> ${mensaje}</strong>
                        <br>
                        <button onclick="capturarDiseñoActual()" style="margin-top: 5px; padding: 5px 10px; background: #ff6b6b; color: white; border: none; border-radius: 3px; font-size: 0.8rem;">
                            <i class="fas fa-redo"></i> Intentar nuevamente
                        </button>
                    </div>
                `;
            }
        }
        
        function forzarRecaptura() {
            capturaTomada = false;
            capturaMapaDataUrl = null;
            capturaCanvas = null;
            
            const statusDiv = document.getElementById('capturaStatus');
            if (statusDiv) {
                statusDiv.innerHTML = `
                    <div style="background: #fff3cd; padding: 10px; border-radius: 5px; border-left: 4px solid #ffc107;">
                        <strong><i class="fas fa-sync-alt" style="color: #ffc107;"></i> Listo para nueva captura</strong>
                        <br>
                        <small>Haz clic en "Capturar Diseño Actual" para generar una nueva imagen.</small>
                    </div>
                `;
            }
            
            mostrarMensaje('Listo para nueva captura. Ajusta la vista del mapa si es necesario.', 3000);
        }
        
        // ============================================
        // FUNCIONES DE INTERFAZ
        // ============================================
        
        function mostrarMensaje(mensaje, duracion = 3000) {
            // Eliminar mensaje anterior
            const mensajeAnterior = document.getElementById('mensaje-temporal');
            if (mensajeAnterior) {
                mensajeAnterior.remove();
            }
            
            // Crear mensaje
            const mensajeDiv = document.createElement('div');
            mensajeDiv.id = 'mensaje-temporal';
            mensajeDiv.style.cssText = `
                position: fixed;
                top: 100px;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(0, 0, 0, 0.8);
                color: white;
                padding: 10px 20px;
                border-radius: 5px;
                z-index: 10000;
                font-size: 0.9rem;
                pointer-events: none;
                animation: fadeInOut ${duracion}ms ease-in-out;
            `;
            
            // Añadir animación
            const style = document.createElement('style');
            style.textContent = `
                @keyframes fadeInOut {
                    0% { opacity: 0; transform: translateX(-50%) translateY(-10px); }
                    10% { opacity: 1; transform: translateX(-50%) translateY(0); }
                    90% { opacity: 1; transform: translateX(-50%) translateY(0); }
                    100% { opacity: 0; transform: translateX(-50%) translateY(-10px); }
                }
            `;
            document.head.appendChild(style);
            
            mensajeDiv.textContent = mensaje;
            document.body.appendChild(mensajeDiv);
            
            // Auto-eliminar
            setTimeout(() => {
                if (mensajeDiv.parentNode) {
                    mensajeDiv.remove();
                }
                if (style.parentNode) {
                    style.remove();
                }
            }, duracion);
        }
        
        // ============================================
        // INICIALIZACIÓN
        // ============================================
        
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            
            const mobileMenuBtn = document.getElementById('mobileMenuBtn');
            const mainNav = document.getElementById('mainNav');
            const mainHeader = document.getElementById('mainHeader');
            
            mobileMenuBtn.addEventListener('click', function() {
                mainNav.classList.toggle('active');
                
                const icon = mobileMenuBtn.querySelector('i');
                if (mainNav.classList.contains('active')) {
                    icon.classList.remove('fa-bars');
                    icon.classList.add('fa-times');
                    document.body.style.overflow = 'hidden';
                } else {
                    icon.classList.remove('fa-times');
                    icon.classList.add('fa-bars');
                    document.body.style.overflow = '';
                }
            });
            
            const navLinks = document.querySelectorAll('#mainNav a');
            navLinks.forEach(link => {
                link.addEventListener('click', function() {
                    mainNav.classList.remove('active');
                    mobileMenuBtn.querySelector('i').classList.remove('fa-times');
                    mobileMenuBtn.querySelector('i').classList.add('fa-bars');
                    document.body.style.overflow = '';
                });
            });
            
            window.addEventListener('scroll', function() {
                if (window.scrollY > 50) {
                    mainHeader.classList.add('scrolled');
                } else {
                    mainHeader.classList.remove('scrolled');
                }
            });
            
            // Observador para animaciones
            const observerOptions = {
                threshold: 0.1,
                rootMargin: '0px 0px -50px 0px'
            };
            
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('visible');
                    }
                });
            }, observerOptions);
            
            document.querySelectorAll('.fade-in').forEach(el => {
                observer.observe(el);
            });
            
            // Scroll suave
            document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                anchor.addEventListener('click', function(e) {
                    const href = this.getAttribute('href');
                    if (href !== '#' && !href.includes('.html')) {
                        e.preventDefault();
                        const targetElement = document.querySelector(href);
                        if (targetElement) {
                            window.scrollTo({
                                top: targetElement.offsetTop - 100,
                                behavior: 'smooth'
                            });
                        }
                    }
                });
            });
            
            // Eventos de búsqueda
            document.getElementById('searchBtn').addEventListener('click', buscarUbicacion);
            
            document.getElementById('location-search').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    buscarUbicacion();
                }
            });
            
            // Eventos de controles del mapa
            document.getElementById('drawPolygonBtn').addEventListener('click', function() {
                if (currentDrawMode) {
                    currentDrawMode.disable();
                    currentDrawMode = null;
                }
                
                if (tuberiaActual) {
                    tuberiaActual = null;
                    puntoInicioTuberia = null;
                    
                    document.querySelectorAll('.tuberia-btn').forEach(btn => {
                        btn.classList.remove('activo');
                    });
                    
                    document.getElementById('instruccionesPrincipal').style.display = 'none';
                    document.getElementById('instruccionesSecundaria').style.display = 'none';
                    document.getElementById('instruccionesRegante').style.display = 'none';
                }
                
                if (modoAgregarElemento) {
                    modoAgregarElemento = null;
                    document.getElementById('instruccionesElementos').style.display = 'none';
                    
                    document.querySelectorAll('.elemento-btn').forEach(btn => {
                        btn.classList.remove('active');
                    });
                }
                
                if (modoConexion) {
                    modoConexion = false;
                    tuberiaConexionTipo = null;
                    puntoOrigenConexion = null;
                    
                    document.querySelectorAll('.tuberia-btn').forEach(btn => {
                        btn.classList.remove('modo-conexion-activo');
                    });
                }
                
                currentDrawMode = new L.Draw.Polygon(map, drawControl.options.draw.polygon);
                currentDrawMode.enable();
                
                document.getElementById('hideControlsBtn').style.display = 'block';
                
                this.innerHTML = '<i class="fas fa-hand-pointer"></i> Click para dibujar';
                this.style.backgroundColor = '#ff6b6b';
                
                setTimeout(() => {
                    this.innerHTML = '<i class="fas fa-draw-polygon"></i> Delimitar Terreno';
                    this.style.backgroundColor = '';
                }, 3000);
            });
            
            document.getElementById('measureBtn').addEventListener('click', function() {
                if (currentDrawMode) {
                    currentDrawMode.disable();
                    currentDrawMode = null;
                }
                
                currentDrawMode = new L.Draw.Polyline(map, drawControl.options.draw.polyline);
                currentDrawMode.enable();
                
                this.innerHTML = '<i class="fas fa-hand-pointer"></i> Click para medir';
                this.style.backgroundColor = '#ff6b6b';
                
                setTimeout(() => {
                    this.innerHTML = '<i class="fas fa-ruler"></i> Medir';
                    this.style.backgroundColor = '';
                }, 3000);
            });
            
            document.getElementById('clearBtn').addEventListener('click', function() {
                limpiarDiseño();
            });
            
            document.getElementById('hideControlsBtn').addEventListener('click', function() {
                ocultarControlesMapa();
            });
            
            document.getElementById('showControlsBtn').addEventListener('click', function() {
                mostrarControlesMapa();
            });
            
            // Eventos de pestañas
            document.querySelectorAll('.cad-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    
                    // Remover clase active de todas las pestañas
                    document.querySelectorAll('.cad-tab').forEach(t => {
                        t.classList.remove('active');
                    });
                    
                    // Remover clase active de todos los contenidos
                    document.querySelectorAll('.cad-tab-content').forEach(c => {
                        c.classList.remove('active');
                    });
                    
                    // Agregar clase active a la pestaña clickeada
                    this.classList.add('active');
                    
                    // Mostrar el contenido correspondiente
                    document.getElementById(`${tabId}-tab`).classList.add('active');
                });
            });
            
            // Cargar diseños guardados al iniciar
            actualizarGaleriaDiseños();
            
            // Mostrar mensaje de bienvenida
            setTimeout(() => {
                mostrarMensaje('¡Bienvenido al Diseñador CAD de Riego! Comienza delimitando tu terreno en el mapa.', 5000);
            }, 1000);
            
            // Ajustar tamaño del mapa al cambiar tamaño de ventana
            window.addEventListener('resize', function() {
                setTimeout(function() {
                    map.invalidateSize();
                    
                    // Ajustar controles en móviles
                    if (window.innerWidth <= 768) {
                        const controls = document.getElementById('mapaControls');
                        if (controls) {
                            controls.style.width = 'calc(100% - 40px)';
                            controls.style.left = '20px';
                        }
                    }
                }, 100);
            });
            
            // Inicializar tamaño del mapa
            setTimeout(function() {
                map.invalidateSize();
            }, 500);
        });
    </script>
</body>
</html>